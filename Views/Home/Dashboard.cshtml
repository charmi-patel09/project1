@{
    ViewData["Title"] = "Global Intelligence Dashboard";
}

<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap"
    rel="stylesheet">

<div class="dashboard-shell">
    <div class="dashboard-content">
        <!-- Persistent Header -->
        <header class="main-header">
            <div class="header-brief">
                <div class="status-chip">
                    <span class="pulse-dot"></span>
                    Global Satellite Link Active
                </div>
                <h1>Intelligence Hub</h1>
                <p>Telemetry for <span class="accent-text">@(Context.Session.GetString("AdminUser") ??
                        Context.Session.GetString("StudentUser") ?? "Operator")</span>.</p>
            </div>
            <div class="header-chrono">
                <div class="chrono-date" id="headerDate">--/--/----</div>
                <div class="chrono-time" id="headerTime">00:00:00</div>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Left Column: Primary Insights -->
            <div class="grid-primary">
                <!-- Atmospheric Intelligence Card -->
                <section class="mega-card weather-hub">
                    <div class="card-title">
                        <div class="title-icon sky-glow">
                            <i class="fas fa-satellite"></i>
                        </div>
                        <div class="title-text">
                            <h3>weather</h3>
                            <p>Deep-space meteorological telemetry</p>
                        </div>
                    </div>

                    <div class="hub-controls">
                        <div class="search-field">
                            <i class="fas fa-magnifying-glass"></i>
                            <input type="text" id="cityInput" placeholder="Locate any city or country..."
                                onkeypress="if(event.key === 'Enter') getWeather()">
                        </div>
                        <div class="action-group">
                            <button onclick="getWeather()" class="btn-primary">Analyze</button>
                            <button onclick="getCurrentLocation()" class="btn-icon" title="Local coordinates"><i
                                    class="fas fa-location-crosshairs"></i></button>
                        </div>
                    </div>



                    <div class="hub-display">
                        <div id="weatherResult" class="primary-result">
                            <div class="loading-state">Initialising satellite link...</div>
                        </div>

                        <div class="world-index">
                            <div class="index-header">
                                <label>Live Network Nodes</label>
                                <span id="nodeCount" class="count-badge">Monitoring...</span>
                            </div>
                            <div id="worldWeatherList" class="index-scrollbox">
                                <!-- JS Populated -->
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Column: Operational Tools -->
            <div class="grid-secondary">
                <!-- Fiscal Exchange Card -->
                <section class="tool-card currency-hub">
                    <div class="card-title">
                        <div class="title-icon emerald-glow">
                            <i class="fas fa-vault"></i>
                        </div>
                        <div class="title-text">
                            <h3>currency exchange</h3>
                            <p>Global valuation protocols</p>
                        </div>
                    </div>

                    <div class="tool-body">
                        <div class="form-row">
                            <label>Transaction Volume</label>
                            <input type="number" id="amountInput" value="1.00" step="0.01" class="modern-input">
                        </div>
                        <div class="form-grid">
                            <div class="form-row">
                                <label>Base</label>
                                <select id="fromCurrency" class="modern-select"></select>
                            </div>
                            <div class="swap-indicator"><i class="fas fa-right-left"></i></div>
                            <div class="form-row">
                                <label>Target</label>
                                <select id="toCurrency" class="modern-select"></select>
                            </div>
                        </div>
                        <button onclick="convertCurrency()" class="btn-emerald">Run Fiscal Valuation</button>
                        <div id="currencyResult" class="valuation-output">
                            <span class="muted">Awaiting parameters...</span>
                        </div>

                        <div class="fiscal-directory" style="display: none;">
                            <label>Currency Origin Reference</label>
                            <div id="currencyReferenceList" class="reference-scroll">
                                <!-- JS Populated -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Chronos Sync Card -->
                <section class="tool-card chrono-hub">
                    <div class="card-title">
                        <div class="title-icon indigo-glow">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="title-text">
                            <h3>TimeZone</h3>
                            <p>Universal time coordination</p>
                        </div>
                    </div>

                    <div class="tool-body">
                        <div class="clock-display">
                            <label>System Base Time</label>
                            <div id="localTimeLarge" class="digits-hero">00:00:00</div>
                        </div>
                        <div class="zone-sync">
                            <label>Coordinate Zone</label>
                            <select id="timezoneSelect" class="modern-select" onchange="updateConvertedTime()">
                                <option value="UTC">Universal (UTC)</option>
                                <option value="America/New_York">New York (EDT)</option>
                                <option value="Europe/London">London (BST)</option>
                                <option value="Asia/Tokyo">Tokyo (JST)</option>
                                <option value="Asia/Kolkata" selected>Mumbai (IST)</option>
                                <option value="Australia/Sydney">Sydney (AEST)</option>
                                <option value="Asia/Dubai">Dubai (GST)</option>
                            </select>
                            <div id="convertedTime" class="digits-accent">00:00:00</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="~/css/dashboard.css" />

@section Scripts {
    <script>
        const weatherMap = {
            0: 'Clear skies', 1: 'Mainly clear', 2: 'Partially cloudy', 3: 'Overcast atmospheric density',
            45: 'Fog presence', 48: 'Depositing rime fog', 51: 'Light drizzle', 53: 'Moderate drizzle',
            55: 'Dense drizzle', 61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
            71: 'Slight snowfall', 73: 'Moderate snowfall', 75: 'Heavy snowfall', 77: 'Ice particles detected',
            80: 'Rain showers: Slight', 81: 'Rain showers: Moderate', 82: 'Rain showers: Extreme',
            95: 'Thunderstorm: Active', 96: 'Storm with slight hail', 99: 'Storm with heavy hail'
        };

        const weatherIcons = {
            0: 'fa-sun', 1: 'fa-cloud-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud',
            45: 'fa-smog', 48: 'fa-smog', 51: 'fa-cloud-rain', 53: 'fa-cloud-rain',
            55: 'fa-cloud-showers-heavy', 61: 'fa-cloud-rain', 63: 'fa-cloud-rain',
            65: 'fa-cloud-showers-heavy', 71: 'fa-snowflake', 73: 'fa-snowflake',
            75: 'fa-snowflake', 80: 'fa-cloud-bolt', 81: 'fa-cloud-bolt',
            82: 'fa-cloud-bolt', 95: 'fa-bolt-lightning'
        };

        function getIcon(code) { return weatherIcons[code] || 'fa-cloud'; }

        // --- GLOBAL NETWORK NODES ---
        let allNodes = [];
        const initialNodes = [
            // Gujarat Hubs
            { name: "Ahmedabad", lat: 23.0225, lon: 72.5714, cc: "GJ, IN" },
            { name: "Surat", lat: 21.1702, lon: 72.8311, cc: "GJ, IN" },
            { name: "Vadodara", lat: 22.3072, lon: 73.1812, cc: "GJ, IN" },
            { name: "Rajkot", lat: 22.3039, lon: 70.8022, cc: "GJ, IN" },
            { name: "Gandhinagar", lat: 23.2156, lon: 72.6369, cc: "GJ, IN" },
            { name: "Bhavnagar", lat: 21.7645, lon: 72.1519, cc: "GJ, IN" },
            { name: "Jamnagar", lat: 22.4707, lon: 70.0577, cc: "GJ, IN" },
            { name: "Junagadh", lat: 21.5222, lon: 70.4579, cc: "GJ, IN" },
            { name: "Anand", lat: 22.5645, lon: 72.9289, cc: "GJ, IN" },
            { name: "Navsari", lat: 20.9467, lon: 72.9520, cc: "GJ, IN" },
            // Global Hubs
            { name: "London", lat: 51.5074, lon: -0.1278, cc: "GB" },
            { name: "New York", lat: 40.7128, lon: -74.0060, cc: "US" },
            { name: "Tokyo", lat: 35.6895, lon: 139.6917, cc: "JP" },
            { name: "Dubai", lat: 25.2048, lon: 55.2708, cc: "AE" },
            { name: "Singapore", lat: 1.3521, lon: 103.8198, cc: "SG" },
            { name: "Sydney", lat: -33.8688, lon: 151.2093, cc: "AU" },
            { name: "Paris", lat: 48.8566, lon: 2.3522, cc: "FR" },
            { name: "Berlin", lat: 52.5200, lon: 13.4050, cc: "DE" },
            { name: "Mumbai", lat: 19.0760, lon: 72.8777, cc: "IN" },
            { name: "Delhi", lat: 28.6139, lon: 77.2090, cc: "IN" },
            { name: "Toronto", lat: 43.6532, lon: -79.3832, cc: "CA" },
            { name: "Moscow", lat: 55.7558, lon: 37.6173, cc: "RU" },
            { name: "Shanghai", lat: 31.2304, lon: 121.4737, cc: "CN" }
        ];

        async function initNodeDirectory() {
            const container = document.getElementById('worldWeatherList');
            const nodeCount = document.getElementById('nodeCount');
            container.innerHTML = '<div class="loading-state">Syncing Global Nodes...</div>';

            allNodes = [];
            for (const n of initialNodes) {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${n.lat}&longitude=${n.lon}&current=temperature_2m,weather_code`);
                    const data = await res.json();
                    allNodes.push({ ...n, weather: data.current });
                } catch (e) { }
            }

            renderNodes(allNodes);
        }

        function renderNodes(nodes) {
            const container = document.getElementById('worldWeatherList');
            const nodeCount = document.getElementById('nodeCount');
            container.innerHTML = '';
            nodeCount.innerText = `${nodes.length} Nodes Active`;

            nodes.forEach(item => {
                const el = document.createElement('div');
                el.className = 'node-item slide-in';
                el.onclick = () => fetchWeatherDeep(item.lat, item.lon, `${item.name}, ${item.cc}`);
                el.innerHTML = `
                                <div><h4>${item.name}</h4><span>Region: ${item.cc}</span></div>
                                <div class="node-data">
                                    <i class="fas ${getIcon(item.weather.weather_code)}"></i>
                                    <b>${Math.round(item.weather.temperature_2m)}°C</b>
                                </div>
                            `;
                container.appendChild(el);
            });
        }

        function filterNodes() {
            const q = document.getElementById('directorySearch').value.toLowerCase();
            const filtered = allNodes.filter(n =>
                n.name.toLowerCase().includes(q) ||
                n.cc.toLowerCase().includes(q)
            );
            renderNodes(filtered);
        }

        // --- CORE WEATHER TELEMETRY ---
        async function getCurrentLocation() {
            const display = document.getElementById('weatherResult');
            display.innerHTML = '<div class="loading-state">Triangulating satellite uplink...</div>';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => fetchWeatherDeep(p.coords.latitude, p.coords.longitude, "Local Terminal"),
                    () => { display.innerHTML = '<div class="text-danger">Uplink Interrupted: Geolocation Denied</div>'; }
                );
            }
        }

        async function getWeather(cityOverride) {
            const query = cityOverride || document.getElementById('cityInput').value || 'London';
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=1&language=en&format=json`);
                const data = await res.json();
                if (!data.results) {
                    document.getElementById('weatherResult').innerHTML = '<div class="text-danger">Node Not Found</div>';
                    return;
                }
                const { latitude, longitude, name, country } = data.results[0];
                fetchWeatherDeep(latitude, longitude, `${name}, ${country}`);
            } catch (e) { console.error(e); }
        }

        async function fetchWeatherDeep(lat, lon, label) {
            const display = document.getElementById('weatherResult');
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,surface_pressure,wind_speed_10m,visibility&daily=weather_code,temperature_2m_max,temperature_2m_min,uv_index_max,sunrise,sunset&timezone=auto`;
                const res = await fetch(url);
                const data = await res.json();
                const cur = data.current;
                const daily = data.daily;

                let forecast = '';
                for (let i = 0; i < 7; i++) {
                    const d = new Date(daily.time[i]);
                    forecast += `
                                <div class="forecast-node">
                                    <span>${d.toLocaleDateString(undefined, { weekday: 'short' })}</span>
                                    <i class="fas ${getIcon(daily.weather_code[i])}"></i>
                                    <b>${Math.round(daily.temperature_2m_max[i])}°</b>
                                </div>
                            `;
                }

                display.innerHTML = `
                                    <div class="loc-label slide-in">${label}</div>
                                    <div class="temp-hero slide-in">${Math.round(cur.temperature_2m)}°</div>
                                    <div class="weather-desc slide-in">${weatherMap[cur.weather_code] || 'Optimized Atmosphere'}</div>
                                    <div class="stats-deep slide-in">
                                        <div class="stat-box"><i class="fas fa-droplet"></i> <label>Humidity</label> <b>${cur.relative_humidity_2m}%</b></div>
                                        <div class="stat-box"><i class="fas fa-wind"></i> <label>Wind Velocity</label> <b>${Math.round(cur.wind_speed_10m)} km/h</b></div>
                                        <div class="stat-box"><i class="fas fa-sun"></i> <label>UV Peak</label> <b>${daily.uv_index_max[0]}</b></div>
                                        <div class="stat-box"><i class="fas fa-gauge"></i> <label>Pressure</label> <b>${Math.round(cur.surface_pressure)} hPa</b></div>
                                        <div class="stat-box"><i class="fas fa-eye"></i> <label>Visibility</label> <b>${(cur.visibility / 1000).toFixed(1)} km</b></div>
                                        <div class="stat-box"><i class="fas fa-cloud-sun"></i> <label>Apparent</label> <b>${Math.round(cur.apparent_temperature)}°</b></div>
                                    </div>
                                    <div class="forecast-panel slide-in">
                                        <div class="forecast-grid">${forecast}</div>
                                    </div>
                                `;
            } catch (e) { display.innerHTML = '<div class="text-danger">Satellite Link Failure</div>'; }
        }

        // --- FISCAL TELEMETRY ---
        let baseCurrencyRates = {};

        // Comprehensive Global Location Database
        const globalLocations = [
            // Africa
            { name: 'South Africa', flag: '🇿🇦', currency: 'ZAR', cities: ['Johannesburg', 'Cape Town', 'Durban', 'Pretoria'] },
            { name: 'Nigeria', flag: '🇳🇬', currency: 'NGN', cities: ['Lagos', 'Abuja', 'Kano', 'Ibadan'] },
            { name: 'Egypt', flag: '🇪🇬', currency: 'EGP', cities: ['Cairo', 'Alexandria', 'Giza'] },
            { name: 'Kenya', flag: '🇰🇪', currency: 'KES', cities: ['Nairobi', 'Mombasa', 'Kisumu'] },
            { name: 'Morocco', flag: '🇲🇦', currency: 'MAD', cities: ['Casablanca', 'Rabat', 'Marrakech'] },
            // Asia
            { name: 'China', flag: '🇨🇳', currency: 'CNY', cities: ['Beijing', 'Shanghai', 'Guangzhou', 'Shenzhen', 'Hong Kong'] },
            { name: 'India', flag: '🇮🇳', currency: 'INR', cities: ['Mumbai', 'Delhi', 'Bangalore', 'Hyderabad', 'Chennai', 'Kolkata', 'Pune', 'Ahmedabad'] },
            { name: 'Japan', flag: '🇯🇵', currency: 'JPY', cities: ['Tokyo', 'Osaka', 'Kyoto', 'Yokohama'] },
            { name: 'South Korea', flag: '🇰🇷', currency: 'KRW', cities: ['Seoul', 'Busan', 'Incheon'] },
            { name: 'Indonesia', flag: '🇮🇩', currency: 'IDR', cities: ['Jakarta', 'Surabaya', 'Bandung', 'Bali'] },
            { name: 'Thailand', flag: '🇹🇭', currency: 'THB', cities: ['Bangkok', 'Chiang Mai', 'Phuket'] },
            { name: 'Vietnam', flag: '🇻🇳', currency: 'VND', cities: ['Hanoi', 'Ho Chi Minh City', 'Da Nang'] },
            { name: 'Singapore', flag: '🇸🇬', currency: 'SGD', cities: ['Singapore'] },
            { name: 'Malaysia', flag: '🇲🇾', currency: 'MYR', cities: ['Kuala Lumpur', 'Penang', 'Johor Bahru'] },
            { name: 'Philippines', flag: '🇵🇭', currency: 'PHP', cities: ['Manila', 'Quezon City', 'Davao'] },
            { name: 'Pakistan', flag: '🇵🇰', currency: 'PKR', cities: ['Karachi', 'Lahore', 'Islamabad'] },
            { name: 'Bangladesh', flag: '🇧🇩', currency: 'BDT', cities: ['Dhaka', 'Chittagong'] },
            { name: 'Saudi Arabia', flag: '🇸🇦', currency: 'SAR', cities: ['Riyadh', 'Jeddah', 'Mecca', 'Medina'] },
            { name: 'United Arab Emirates', flag: '🇦🇪', currency: 'AED', cities: ['Dubai', 'Abu Dhabi', 'Sharjah'] },
            { name: 'Turkey', flag: '🇹🇷', currency: 'TRY', cities: ['Istanbul', 'Ankara', 'Izmir'] },
            { name: 'Israel', flag: '🇮🇱', currency: 'ILS', cities: ['Tel Aviv', 'Jerusalem', 'Haifa'] },
            // Europe
            { name: 'United Kingdom', flag: '🇬🇧', currency: 'GBP', cities: ['London', 'Manchester', 'Birmingham', 'Edinburgh', 'Glasgow'] },
            { name: 'Germany', flag: '🇩🇪', currency: 'EUR', cities: ['Berlin', 'Munich', 'Frankfurt', 'Hamburg', 'Cologne'] },
            { name: 'France', flag: '🇫🇷', currency: 'EUR', cities: ['Paris', 'Lyon', 'Marseille', 'Nice'] },
            { name: 'Italy', flag: '🇮🇹', currency: 'EUR', cities: ['Rome', 'Milan', 'Venice', 'Florence'] },
            { name: 'Spain', flag: '🇪🇸', currency: 'EUR', cities: ['Madrid', 'Barcelona', 'Valencia', 'Seville'] },
            { name: 'Netherlands', flag: '🇳🇱', currency: 'EUR', cities: ['Amsterdam', 'Rotterdam', 'The Hague'] },
            { name: 'Switzerland', flag: '🇨🇭', currency: 'CHF', cities: ['Zurich', 'Geneva', 'Basel', 'Bern'] },
            { name: 'Belgium', flag: '🇧🇪', currency: 'EUR', cities: ['Brussels', 'Antwerp', 'Ghent'] },
            { name: 'Austria', flag: '🇦🇹', currency: 'EUR', cities: ['Vienna', 'Salzburg'] },
            { name: 'Sweden', flag: '🇸🇪', currency: 'SEK', cities: ['Stockholm', 'Gothenburg'] },
            { name: 'Norway', flag: '🇳🇴', currency: 'NOK', cities: ['Oslo', 'Bergen'] },
            { name: 'Denmark', flag: '🇩🇰', currency: 'DKK', cities: ['Copenhagen', 'Aarhus'] },
            { name: 'Finland', flag: '🇫🇮', currency: 'EUR', cities: ['Helsinki', 'Tampere'] },
            { name: 'Poland', flag: '🇵🇱', currency: 'PLN', cities: ['Warsaw', 'Krakow'] },
            { name: 'Russia', flag: '🇷🇺', currency: 'RUB', cities: ['Moscow', 'St. Petersburg'] },
            { name: 'Czech Republic', flag: '🇨🇿', currency: 'CZK', cities: ['Prague', 'Brno'] },
            { name: 'Portugal', flag: '🇵🇹', currency: 'EUR', cities: ['Lisbon', 'Porto'] },
            { name: 'Greece', flag: '🇬🇷', currency: 'EUR', cities: ['Athens', 'Thessaloniki'] },
            { name: 'Ireland', flag: '🇮🇪', currency: 'EUR', cities: ['Dublin', 'Cork'] },
            { name: 'Romania', flag: '🇷🇴', currency: 'RON', cities: ['Bucharest', 'Cluj-Napoca'] },
            { name: 'Hungary', flag: '🇭🇺', currency: 'HUF', cities: ['Budapest', 'Debrecen'] },
            // North America
            { name: 'United States', flag: '🇺🇸', currency: 'USD', cities: ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Diego', 'Dallas', 'San Francisco', 'Miami', 'Seattle', 'Boston', 'Las Vegas'] },
            { name: 'Canada', flag: '🇨🇦', currency: 'CAD', cities: ['Toronto', 'Vancouver', 'Montreal', 'Calgary', 'Ottawa'] },
            { name: 'Mexico', flag: '🇲🇽', currency: 'MXN', cities: ['Mexico City', 'Guadalajara', 'Monterrey', 'Cancun'] },
            // South America
            { name: 'Brazil', flag: '🇧🇷', currency: 'BRL', cities: ['São Paulo', 'Rio de Janeiro', 'Brasília'] },
            { name: 'Argentina', flag: '🇦🇷', currency: 'ARS', cities: ['Buenos Aires', 'Córdoba'] },
            { name: 'Chile', flag: '🇨🇱', currency: 'CLP', cities: ['Santiago', 'Valparaíso'] },
            { name: 'Colombia', flag: '🇨🇴', currency: 'COP', cities: ['Bogotá', 'Medellín'] },
            { name: 'Peru', flag: '🇵🇪', currency: 'PEN', cities: ['Lima', 'Cusco'] },
            // Oceania
            { name: 'Australia', flag: '🇦🇺', currency: 'AUD', cities: ['Sydney', 'Melbourne', 'Brisbane', 'Perth'] },
            { name: 'New Zealand', flag: '🇳🇿', currency: 'NZD', cities: ['Auckland', 'Wellington'] },
            // Additional
            { name: 'Ukraine', flag: '🇺🇦', currency: 'UAH', cities: ['Kyiv', 'Kharkiv'] },
            { name: 'Croatia', flag: '🇭🇷', currency: 'EUR', cities: ['Zagreb', 'Split'] },
            { name: 'Qatar', flag: '🇶🇦', currency: 'QAR', cities: ['Doha'] },
            { name: 'Kuwait', flag: '🇰🇼', currency: 'KWD', cities: ['Kuwait City'] },
            { name: 'Oman', flag: '🇴🇲', currency: 'OMR', cities: ['Muscat'] },
            { name: 'Sri Lanka', flag: '🇱🇰', currency: 'LKR', cities: ['Colombo'] },
            { name: 'Nepal', flag: '🇳🇵', currency: 'NPR', cities: ['Kathmandu'] },
        ];

        async function initFiscal() {
            try {
                const rateRes = await fetch('https://open.er-api.com/v6/latest/USD');
                const rateData = await rateRes.json();
                baseCurrencyRates = rateData.rates;

                const f = document.getElementById('fromCurrency');
                const t = document.getElementById('toCurrency');

                // Clear existing options
                f.innerHTML = '';
                t.innerHTML = '';

                // Add countries and cities with flags
                globalLocations.forEach(location => {
                    // Add country option
                    const countryOption = new Option(
                        `${location.flag} ${location.name} (${location.currency})`,
                        location.currency
                    );
                    f.add(countryOption.cloneNode(true));
                    t.add(countryOption.cloneNode(true));

                    // Add city options (mapped to country currency)
                    if (location.cities && location.cities.length > 0) {
                        location.cities.forEach(city => {
                            const cityOption = new Option(
                                `${location.flag} ${city}, ${location.name} (${location.currency})`,
                                location.currency
                            );
                            f.add(cityOption.cloneNode(true));
                            t.add(cityOption.cloneNode(true));
                        });
                    }
                });

                // Set defaults
                f.value = 'USD';
                t.value = 'INR';

            } catch (e) {
                console.error("Fiscal link error", e);
                const display = document.getElementById('currencyResult');
                display.innerHTML = '<span style="color: #ef4444;">Network Error: Unable to fetch exchange rates. Please check your connection.</span>';
            }
        }

        function convertCurrency() {
            const v = document.getElementById('amountInput').value;
            const f = document.getElementById('fromCurrency').value;
            const t = document.getElementById('toCurrency').value;
            const display = document.getElementById('currencyResult');
            if (!baseCurrencyRates[f] || !baseCurrencyRates[t]) return;
            const calc = (v / baseCurrencyRates[f]) * baseCurrencyRates[t];
            
            display.innerHTML = `
                <div class="val-grid">
                    <div class="val-box">
                        <div class="val-label">Base</div>
                        <div class="val-number">
                            ${v} <span class="val-sub">${f}</span>
                        </div>
                    </div>
                    
                    <div class="val-divider">
                        <i class="fas fa-arrow-right"></i>
                    </div>

                    <div class="val-box">
                        <div class="val-label">Target</div>
                        <div class="val-number highlight">
                            ${calc.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} 
                            <span class="val-sub">${t}</span>
                        </div>
                    </div>
                </div>
            `;
        }


        // --- CHRONOS LOCATION DATA ---
        const cityTimezones = {
            // Africa
            'South Africa': 'Africa/Johannesburg', 'Johannesburg': 'Africa/Johannesburg', 'Cape Town': 'Africa/Johannesburg', 'Durban': 'Africa/Johannesburg', 'Pretoria': 'Africa/Johannesburg',
            'Nigeria': 'Africa/Lagos', 'Lagos': 'Africa/Lagos', 'Abuja': 'Africa/Lagos', 'Kano': 'Africa/Lagos', 'Ibadan': 'Africa/Lagos',
            'Egypt': 'Africa/Cairo', 'Cairo': 'Africa/Cairo', 'Alexandria': 'Africa/Cairo', 'Giza': 'Africa/Cairo',
            'Kenya': 'Africa/Nairobi', 'Nairobi': 'Africa/Nairobi', 'Mombasa': 'Africa/Nairobi', 'Kisumu': 'Africa/Nairobi',
            'Morocco': 'Africa/Casablanca', 'Casablanca': 'Africa/Casablanca', 'Rabat': 'Africa/Casablanca', 'Marrakech': 'Africa/Casablanca',

            // Asia
            'China': 'Asia/Shanghai', 'Beijing': 'Asia/Shanghai', 'Shanghai': 'Asia/Shanghai', 'Guangzhou': 'Asia/Shanghai', 'Shenzhen': 'Asia/Shanghai', 'Hong Kong': 'Asia/Hong_Kong',
            'India': 'Asia/Kolkata', 'Mumbai': 'Asia/Kolkata', 'Delhi': 'Asia/Kolkata', 'Bangalore': 'Asia/Kolkata', 'Hyderabad': 'Asia/Kolkata', 'Chennai': 'Asia/Kolkata', 'Kolkata': 'Asia/Kolkata', 'Pune': 'Asia/Kolkata', 'Ahmedabad': 'Asia/Kolkata',
            'Japan': 'Asia/Tokyo', 'Tokyo': 'Asia/Tokyo', 'Osaka': 'Asia/Tokyo', 'Kyoto': 'Asia/Tokyo', 'Yokohama': 'Asia/Tokyo',
            'South Korea': 'Asia/Seoul', 'Seoul': 'Asia/Seoul', 'Busan': 'Asia/Seoul', 'Incheon': 'Asia/Seoul',
            'Indonesia': 'Asia/Jakarta', 'Jakarta': 'Asia/Jakarta', 'Surabaya': 'Asia/Jakarta', 'Bandung': 'Asia/Jakarta', 'Bali': 'Asia/Makassar',
            'Thailand': 'Asia/Bangkok', 'Bangkok': 'Asia/Bangkok', 'Chiang Mai': 'Asia/Bangkok', 'Phuket': 'Asia/Bangkok',
            'Vietnam': 'Asia/Ho_Chi_Minh', 'Hanoi': 'Asia/Ho_Chi_Minh', 'Ho Chi Minh City': 'Asia/Ho_Chi_Minh', 'Da Nang': 'Asia/Ho_Chi_Minh',
            'Singapore': 'Asia/Singapore',
            'Malaysia': 'Asia/Kuala_Lumpur', 'Kuala Lumpur': 'Asia/Kuala_Lumpur', 'Penang': 'Asia/Kuala_Lumpur', 'Johor Bahru': 'Asia/Kuala_Lumpur',
            'Philippines': 'Asia/Manila', 'Manila': 'Asia/Manila', 'Quezon City': 'Asia/Manila', 'Davao': 'Asia/Manila',
            'Pakistan': 'Asia/Karachi', 'Karachi': 'Asia/Karachi', 'Lahore': 'Asia/Karachi', 'Islamabad': 'Asia/Karachi',
            'Bangladesh': 'Asia/Dhaka', 'Dhaka': 'Asia/Dhaka', 'Chittagong': 'Asia/Dhaka',
            'Saudi Arabia': 'Asia/Riyadh', 'Riyadh': 'Asia/Riyadh', 'Jeddah': 'Asia/Riyadh', 'Mecca': 'Asia/Riyadh', 'Medina': 'Asia/Riyadh',
            'United Arab Emirates': 'Asia/Dubai', 'Dubai': 'Asia/Dubai', 'Abu Dhabi': 'Asia/Dubai', 'Sharjah': 'Asia/Dubai',
            'Turkey': 'Europe/Istanbul', 'Istanbul': 'Europe/Istanbul', 'Ankara': 'Europe/Istanbul', 'Izmir': 'Europe/Istanbul',
            'Israel': 'Asia/Jerusalem', 'Tel Aviv': 'Asia/Jerusalem', 'Jerusalem': 'Asia/Jerusalem', 'Haifa': 'Asia/Jerusalem',
            'Iran': 'Asia/Tehran', 'Tehran': 'Asia/Tehran', 'Mashhad': 'Asia/Tehran', 'Isfahan': 'Asia/Tehran',

            // Europe
            'United Kingdom': 'Europe/London', 'London': 'Europe/London', 'Manchester': 'Europe/London', 'Birmingham': 'Europe/London', 'Edinburgh': 'Europe/London', 'Glasgow': 'Europe/London',
            'Germany': 'Europe/Berlin', 'Berlin': 'Europe/Berlin', 'Munich': 'Europe/Berlin', 'Frankfurt': 'Europe/Berlin', 'Hamburg': 'Europe/Berlin', 'Cologne': 'Europe/Berlin',
            'France': 'Europe/Paris', 'Paris': 'Europe/Paris', 'Lyon': 'Europe/Paris', 'Marseille': 'Europe/Paris', 'Nice': 'Europe/Paris',
            'Italy': 'Europe/Rome', 'Rome': 'Europe/Rome', 'Milan': 'Europe/Rome', 'Venice': 'Europe/Rome', 'Florence': 'Europe/Rome',
            'Spain': 'Europe/Madrid', 'Madrid': 'Europe/Madrid', 'Barcelona': 'Europe/Madrid', 'Valencia': 'Europe/Madrid', 'Seville': 'Europe/Madrid',
            'Netherlands': 'Europe/Amsterdam', 'Amsterdam': 'Europe/Amsterdam', 'Rotterdam': 'Europe/Amsterdam', 'The Hague': 'Europe/Amsterdam',
            'Switzerland': 'Europe/Zurich', 'Zurich': 'Europe/Zurich', 'Geneva': 'Europe/Zurich', 'Basel': 'Europe/Zurich', 'Bern': 'Europe/Zurich',
            'Belgium': 'Europe/Brussels', 'Brussels': 'Europe/Brussels', 'Antwerp': 'Europe/Brussels', 'Ghent': 'Europe/Brussels',
            'Austria': 'Europe/Vienna', 'Vienna': 'Europe/Vienna', 'Salzburg': 'Europe/Vienna',
            'Sweden': 'Europe/Stockholm', 'Stockholm': 'Europe/Stockholm', 'Gothenburg': 'Europe/Stockholm',
            'Norway': 'Europe/Oslo', 'Oslo': 'Europe/Oslo', 'Bergen': 'Europe/Oslo',
            'Denmark': 'Europe/Copenhagen', 'Copenhagen': 'Europe/Copenhagen', 'Aarhus': 'Europe/Copenhagen',
            'Finland': 'Europe/Helsinki', 'Helsinki': 'Europe/Helsinki', 'Tampere': 'Europe/Helsinki',
            'Poland': 'Europe/Warsaw', 'Warsaw': 'Europe/Warsaw', 'Krakow': 'Europe/Warsaw',
            'Russia': 'Europe/Moscow', 'Moscow': 'Europe/Moscow', 'St. Petersburg': 'Europe/Moscow', 'Novosibirsk': 'Asia/Novosibirsk',
            'Czech Republic': 'Europe/Prague', 'Prague': 'Europe/Prague', 'Brno': 'Europe/Prague',
            'Portugal': 'Europe/Lisbon', 'Lisbon': 'Europe/Lisbon', 'Porto': 'Europe/Lisbon',
            'Greece': 'Europe/Athens', 'Athens': 'Europe/Athens', 'Thessaloniki': 'Europe/Athens',
            'Ireland': 'Europe/Dublin', 'Dublin': 'Europe/Dublin', 'Cork': 'Europe/Dublin',
            'Romania': 'Europe/Bucharest', 'Bucharest': 'Europe/Bucharest', 'Cluj-Napoca': 'Europe/Bucharest',
            'Hungary': 'Europe/Budapest', 'Budapest': 'Europe/Budapest', 'Debrecen': 'Europe/Budapest',

            // North America
            'United States': 'America/New_York', 'New York': 'America/New_York', 'Los Angeles': 'America/Los_Angeles', 'Chicago': 'America/Chicago', 'Houston': 'America/Chicago', 'Phoenix': 'America/Phoenix', 'Philadelphia': 'America/New_York', 'San Diego': 'America/Los_Angeles', 'Dallas': 'America/Chicago', 'San Francisco': 'America/Los_Angeles', 'Miami': 'America/New_York', 'Seattle': 'America/Los_Angeles', 'Boston': 'America/New_York', 'Las Vegas': 'America/Los_Angeles',
            'Canada': 'America/Toronto', 'Toronto': 'America/Toronto', 'Vancouver': 'America/Vancouver', 'Montreal': 'America/Toronto', 'Calgary': 'America/Edmonton', 'Ottawa': 'America/Toronto',
            'Mexico': 'America/Mexico_City', 'Mexico City': 'America/Mexico_City', 'Guadalajara': 'America/Mexico_City', 'Monterrey': 'America/Monterrey', 'Cancun': 'America/Cancun',

            // South America
            'Brazil': 'America/Sao_Paulo', 'São Paulo': 'America/Sao_Paulo', 'Rio de Janeiro': 'America/Sao_Paulo', 'Brasília': 'America/Sao_Paulo', 'Salvador': 'America/Bahia',
            'Argentina': 'America/Argentina/Buenos_Aires', 'Buenos Aires': 'America/Argentina/Buenos_Aires', 'Córdoba': 'America/Argentina/Cordoba',
            'Chile': 'America/Santiago', 'Santiago': 'America/Santiago', 'Valparaíso': 'America/Santiago',
            'Colombia': 'America/Bogota', 'Bogotá': 'America/Bogota', 'Medellín': 'America/Bogota', 'Cali': 'America/Bogota',
            'Peru': 'America/Lima', 'Lima': 'America/Lima', 'Cusco': 'America/Lima',

            // Oceania
            'Australia': 'Australia/Sydney', 'Sydney': 'Australia/Sydney', 'Melbourne': 'Australia/Melbourne', 'Brisbane': 'Australia/Brisbane', 'Perth': 'Australia/Perth', 'Adelaide': 'Australia/Adelaide',
            'New Zealand': 'Pacific/Auckland', 'Auckland': 'Pacific/Auckland', 'Wellington': 'Pacific/Auckland', 'Christchurch': 'Pacific/Auckland',

            // Additional
            'Ukraine': 'Europe/Kyiv', 'Kyiv': 'Europe/Kyiv', 'Kharkiv': 'Europe/Kyiv',
            'Croatia': 'Europe/Zagreb', 'Zagreb': 'Europe/Zagreb', 'Split': 'Europe/Zagreb',
            'Qatar': 'Asia/Qatar', 'Doha': 'Asia/Qatar',
            'Kuwait': 'Asia/Kuwait', 'Kuwait City': 'Asia/Kuwait',
            'Oman': 'Asia/Muscat', 'Muscat': 'Asia/Muscat',
            'Sri Lanka': 'Asia/Colombo', 'Colombo': 'Asia/Colombo',
            'Nepal': 'Asia/Kathmandu', 'Kathmandu': 'Asia/Kathmandu'
        };

        function initChronosLocations() {
            const select = document.getElementById('timezoneSelect');
            select.innerHTML = '';

            // Default UTC
            select.add(new Option(' Universal (UTC)', 'UTC'));

            if (typeof globalLocations !== 'undefined') {
                globalLocations.forEach(loc => {
                    // Add Country
                    const cTz = cityTimezones[loc.name];
                    if (cTz) {
                        select.add(new Option(`${loc.flag} ${loc.name} (Country)`, cTz));
                    }

                    // Add Cities
                    if (loc.cities && loc.cities.length > 0) {
                        loc.cities.forEach(city => {
                            const tz = cityTimezones[city] || cityTimezones[loc.name]; // Fallback to country TZ
                            if (tz) {
                                select.add(new Option(`${loc.flag} ${city}, ${loc.name}`, tz));
                            }
                        });
                    }
                });
            }
            // Set default to Mumbai per user preference or context
            select.value = 'Asia/Kolkata';
        }

        // --- CHRONOS ENGINE ---

        function runChronos() {
            const now = new Date();
            const dateEl = document.getElementById('headerDate');
            const timeEl = document.getElementById('headerTime');
            const localEl = document.getElementById('localTimeLarge');

            if (dateEl) dateEl.innerText = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (timeEl) timeEl.innerText = now.toLocaleTimeString();
            if (localEl) localEl.innerText = now.toLocaleTimeString(undefined, { hour12: false });
            updateConvertedTime();
        }

        function updateConvertedTime() {
            const tz = document.getElementById('timezoneSelect').value;
            const n = new Date();
            const f = { timeZone: tz, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const el = document.getElementById('convertedTime');
            if (el) el.innerText = new Intl.DateTimeFormat('en-GB', f).format(n);
        }

        // Master Link Protocol
        runChronos();
        setInterval(runChronos, 1000);
        getWeather();
        initNodeDirectory();
        initFiscal();
        initChronosLocations();
    </script>
}
