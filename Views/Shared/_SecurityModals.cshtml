@using Microsoft.AspNetCore.Http
<!-- Security PIN Modals -->
<div id="pinModal" class="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; align-items:center; justify-content:center;">
    <div class="pin-card"
        style="background:var(--bg-card); border:1px solid var(--border-primary); border-radius:24px; padding:40px; width:100%; max-width:400px; box-shadow:var(--shadow-2xl); text-align:center;">
        <div id="verifyPinMode" style="display:none;">
            <i class="fas fa-lock" style="font-size:3rem; color:var(--accent-warning); margin-bottom:20px;"></i>
            <h2 style="color:var(--text-bright); margin-bottom:10px;">Verification Required</h2>
            <p style="color:var(--text-muted); margin-bottom:30px;">Enter your PIN to access this module.</p>

            <div id="pinInputArea">
                <div class="form-row" style="margin-bottom:25px;">
                    <input type="password" id="verifyPinInput" class="modern-input" placeholder="••••••" maxlength="6"
                        style="text-align:center; font-size:2rem; letter-spacing:10px;">
                </div>
                <button id="btnSubmitUnlockPin" class="btn-primary"
                    style="width:100%; padding:15px; border-radius:12px;">Unlock Module</button>
            </div>

            <div id="noPinMessage" style="display:none; margin-bottom:20px;">
                <div
                    style="background:rgba(215, 58, 73, 0.1); border:1px solid var(--accent-danger); border-radius:12px; padding:15px; color:var(--accent-danger);">
                    <i class="fas fa-exclamation-triangle"></i> Security PIN not configured
                </div>
                <p style="color:var(--text-muted); margin-top:15px; font-size:0.85rem;">Please contact an administrator
                    to set up your security PIN.</p>
            </div>

            <button onclick="closePinModal()" class="btn-icon"
                style="margin-top:20px; color:var(--text-muted); background:transparent;">Cancel Access</button>
        </div>
        <div id="pinErrorMessage" style="color:var(--accent-danger); margin-top:15px; font-size:0.9rem;"></div>
    </div>
</div>

<script>
    let pendingWidgetAction = null;
    let isPinVerified = sessionStorage.getItem('isPinVerified') === 'true';

    // point 1: Proper event listener
    document.addEventListener('DOMContentLoaded', () => {
        const unlockBtn = document.getElementById('btnSubmitUnlockPin');
        if (unlockBtn) {
            unlockBtn.addEventListener('click', submitVerifyPin);
        }

        const pinInput = document.getElementById('verifyPinInput');
        if (pinInput) {
            pinInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitVerifyPin();
            });
            // Clear error message when user starts typing
            pinInput.addEventListener('input', () => {
                document.getElementById('pinErrorMessage').innerText = '';
            });
        }

        // Point 5: Require PIN again only after logout or page refresh
        if (performance.getEntriesByType("navigation")[0]?.type === 'reload') {
            sessionStorage.removeItem('isPinVerified');
            isPinVerified = false;
        }
    });

    async function syncSecurityState() {
        if (isPinVerified) return { isVerified: true }; // Optimization: check sessionStorage first

        try {
            const res = await fetch('/Security/CheckPinStatus');
            const data = await res.json();
            if (data.isVerified) {
                isPinVerified = true;
                sessionStorage.setItem('isPinVerified', 'true');
            } else {
                isPinVerified = false;
                sessionStorage.removeItem('isPinVerified');
            }
            return data;
        } catch (e) { return { hasPin: false, isVerified: false }; }
    }

    function closePinModal() {
        document.getElementById('pinModal').style.display = 'none';
        document.getElementById('verifyPinInput').value = '';
        document.getElementById('pinErrorMessage').innerText = '';
        pendingWidgetAction = null;
    }

    async function submitVerifyPin() {
        const pin = document.getElementById('verifyPinInput').value;
        const err = document.getElementById('pinErrorMessage');

        if (!pin) {
            err.innerText = "PIN is required";
            return;
        }

        try {
            const res = await fetch('/Security/VerifyPin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `pin=${encodeURIComponent(pin)}`
            });
            const data = await res.json();

            if (data.success) {
                isPinVerified = true;
                sessionStorage.setItem('isPinVerified', 'true');

                // Execute the pending action BEFORE clearing it in closePinModal
                const actionToExecute = pendingWidgetAction;
                closePinModal();

                if (actionToExecute) {
                    executePendingAction(actionToExecute);
                }
            } else {
                err.innerText = data.message || "Incorrect PIN";
                document.getElementById('verifyPinInput').value = '';
                document.getElementById('verifyPinInput').focus();
            }
        } catch (e) {
            err.innerText = "Connection error";
        }
    }

    async function secureAccess(action) {
        // First check local state
        if (isPinVerified) {
            executePendingAction(action);
            return;
        }

        // Then sync with server to be sure
        const status = await syncSecurityState();
        if (status.isVerified) {
            executePendingAction(action);
            return;
        }

        document.getElementById('pinModal').style.display = 'flex';
        document.getElementById('pinErrorMessage').innerText = '';
        pendingWidgetAction = action;

        const verifyMode = document.getElementById('verifyPinMode');
        const pinInputArea = document.getElementById('pinInputArea');
        const noPinMessage = document.getElementById('noPinMessage');

        verifyMode.style.display = 'block';

        if (status.hasPin) {
            pinInputArea.style.display = 'block';
            noPinMessage.style.display = 'none';
            document.getElementById('verifyPinInput').focus();
        } else {
            pinInputArea.style.display = 'none';
            noPinMessage.style.display = 'block';
        }
    }

    function executePendingAction(action) {
        if (typeof action === 'function') action();
        else if (typeof window[action] === 'function') window[action]();
    }
</script>

<style>
    .pin-card input:focus {
        border-color: var(--accent-primary) !important;
        box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.2) !important;
    }
</style>
