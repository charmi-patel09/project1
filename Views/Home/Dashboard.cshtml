@using Microsoft.AspNetCore.Http
@{
    // Logic:
    // 1. Admin always sees all.
    // 2. Legacy users (WidgetPermissions is null) see all.
    // 3. New users (WidgetPermissions is not null) see only what is in the list.
    var role = ViewBag.Role as string ?? "";
    string? rawPermissions = ViewBag.WidgetPermissions as string;
    
    var allowedParams = (rawPermissions ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries);
    
    bool CanShow(string widgetId) 
    {
        if (role == "Admin") return true; 
        if (rawPermissions == null) return true; // Legacy: No permissions set yet -> Allow All
        return allowedParams.Contains(widgetId);
    }
    
    bool IsAdmin = role == "Admin";
    bool HasPin = ViewBag.HasPin ?? false;
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">

<div class="dashboard-shell">
    <div class="dashboard-content">
        @if (TempData["SuccessMessage"] != null)
        {
            <div id="successNotification" style="margin-bottom: 20px; padding: 15px; background: rgba(16, 185, 129, 0.2); border: 1px solid var(--accent-success); color: var(--accent-success); border-radius: 12px; display: flex; align-items: center; gap: 12px; animation: slideDown 0.4s ease;">
                <i class="fas fa-check-circle"></i>
                <span style="font-weight: 600;">@TempData["SuccessMessage"]</span>
                <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: inherit; cursor: pointer; opacity: 0.6;"><i class="fas fa-times"></i></button>
            </div>
        }
        <!-- Sacrificial input to draw browser autofill away from real search fields -->
        <input type="text" style="position: absolute; top: -1000px; left: -1000px; width: 1px; height: 1px; opacity: 0;" tabindex="-1">
        
        <!-- Persistent Header -->
        <header class="main-header">
            <div class="header-brief">
                <h1>Dashboard</h1>
            </div>
            <div class="header-chrono">
                <div class="chrono-date no-translate" id="headerDate">--/--/----</div>
                <div class="chrono-time no-translate" id="headerTime">00:00:00</div>
            </div>
        </header>

        <div class="dashboard-grid">

            <!-- Global Search Hub -->
            @if (IsAdmin || CanShow("global-search-hub")) {
            <section class="tool-card global-search-hub">
                <div class="card-title">
                    <div class="title-icon cyan-glow"><i class="fas fa-globe-americas"></i></div>
                    <div class="title-text"><h3>Global Search</h3></div>
                </div>
                <div class="hub-controls">
                    <div class="search-field">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearchInput" placeholder="Global Intelligence..." 
                            autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"
                            readonly onfocus="this.removeAttribute('readonly');"
                            onkeypress="if(event.key === 'Enter') searchGlobalIntel()">
                    </div>
                    <div class="action-group"><button onclick="searchGlobalIntel()" class="btn-primary">Search</button></div>
                </div>
                <div id="globalSearchResult" class="hub-display" style="gap: 14px;"></div>
            </section>
            }

            <!-- Weather Card -->
            @if (IsAdmin || CanShow("weather-hub")) {
            <section class="tool-card weather-hub">
                <div class="card-title">
                    <div class="title-icon sky-glow"><i class="fas fa-satellite"></i></div>
                    <div class="title-text"><h3>Weather</h3></div>
                </div>
                <div class="hub-controls">
                    <div class="search-field">
                        <i class="fas fa-magnifying-glass"></i>
                        <input type="text" id="cityInput" placeholder="Locate City..." 
                            autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"
                            readonly onfocus="this.removeAttribute('readonly');"
                            onkeypress="if(event.key === 'Enter') getWeather()">
                    </div>
                    <div class="action-group">
                        <button onclick="getWeather()" class="btn-primary">Search</button>
                        <button onclick="getCurrentLocation()" class="btn-icon" title="Local"><i class="fas fa-location-crosshairs"></i></button>
                    </div>
                </div>
                <div class="hub-display"><div id="weatherResult" class="primary-result"><div style="padding: 20px; text-align: center; opacity: 0.8;"><i class="fas fa-satellite" style="font-size: 1.5rem; margin-bottom: 8px;"></i><p>Locate City</p></div></div></div>
            </section>
            }

            <!-- Fiscal Exchange Card -->
            @if (IsAdmin || CanShow("currency-hub")) {
            <section class="tool-card currency-hub">
                <div class="card-title">
                    <div class="title-icon emerald-glow"><i class="fas fa-vault"></i></div>
                    <div class="title-text"><h3>Currency Exchange</h3></div>
                </div>
                <div class="tool-body">
                    <div class="form-row"><label>Volume</label><input type="number" id="amountInput" value="1.00" step="0.01" class="modern-input" oninput="convertCurrency()"></div>
                    <div class="form-grid">
                        <div class="form-row"><label>Base</label><select id="fromCurrency" class="modern-select" onchange="convertCurrency()"></select></div>
                        <div class="swap-indicator"><i class="fas fa-right-left"></i></div>
                        <div class="form-row"><label>Target</label><select id="toCurrency" class="modern-select" onchange="convertCurrency()"></select></div>
                    </div>
                    <div class="action-row" style="margin-top: 10px;"><button onclick="convertCurrency()" class="btn-emerald" style="width: 100%;"><i class="fas fa-bolt"></i> <span>Refresh</span></button></div>
                    <div class="result-section">
                        <div class="result-status"><label class="result-header">Value</label><div class="live-tag"><span class="pulse-dot"></span><span>LIVE</span></div></div>
                        <div id="currencyResult" class="valuation-output"><div style="padding: 20px; text-align: center; opacity: 0.6; font-size: 0.9rem;"><i class="fas fa-coins"></i> <span>Convert</span></div></div>
                        <div class="update-info no-translate" id="lastExchangeUpdate"><span>Last Sync</span>: --:--:--</div>
                    </div>
                </div>
            </section>
            }

            <!-- Chronos Sync Card -->
            @if (IsAdmin || CanShow("chrono-hub")) {
            <section class="tool-card chrono-hub">
                <div class="card-title">
                    <div class="title-icon indigo-glow"><i class="fas fa-clock"></i></div>
                    <div class="title-text"><h3>Timezone</h3></div>
                </div>
                <div class="tool-body">
                    <div class="clock-display"><label>System Base Time</label><div id="localTimeLarge" class="digits-hero no-translate">00:00:00</div></div>
                    <div class="zone-sync"><label>Chronos Sync</label>
                        <select id="timezoneSelect" class="modern-select" onchange="updateConvertedTime()">
                            <option value="UTC">UTC, Universal</option>
                            <option value="America/New_York">New York, US</option>
                            <option value="Europe/London">London, UK</option>
                            <option value="Asia/Tokyo">Tokyo, JP</option>
                            <option value="Asia/Kolkata" selected>Mumbai, IN</option>
                            <option value="Asia/Dubai">Dubai, UAE</option>
                            <option value="Australia/Sydney">Sydney, AU</option>
                            <option value="Europe/Paris">Paris, FR</option>
                            <option value="Asia/Singapore">Singapore, SG</option>
                        </select>
                        <div id="convertedTime" class="digits-accent no-translate">00:00:00</div>
                    </div>
                </div>
            </section>
            }

            <div class="widget-row-dual">
                @if (IsAdmin || CanShow("news-hub")) {
                <section class="tool-card news-hub">
                    <div class="card-title">
                        <div class="title-icon rose-glow"><i class="fas fa-newspaper"></i></div>
                        <div class="title-text"><h3>Global News</h3></div>
                    </div>
                    <div class="hub-controls">
                        <div class="search-field"><i class="fas fa-magnifying-glass"></i>
                            <input type="text" id="newsInput" placeholder="Search News" 
                                autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"
                                readonly onfocus="this.removeAttribute('readonly');"
                                onkeypress="if(event.key === 'Enter') triggerNewsSearch()">
                        </div>
                        <div class="action-group"><button onclick="triggerNewsSearch()" class="btn-primary">Search</button></div>
                    </div>
                    <div class="news-list" id="newsFeed"><div style="padding: 30px; text-align: center; opacity: 0.6;"><i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Search News</p></div></div>
                </section>
                }

                @if (IsAdmin || CanShow("emergency-hub")) {
                <section class="tool-card emergency-hub">
                    <div class="card-title">
                        <div class="title-icon red-glow">
                            <i class="fas fa-kit-medical"></i>
                        </div>
                        <div class="title-text">
                            <h3>Emergency Contacts</h3>
                        </div>
                    </div>

                    <div class="tool-body">
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <div class="d-flex gap-2">
                                <div class="search-field flex-grow-1" style="position:relative;">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="emergencyInput" name="emergency_search_safe" class="modern-input"
                                        placeholder="Type Country Name..." autocomplete="new-password"
                                        autocorrect="off" autocapitalize="off" spellcheck="false"
                                        readonly onfocus="this.removeAttribute('readonly');"
                                        value=""
                                        oninput="handleEmergencySearch()">
                                    <div id="emergencyDropdown" class="dropdown-suggestions"></div>
                                </div>
                                <button class="btn-primary" onclick="handleEmergencySearch()"
                                    style="padding: 0 32px; border-radius: 12px; font-weight: 700;">
                                    Search
                                </button>
                            </div>
                        </div>

                        <div id="emergencyResult" class="emergency-display">
                            <div class="empty-state">
                                 <div class="skeleton skeleton-list-item"></div>
                                 <div class="skeleton skeleton-list-item"></div>
                            </div>
                        </div>
                    </div>
                </section>
                }
            </div>


            <div class="widget-row-trio">
                <!-- Habit Tracker Card -->
                @if (IsAdmin || CanShow("habit-hub")) {
                <section class="tool-card habit-hub">
                    <div class="card-title">
                        <div class="title-icon green-glow">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="title-text">
                            <h3>Habit Tracker</h3>
                        </div>
                        <div class="title-action">
                             <div id="dailyProgress" style="font-size:0.8rem; opacity:0.8;">0/0</div>
                        </div>
                    </div>

                    <div class="tool-body" id="habitBody">
                        @if (!IsAdmin)
                        {
                            <div class="locked-state" style="padding:40px; text-align:center; background:rgba(0,0,0,0.2); border-radius:16px; border:1px dashed var(--border-dim); height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                                <i class="fas @(HasPin ? "fa-lock" : "fa-user-lock")" style="font-size:2.5rem; color:@(HasPin ? "var(--accent-warning)" : "var(--accent-danger)"); margin-bottom:15px; display:block;"></i>
                                <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">@(HasPin ? "Security Verification Required" : "Security PIN not configured")</p>
                                @if (HasPin)
                                {
                                    <button onclick="secureAccess('initHabits')" class="btn-primary" style="padding:10px 24px; font-size:0.9rem; border-radius:10px; width:auto;">
                                        <i class="fas fa-key"></i> Unlock Module
                                    </button>
                                }
                                else
                                {
                                    <div style="background:rgba(239, 68, 68, 0.1); border:1px solid var(--accent-danger); border-radius:10px; padding:10px 20px; color:var(--accent-danger); font-size:0.85rem;">
                                        <i class="fas fa-exclamation-triangle"></i> Contact Admin to enable access
                                    </div>
                                }
                            </div>
                            <template id="habitBodyTemplate">
                                <div id="habitList" class="habit-list" style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                                    <div class="loading-state">Syncing Habits...</div>
                                </div>

                                <div class="add-habit-section" style="margin-top:20px; border-top:1px solid var(--glass-border); padding-top:16px;">
                                    <div id="addHabitForm" style="display:none; transition:all 0.3s ease;">
                                        <div class="form-row" style="margin-bottom:8px;">
                                            <label style="font-size:0.8rem; margin-bottom:4px; display:block; opacity:0.7;">Habit Name</label>
                                            <input type="text" id="newHabitName" class="modern-input" placeholder="e.g. Morning Jog" style="padding:10px;">
                                        </div>
                                        
                                        <div class="form-row" style="margin-bottom:8px;">
                                            <label style="font-size:0.8rem; margin-bottom:4px; display:block; opacity:0.7;">Description / Goal</label>
                                            <input type="text" id="newHabitGoal" class="modern-input" placeholder="e.g. Run 3 miles" style="padding:10px;">
                                        </div>

                                        <div class="form-row" style="margin-bottom:8px;">
                                            <label style="font-size:0.8rem; margin-bottom:4px; display:block; opacity:0.7;">Start Date</label>
                                            <input type="date" id="newHabitStartDate" class="modern-input" style="padding:10px;">
                                        </div>

                                        <div class="form-row" style="margin-bottom:8px;">
                                            <label style="font-size:0.8rem; margin-bottom:4px; display:block; opacity:0.7;">Frequency</label>
                                            <select id="newHabitType" class="modern-select" onchange="toggleCustomDaysInput()" style="padding:10px;">
                                                <option value="Daily">Daily</option>
                                                <option value="Custom">Custom Days</option>
                                            </select>
                                        </div>

                                        <div id="customDaysInput" style="display:none; margin-bottom:12px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                            <label style="font-size:0.8rem; margin-bottom:8px; display:block; opacity:0.7;">Select Active Days</label>
                                            <div class="days-grid" style="display:flex; gap:8px; flex-wrap:wrap; justify-content: space-between;">
                                                <label class="day-checkbox"><input type="checkbox" value="Monday"> <span>M</span></label>
                                                <label class="day-checkbox"><input type="checkbox" value="Tuesday"> <span>T</span></label>
                                                <label class="day-checkbox"><input type="checkbox" value="Wednesday"> <span>W</span></label>
                                                <label class="day-checkbox"><input type="checkbox" value="Thursday"> <span>T</span></label>
                                                <label class="day-checkbox"><input type="checkbox" value="Friday"> <span>F</span></label>
                                                <label class="day-checkbox"><input type="checkbox" value="Saturday"> <span>S</span></label>
                                                <label class="day-checkbox"><input type="checkbox" value="Sunday"> <span>S</span></label>
                                            </div>
                                        </div>

                                        <div class="action-group" style="margin-top:12px; display: flex; gap: 8px;">
                                            <button onclick="saveNewHabit()" class="btn-primary" style="flex:1; border-radius:8px;">
                                                Create
                                            </button>
                                            <button onclick="toggleAddHabitForm()" class="btn-secondary" style="flex:1; border-radius:8px; background: rgba(255,255,255,0.1);">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>

                                    <div style="display:flex; gap:10px;">
                                        <button id="showAddHabitBtn" onclick="toggleAddHabitForm()" class="btn-secondary"
                                            style="flex:1; border-radius:12px; padding:12px;">
                                            <i class="fas fa-plus" style="margin-right:8px;"></i> Add New Habit
                                        </button>
                                        <button onclick="openHabitVault()" class="btn-secondary" title="View All Saved Habits"
                                            style="width:auto; padding:0 20px; border-radius:12px;">
                                            <i class="fas fa-list"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        }
                        else
                        {
                            <div id="habitList" class="habit-list" style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                                <div class="loading-state">Syncing Habits...</div>
                            </div>

                            <div class="add-habit-section" style="margin-top:20px; border-top:1px solid var(--glass-border); padding-top:16px;">
                                <div id="addHabitForm" style="display:none; transition:all 0.3s ease;">
                                    <div class="form-row" style="margin-bottom:8px;">
                                        <label style="font-size:0.8rem; margin-bottom:4px; display:block; opacity:0.7;">Habit Name</label>
                                        <input type="text" id="newHabitName" class="modern-input" placeholder="e.g. Morning Jog" style="padding:10px;">
                                    </div>
                                    
                                    <div class="form-row" style="margin-bottom:8px;">
                                        <label style="font-size:0.8rem; margin-bottom:4px; display:block; opacity:0.7;">Description / Goal</label>
                                        <input type="text" id="newHabitGoal" class="modern-input" placeholder="e.g. Run 3 miles" style="padding:10px;">
                                    </div>

                                    <div class="form-row" style="margin-bottom:8px;">
                                        <label style="font-size:0.8rem; margin-bottom:4px; display:block; opacity:0.7;">Start Date</label>
                                        <input type="date" id="newHabitStartDate" class="modern-input" style="padding:10px;">
                                    </div>

                                    <div class="form-row" style="margin-bottom:8px;">
                                        <label style="font-size:0.8rem; margin-bottom:4px; display:block; opacity:0.7;">Frequency</label>
                                        <select id="newHabitType" class="modern-select" onchange="toggleCustomDaysInput()" style="padding:10px;">
                                            <option value="Daily">Daily</option>
                                            <option value="Custom">Custom Days</option>
                                        </select>
                                    </div>

                                    <div id="customDaysInput" style="display:none; margin-bottom:12px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                        <label style="font-size:0.8rem; margin-bottom:8px; display:block; opacity:0.7;">Select Active Days</label>
                                        <div class="days-grid" style="display:flex; gap:8px; flex-wrap:wrap; justify-content: space-between;">
                                            <label class="day-checkbox"><input type="checkbox" value="Monday"> <span>M</span></label>
                                            <label class="day-checkbox"><input type="checkbox" value="Tuesday"> <span>T</span></label>
                                            <label class="day-checkbox"><input type="checkbox" value="Wednesday"> <span>W</span></label>
                                            <label class="day-checkbox"><input type="checkbox" value="Thursday"> <span>T</span></label>
                                            <label class="day-checkbox"><input type="checkbox" value="Friday"> <span>F</span></label>
                                            <label class="day-checkbox"><input type="checkbox" value="Saturday"> <span>S</span></label>
                                            <label class="day-checkbox"><input type="checkbox" value="Sunday"> <span>S</span></label>
                                        </div>
                                    </div>

                                    <div class="action-group" style="margin-top:12px; display: flex; gap: 8px;">
                                        <button onclick="saveNewHabit()" class="btn-primary" style="flex:1; border-radius:8px;">
                                            Create
                                        </button>
                                        <button onclick="toggleAddHabitForm()" class="btn-secondary" style="flex:1; border-radius:8px; background: rgba(255,255,255,0.1);">
                                            Cancel
                                        </button>
                                    </div>
                                </div>

                                <div style="display:flex; gap:10px;">
                                    <button id="showAddHabitBtn" onclick="toggleAddHabitForm()" class="btn-secondary"
                                        style="flex:1; border-radius:12px; padding:12px;">
                                        <i class="fas fa-plus" style="margin-right:8px;"></i> Add New Habit
                                    </button>
                                    <button onclick="openHabitVault()" class="btn-secondary" title="View All Saved Habits"
                                        style="width:auto; padding:0 20px; border-radius:12px;">
                                        <i class="fas fa-list"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </section>
                }

                <!-- PDF Converter Hub Card -->
                @if (IsAdmin || CanShow("pdf-hub")) {
                <section class="tool-card pdf-hub">
                    <div class="card-title">
                        <div class="title-icon teal-glow">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="title-text">
                            <h3>PDF Converter</h3>
                        </div>
                    </div>

                    <div class="tool-body" id="pdfBody">
                        @if (!IsAdmin)
                        {
                            <div class="locked-state" style="padding:40px; text-align:center; background:rgba(0,0,0,0.2); border-radius:16px; border:1px dashed var(--border-dim); height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                                <i class="fas @(HasPin ? "fa-lock" : "fa-user-lock")" style="font-size:2.5rem; color:@(HasPin ? "var(--accent-warning)" : "var(--accent-danger)"); margin-bottom:15px; display:block;"></i>
                                <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">@(HasPin ? "Security Verification Required" : "Security PIN not configured")</p>
                                @if (HasPin)
                                {
                                    <button onclick="secureAccess('initPdfHistory')" class="btn-primary" style="padding:10px 24px; font-size:0.9rem; border-radius:10px; width:auto;">
                                        <i class="fas fa-key"></i> Unlock Module
                                    </button>
                                }
                                else
                                {
                                    <div style="background:rgba(239, 68, 68, 0.1); border:1px solid var(--accent-danger); border-radius:10px; padding:10px 20px; color:var(--accent-danger); font-size:0.85rem;">
                                        <i class="fas fa-exclamation-triangle"></i> Contact Admin to enable access
                                    </div>
                                }
                            </div>
                            <template id="pdfBodyTemplate">
                                <!-- File Input -->
                                <div class="form-row" style="margin-bottom: 12px;">
                                    <label>Select Files</label>
                                    <input type="file" id="pdfInputFile" class="modern-input" accept=".jpg,.jpeg,.png,.doc,.docx,.txt" multiple style="padding: 10px;">
                                </div>
                                
                                <!-- Format & Merge -->
                                <div class="form-grid-2" style="display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-bottom: 12px; align-items: center;">
                                    <div class="form-row" style="margin:0;">
                                        <label>Format</label>
                                        <select id="pdfTargetFormat" class="modern-select">
                                            <option value="pdf">PDF Document</option>
                                            <option value="jpg">JPG Image</option>
                                        </select>
                                    </div>
                                    <div class="form-row" style="margin:0; text-align: center;">
                                        <label style="display:block; margin-bottom:4px;">Merge</label>
                                        <div class="custom-checkbox" id="pdfMergeCheck" onclick="this.classList.toggle('checked')" style="width: 24px; height: 24px; margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-dim); border-radius: 6px; cursor: pointer;">
                                            <i class="fas fa-check" style="font-size: 0.8rem;"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- PDF Options (Size/Orientation) -->
                                <div id="pdfOptionsRow" class="form-grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                    <div class="form-row" style="margin:0;">
                                        <label>Page Size</label>
                                        <select id="pdfPageSize" class="modern-select">
                                            <option value="A4">A4 (210x297)</option>
                                            <option value="Letter">Letter (8.5x11)</option>
                                        </select>
                                    </div>
                                    <div class="form-row" style="margin:0;">
                                        <label>Orientation</label>
                                        <select id="pdfOrientation" class="modern-select">
                                            <option value="Portrait">Portrait</option>
                                            <option value="Landscape">Landscape</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Quality -->
                                <div class="form-row" style="margin-bottom: 20px;">
                                    <label>Image Quality</label>
                                    <select id="pdfQuality" class="modern-select">
                                        <option value="Standard">Standard (Web)</option>
                                        <option value="High">High (Print)</option>
                                    </select>
                                </div>

                                <div class="action-row" style="margin-bottom: 16px;">
                                    <button onclick="convertFileToPdf()" class="btn-primary" style="width: 100%; border-radius: 12px; height: 48px; font-weight: 700;">
                                        <i class="fas fa-magic"></i> Convert File
                                    </button>
                                </div>

                                <!-- Result Messaging (Hidden by default, used only for critical errors) -->
                                <div id="pdfResult" class="result-box" style="margin-bottom: 20px; display: none; align-items: center; justify-content: center;">
                                </div>

                                <!-- Converted Files List Section -->
                                <div id="pdfListSection" style="display:none; margin-top: 24px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border-bottom:1px solid var(--border-dim); padding-bottom:8px;">
                                        <h4 style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin:0;">Converted Files</h4>
                                        <button onclick="clearPdfList()" style="background:none; border:none; color:var(--text-muted); font-size:0.8rem; cursor:pointer; padding:4px;" title="Clear List">Clear All</button>
                                    </div>
                                    <div id="pdfFilesListContainer" style="display: flex; flex-direction: column; gap: 8px;">
                                        <!-- Dynamic Content -->
                                    </div>
                                </div>
                            </template>
                        }
                        else
                        {
                            <!-- File Input -->
                            <div class="form-row" style="margin-bottom: 12px;">
                                <label>Select Files</label>
                                <input type="file" id="pdfInputFile" class="modern-input" accept=".jpg,.jpeg,.png,.doc,.docx,.txt" multiple style="padding: 10px;">
                            </div>
                            
                            <!-- Format & Merge -->
                            <div class="form-grid-2" style="display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-bottom: 12px; align-items: center;">
                                <div class="form-row" style="margin:0;">
                                    <label>Format</label>
                                    <select id="pdfTargetFormat" class="modern-select">
                                        <option value="pdf">PDF Document</option>
                                        <option value="jpg">JPG Image</option>
                                    </select>
                                </div>
                                <div class="form-row" style="margin:0; text-align: center;">
                                    <label style="display:block; margin-bottom:4px;">Merge</label>
                                    <div class="custom-checkbox" id="pdfMergeCheck" onclick="this.classList.toggle('checked')" style="width: 24px; height: 24px; margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-dim); border-radius: 6px; cursor: pointer;">
                                        <i class="fas fa-check" style="font-size: 0.8rem;"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- PDF Options (Size/Orientation) -->
                            <div id="pdfOptionsRow" class="form-grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                <div class="form-row" style="margin:0;">
                                    <label>Page Size</label>
                                    <select id="pdfPageSize" class="modern-select">
                                        <option value="A4">A4 (210x297)</option>
                                        <option value="Letter">Letter (8.5x11)</option>
                                    </select>
                                </div>
                                <div class="form-row" style="margin:0;">
                                    <label>Orientation</label>
                                    <select id="pdfOrientation" class="modern-select">
                                        <option value="Portrait">Portrait</option>
                                        <option value="Landscape">Landscape</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Quality -->
                            <div class="form-row" style="margin-bottom: 20px;">
                                <label>Image Quality</label>
                                <select id="pdfQuality" class="modern-select">
                                    <option value="Standard">Standard (Web)</option>
                                    <option value="High">High (Print)</option>
                                </select>
                            </div>

                            <div class="action-row" style="margin-bottom: 16px;">
                                <button onclick="convertFileToPdf()" class="btn-primary" style="width: 100%; border-radius: 12px; height: 48px; font-weight: 700;">
                                    <i class="fas fa-magic"></i> Convert File
                                </button>
                            </div>

                            <!-- Result Messaging (Hidden by default, used only for critical errors) -->
                            <div id="pdfResult" class="result-box" style="margin-bottom: 20px; display: none; align-items: center; justify-content: center;">
                            </div>

                            <!-- Converted Files List Section -->
                            <div id="pdfListSection" style="display:none; margin-top: 24px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border-bottom:1px solid var(--border-dim); padding-bottom:8px;">
                                    <h4 style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin:0;">Converted Files</h4>
                                    <button onclick="clearPdfList()" style="background:none; border:none; color:var(--text-muted); font-size:0.8rem; cursor:pointer; padding:4px;" title="Clear List">Clear All</button>
                                </div>
                                <div id="pdfFilesListContainer" style="display: flex; flex-direction: column; gap: 8px;">
                                    <!-- Dynamic Content -->
                                </div>
                            </div>
                        }
                    </div>
                </section>
                }

                <!-- Notes Hub Card -->
                @if (IsAdmin || CanShow("notes-hub")) {
                <section class="tool-card notes-hub">
                    <div class="card-title">
                        <div class="title-icon purple-glow"><i class="fas fa-sticky-note"></i></div>
                        <div class="title-text"><h3>Notes</h3></div>
                    </div>
                    <div class="tool-body" id="notesBody" style="gap: 16px; display: flex; flex-direction: column;">
                        @if (!IsAdmin)
                        {
                            <div class="locked-state" style="padding:40px; text-align:center; background:rgba(0,0,0,0.2); border-radius:16px; border:1px dashed var(--border-dim); height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                                <i class="fas @(HasPin ? "fa-lock" : "fa-user-lock")" style="font-size:2.5rem; color:@(HasPin ? "var(--accent-warning)" : "var(--accent-danger)"); margin-bottom:15px; display:block;"></i>
                                <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">@(HasPin ? "Security Verification Required" : "Security PIN not configured")</p>
                                @if (HasPin)
                                {
                                    <button onclick="secureAccess('initNotes')" class="btn-primary" style="padding:10px 24px; font-size:0.9rem; border-radius:10px; width:auto;">
                                        <i class="fas fa-key"></i> Unlock Module
                                    </button>
                                }
                                else
                                {
                                    <div style="background:rgba(239, 68, 68, 0.1); border:1px solid var(--accent-danger); border-radius:10px; padding:10px 20px; color:var(--accent-danger); font-size:0.85rem;">
                                        <i class="fas fa-exclamation-triangle"></i> Contact Admin to enable access
                                    </div>
                                }
                            </div>
                            <template id="notesBodyTemplate">
                                <div class="hub-controls"><button id="btnNewNote" onclick="toggleNoteForm()" class="btn-primary" style="width:100%"><i class="fas fa-plus"></i> <span>New Note</span></button></div>
                                <div id="noteFormArea" style="display:none; margin-bottom: 20px; background: rgba(255,255,255,0.02); padding: 16px; border-radius: 16px; border: 1px solid var(--border-dim);" class="slide-in">
                                    <div style="margin-bottom: 12px; font-weight: 700; color: var(--accent-purple);" id="formTitle">New Note</div>
                                    <input type="hidden" id="noteId">
                                    <div class="form-row" style="margin-bottom:12px;"><input type="text" id="noteTitle" class="modern-input" placeholder="Title"></div>
                                    <div class="form-row" style="margin-bottom:12px;"><textarea id="noteDesc" class="modern-input" rows="3" placeholder="Details"></textarea></div>
                                    <div class="action-group" style="width: 100%; display: flex; gap: 10px;">
                                        <button onclick="saveNote()" class="btn-primary" style="flex: 1;">Save</button>
                                        <button onclick="toggleNoteForm()" class="btn-icon" style="flex: 1; border: 1px solid var(--border-dim); background: transparent; color: var(--text-muted);">Cancel</button>
                                    </div>
                                </div>
                                <div class="notes-list" id="notesList"><div class="loading-state">Syncing...</div></div>
                            </template>
                        }
                        else
                        {
                            <div class="hub-controls"><button id="btnNewNote" onclick="toggleNoteForm()" class="btn-primary" style="width:100%"><i class="fas fa-plus"></i> <span>New Note</span></button></div>
                            <div id="noteFormArea" style="display:none; margin-bottom: 20px; background: rgba(255,255,255,0.02); padding: 16px; border-radius: 16px; border: 1px solid var(--border-dim);" class="slide-in">
                                <div style="margin-bottom: 12px; font-weight: 700; color: var(--accent-purple);" id="formTitle">New Note</div>
                                <input type="hidden" id="noteId">
                                <div class="form-row" style="margin-bottom:12px;"><input type="text" id="noteTitle" class="modern-input" placeholder="Title"></div>
                                <div class="form-row" style="margin-bottom:12px;"><textarea id="noteDesc" class="modern-input" rows="3" placeholder="Details"></textarea></div>
                                <div class="action-group" style="width: 100%; display: flex; gap: 10px;">
                                    <button onclick="saveNote()" class="btn-primary" style="flex: 1;">Save</button>
                                    <button onclick="toggleNoteForm()" class="btn-icon" style="flex: 1; border: 1px solid var(--border-dim); background: transparent; color: var(--text-muted);">Cancel</button>
                                </div>
                            </div>
                            <div class="notes-list" id="notesList"><div class="loading-state">Syncing...</div></div>
                        }
                    </div>
                </section>
                }
            </div>


            <!-- Translator Hub Card -->
            @if (IsAdmin || CanShow("translator-hub")) {
            <section class="tool-card translator-hub">
                <div class="card-title">
                    <div class="title-icon orange-glow">
                        <i class="fas fa-language"></i>
                    </div>
                    <div class="title-text">
                        <h3>Translator</h3>
                    </div>
                </div>

                <div class="tool-body" id="translatorBody" style="gap: 16px;">
                    <!-- Language Controls -->
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="transSourceLang" class="modern-select" style="flex: 1;" onchange="translateWidget()">
                            <option value="auto">Auto Detect</option>
                        </select>
                        
                        <button id="btnSwapLang" onclick="swapLanguages()" class="btn-icon" title="Swap Languages" 
                            style="width: 42px; height: 42px; min-width: 42px; border-radius: 50%; background: var(--bg-surface); border: 1px solid var(--border-dim);">
                            <i class="fas fa-right-left" style="font-size: 0.9rem; color: var(--accent-orange);"></i>
                        </button>
                        
                        <select id="transTargetLang" class="modern-select" style="flex: 1;" onchange="translateWidget()">
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <!-- Input Area -->
                    <div class="form-row" style="flex: 1;">
                        <textarea id="transInput" class="modern-input" 
                            placeholder="Type to translate..." 
                            style="resize:none; padding:14px; font-size:0.95rem; height: 100%; min-height: 90px;"
                            oninput="debounceTranslate()"></textarea>
                    </div>

                    <!-- Output Area -->
                    <div class="form-row" style="flex: 1; position: relative;">
                        <textarea id="transOutput" class="modern-input" 
                            placeholder="Translation..." 
                            readonly
                            style="resize:none; padding:14px; font-size:0.95rem; height: 100%; min-height: 90px;"></textarea>
                        
                        <button class="copy-btn" onclick="copyTranslation()" title="Copy" id="btnCopyTrans"
                            style="position: absolute; bottom: 12px; right: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; width: 32px; height: 32px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </section>
            }







            <!-- Smart Goal Tracker Hub -->
            @if (IsAdmin || CanShow("goal-hub")) {
            <section class="tool-card goal-hub">
                <div class="card-title" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="title-icon gold-glow"><i class="fas fa-trophy"></i></div>
                        <div class="title-text"><h3>Smart Goals</h3></div>
                    </div>
                    <button onclick="openGoalModal()" class="btn-icon" title="New Goal"><i class="fas fa-plus-circle"></i></button>
                </div>
                
                <!-- Analytics Summary -->
                <div id="goalAnalytics" class="hub-analytics" style="padding:10px 15px; background:rgba(255,215,0,0.05); border-bottom:1px solid var(--border-dim); display:flex; justify-content:space-around; align-items:center; font-size:0.75rem;">
                    <div class="stat-item"><span>Prod. Score</span>: <strong id="prodScore">0</strong>%</div>
                    <div class="stat-item"><span>Active</span>: <strong id="activeGoalsCount">0</strong></div>
                    <div class="stat-item"><span>Success</span>: <strong id="successRatio">0</strong>%</div>
                    <div class="stat-item"><span>Weekly</span>: <strong id="weeklyPerf">0</strong>%</div>
                </div>

                <div class="hub-display" style="padding:0; flex:1; display:flex; flex-direction:column; overflow:hidden;">
                    <!-- Today's Action List -->
                    <div id="todayTaskList" style="padding:15px; border-bottom:1px solid var(--border-dim); background:rgba(255,255,255,0.02); display:none;">
                        <h4 style="margin:0 0 12px 0; font-size:0.85rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; display:flex; justify-content:space-between;">
                            <span>Action Plan Today</span>
                            <span id="todayProgress" style="font-weight:normal; color:var(--accent-primary);">0% Done</span>
                        </h4>
                        <div id="todayTasksContainer" style="display:flex; flex-direction:column; gap:8px;">
                            <!-- Daily Tasks -->
                        </div>
                    </div>

                    <!-- All Goals List -->
                    <div id="goalListContainer" style="padding:15px; display:flex; flex-direction:column; gap:12px; flex:1; overflow-y:auto;">
                        <div style="padding: 30px; text-align: center; opacity: 0.6;"><i class="fas fa-bullseye" style="font-size: 2rem; margin-bottom: 10px;"></i><p>No active goals</p></div>
                    </div>
                </div>
            </section>
            }


        </div>
    </div>
</div>



<link rel="stylesheet" href="~/css/dashboard.css" />
<link rel="stylesheet" href="~/css/dashboard_modal.css" />

<!-- Habit Vault Modal -->
<div id="habitVaultModal" class="modal-overlay" style="display:none;" onclick="if(event.target === this) closeHabitVault()">
    <div class="modal-content glass-panel" style="max-width: 600px; width: 90%; max-height: 80vh; display:flex; flex-direction:column;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-dim); display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="title-icon green-glow" style="width:40px; height:40px; font-size:1.2rem;">
                    <i class="fas fa-archive"></i>
                </div>
                <h3 style="margin:0; font-size:1.2rem;">Habit Vault</h3>
            </div>
            <button class="icon-btn" onclick="closeHabitVault()"><i class="fas fa-times"></i></button>
        </div>
        <div id="habitVaultList" class="modal-body" style="padding: 0; overflow-y: auto; flex:1;">
             <!-- Items -->
        </div>
        <div class="modal-footer" style="padding:16px; border-top:1px solid var(--border-dim); text-align:right; color:var(--text-muted); font-size:0.8rem;">
            Total Stored Habits: <span id="vaultCount">0</span>
        </div>
    </div>
</div>

<!-- PDF Preview Modal -->
<div id="pdfPreviewModal" class="modal-overlay" style="display:none; z-index: 1100; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div class="modal-content glass-panel" style="max-width: 900px; width: 95%; height: 85vh; display:flex; flex-direction:column; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-dim); box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
        
        <div class="modal-header" style="padding: 16px 24px; border-bottom: 1px solid var(--border-dim); display:flex; justify-content:space-between; align-items:center; background: rgba(255,255,255,0.02);">
            <div style="display:flex; align-items:center; gap:12px; overflow: hidden;">
                <div class="text-emerald" style="font-size:1.4rem; filter: drop-shadow(0 0 8px rgba(52, 211, 153, 0.3));"><i class="fas fa-file-pdf"></i></div>
                <h3 id="pdfPreviewTitle" style="margin:0; font-size:1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-bright);">Document Preview</h3>
            </div>
            <button class="icon-btn" onclick="closePdfPreview()" style="font-size: 1.2rem; padding: 8px;"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="modal-body" style="padding: 0; flex:1; background: #1e1e1e; position: relative; overflow: hidden;">
             <iframe id="pdfModalFrame" style="width:100%; height:100%; border:none;"></iframe>
        </div>
    </div>
</div>

<!-- Smart Goal Creation Modal -->
<div id="goalModal" class="modal-overlay" style="display: @(TempData["ShowGoalModal"] != null ? "flex" : "none"); z-index: 1200;" onclick="if(event.target === this) closeGoalModal()">
    <div class="modal-content glass-panel" style="max-width: 500px; width: 95%;">
        <div class="modal-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="title-icon gold-glow"><i class="fas fa-magic"></i></div>
                <h3 style="margin:0;">Create Smart Goal</h3>
            </div>
            <button class="icon-btn" onclick="closeGoalModal()"><i class="fas fa-times"></i></button>
        </div>
        <form asp-action="CreateGoal" asp-controller="Goal" method="post">
            @Html.AntiForgeryToken()
            <div class="modal-body">
                @if (TempData["GoalErrors"] is List<string> errors)
                {
                    <div class="alert-box warning" style="display:block; margin-bottom:15px;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <ul style="margin:0; padding-left:20px; font-size:0.85rem;">
                            @foreach (var error in errors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </div>
                }
                <div id="goalWarning" class="alert-box warning" style="display:none; margin-bottom:15px;">
                    <i class="fas fa-exclamation-triangle"></i> <span id="goalWarningText"></span>
                </div>
                <div class="form-row">
                    <label>Goal Title</label>
                    <input type="text" name="Title" id="goalTitle" class="modern-input" placeholder="What do you want to achieve?" required value="@(TempData["GoalTitle"] ?? "")">
                </div>
                <div class="form-row">
                    <label>Description</label>
                    <textarea name="Description" id="goalDesc" class="modern-input" style="height:80px;" placeholder="Optional details...">@(TempData["GoalDescription"] ?? "")</textarea>
                </div>
                <div class="form-grid-2">
                    <div class="form-row">
                        <label>Category</label>
                        <select name="Category" id="goalCategory" class="modern-select">
                            <option>Personal</option>
                            <option>Work</option>
                            <option>Health</option>
                            <option>Finance</option>
                            <option>Learning</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Priority</label>
                        <select name="Priority" id="goalPriority" class="modern-select">
                            <option>Low</option>
                            <option selected>Medium</option>
                            <option>High</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-row">
                        <label>Start Date</label>
                        <input type="date" name="StartDate" id="goalStart" class="modern-input" required value="@(TempData["GoalStartDate"] ?? "")">
                    </div>
                    <div class="form-row">
                        <label>End Date</label>
                        <input type="date" name="EndDate" id="goalEnd" class="modern-input" required value="@(TempData["GoalEndDate"] ?? "")">
                    </div>
                </div>
                <div class="smart-engine-badge" style="margin-top:15px; background:rgba(255,215,0,0.1); border:1px dashed gold; padding:10px; border-radius:10px; font-size:0.8rem; color:var(--text-bright);">
                    <i class="fas fa-microchip"></i> <span>Smart Engine will automatically divide this goal into realistic milestones.</span>
                </div>
            </div>
            <div class="modal-footer" style="padding:20px; text-align:right;">
                <button type="submit" class="btn-primary" style="padding:12px 30px;">Initialize Goal</button>
            </div>
        </form>
    </div>
</div>

<!-- Goal Detail & Milestones Modal -->
<div id="goalDetailModal" class="modal-overlay" style="display:none; z-index: 1200;" onclick="if(event.target === this) closeGoalDetailModal()">
    <div class="modal-content glass-panel" style="max-width: 550px; width: 95%; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <div id="detailIcon" class="title-icon gold-glow"><i class="fas fa-bullseye"></i></div>
                <div>
                    <h3 id="detailTitle" style="margin:0;">Goal Title</h3>
                    <div id="detailCategory" style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">Category</div>
                </div>
            </div>
            <button class="icon-btn" onclick="closeGoalDetailModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="padding: 20px; overflow-y: auto; flex: 1; scrollbar-width: thin;">
            <div id="detailProgressSection" style="margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9rem;">
                    <span>Overall Progress</span>
                    <strong id="detailProgressText">0%</strong>
                </div>
                <div class="progress-bar-container" style="height:10px; background:rgba(255,255,255,0.05); border-radius:5px; overflow:hidden;">
                    <div id="detailProgressBar" style="height:100%; background:linear-gradient(90deg, #ffd700, #ff8c00); width:0%; transition: width 0.5s ease;"></div>
                </div>
            </div>

            <div id="deadlineWarning" class="alert-box danger" style="display:none; margin-bottom:15px; padding:10px; border-radius:8px; font-size:0.8rem;">
                <i class="fas fa-clock"></i> <span>Goal is Overdue! Take action to recover productivity score.</span>
            </div>

            <!-- Monthly Overview Section -->
            <div id="monthlyOverview" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom:20px; background:rgba(255,255,255,0.03); border:1px solid var(--border-dim); border-radius:12px; padding:12px; text-align:center;">
                <div class="stat-box">
                    <div style="font-size:0.65rem; color:var(--text-muted); text-transform:uppercase;">Days</div>
                    <div id="ovTotalDays" style="font-size:1.1rem; font-weight:700; color:gold;">0</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:0.65rem; color:var(--text-muted); text-transform:uppercase;">Done</div>
                    <div id="ovDoneDays" style="font-size:1.1rem; font-weight:700; color:var(--accent-success);">0</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:0.65rem; color:var(--text-muted); text-transform:uppercase;">Missed</div>
                    <div id="ovMissedDays" style="font-size:1.1rem; font-weight:700; color:var(--accent-danger);">0</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:0.65rem; color:var(--text-muted); text-transform:uppercase;">Monthly %</div>
                    <div id="ovMonthProgress" style="font-size:1.1rem; font-weight:700; color:var(--accent-primary);">0%</div>
                </div>
            </div>

            <!-- Goal Tracking Tabs -->
            <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid var(--border-dim); padding-bottom:8px;">
                <button onclick="switchGoalTab('strategy')" class="tab-btn active" id="tab_strategy" style="flex:1; padding:6px; background:none; border:none; color:var(--text-bright); font-size:0.75rem; cursor:pointer; transition:all 0.2s;">Breakdown</button>
                <button onclick="switchGoalTab('milestones')" class="tab-btn" id="tab_milestones" style="flex:1; padding:6px; background:none; border:none; color:var(--text-muted); font-size:0.75rem; cursor:pointer; transition:all 0.2s;">Milestones</button>
                <button onclick="switchGoalTab('calendar')" class="tab-btn" id="tab_calendar" style="flex:1; padding:6px; background:none; border:none; color:var(--text-muted); font-size:0.75rem; cursor:pointer; transition:all 0.2s;">Calendar</button>
                <button onclick="switchGoalTab('analytics')" class="tab-btn" id="tab_analytics" style="flex:1; padding:6px; background:none; border:none; color:var(--text-muted); font-size:0.75rem; cursor:pointer; transition:all 0.2s;">Analytics</button>
            </div>

            <!-- Daily Breakdown Tab -->
            <div id="goalTab_strategy" class="goal-tab-content">
                <div id="monthlyDailyList" style="display:flex; flex-direction:column; gap:10px; padding-right:5px;">
                    <!-- Monthly days list -->
                </div>
            </div>

            <!-- Milestones Tab -->
            <div id="goalTab_milestones" class="goal-tab-content" style="display:none;">
                <div id="milestoneList" style="display:flex; flex-direction:column; gap:12px;">
                    <!-- Milestones list -->
                </div>
            </div>

            <!-- Calendar Tab -->
            <div id="goalTab_calendar" class="goal-tab-content" style="display:none;">
                <div id="goalCalendar" class="goal-calendar-grid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:4px; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-bottom:15px;">
                    <!-- Calendar Grid -->
                </div>
                <div id="selectedDayTasks" style="border-top:1px solid var(--border-dim); padding-top:12px; display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h5 id="selectedDateTitle" style="font-size:0.8rem; color:gold; margin:0;">Date Action Plan</h5>
                        <div id="calendarAddTaskContainer" style="display:flex; align-items:center; gap:8px;">
                            <button id="calendarAddTaskBtn" onclick="addTaskToSelectedDate()" class="btn-icon" style="font-size:0.8rem; color:var(--accent-success);"><i class="fas fa-plus"></i> Add Task</button>
                            <span id="calendarLimitMsg" style="display:none; font-size:0.65rem; color:var(--text-muted);"><i class="fas fa-info-circle"></i> Daily limit reached</span>
                        </div>
                    </div>
                    <div id="selectedDayTasksContainer" style="display:flex; flex-direction:column; gap:6px;"></div>
                </div>
            </div>

            <!-- Performance/Insights Tab -->
            <div id="goalTab_analytics" class="goal-tab-content" style="display:none;">
                <h5 style="font-size:0.8rem; color:var(--text-bright); margin-bottom:8px;">90-Day Activity Heatmap</h5>
                <div id="heatmapContainer" style="display:flex; flex-wrap:wrap; gap:3px; background:rgba(0,0,0,0.1); padding:8px; border-radius:6px; justify-content:center; margin-bottom:20px;"></div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                    <div style="font-size:1.1rem; color:gold; font-weight:700;"><i class="fas fa-fire"></i> <span id="detailStreak">0 Day Streak 🔥</span></div>
                    <button onclick="redistributeTasks()" class="btn-secondary" style="font-size:0.75rem; padding:8px 15px; border:1px solid #58a6ff40; border-radius:8px; color:#58a6ff; background:#58a6ff10;">Redistribute Missed Tasks</button>
                </div>
            </div>
        </div>
        <div class="modal-footer" style="padding:15px; border-top:1px solid var(--border-dim); display:flex; justify-content:space-between; align-items:center;">
            <button onclick="confirmDeleteGoal()" class="btn-icon text-danger" title="Delete Goal"><i class="fas fa-trash-alt"></i></button>
            <div id="detailScheduleStatus" style="font-size:0.8rem; font-weight:700; text-transform:uppercase; color:var(--text-dim);">On Track</div>
            <button onclick="closeGoalDetailModal()" class="btn-primary" style="padding:8px 25px; font-size:0.85rem; border-radius:8px;">Close</button>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div id="editTaskModal" class="modal-overlay" style="display:none; z-index: 1300;" onclick="if(event.target === this) closeEditTaskModal()">
    <div class="modal-content glass-panel" style="max-width: 400px; width: 90%;">
        <div class="modal-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="title-icon gold-glow" style="width:32px; height:32px; font-size:1rem;"><i class="fas fa-edit"></i></div>
                <h4 style="margin:0;">Edit Task</h4>
            </div>
            <button class="icon-btn" onclick="closeEditTaskModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="padding:20px;">
            <input type="hidden" id="editTaskId">
            <input type="hidden" id="editTaskGoalId">
            <div class="form-row" style="margin-bottom:15px;">
                <label style="font-size:0.8rem; color:var(--text-muted); margin-bottom:5px; display:block;">Task Title</label>
                <input type="text" id="editTaskTitle" class="modern-input" placeholder="What needs to be done?">
            </div>
            <div class="form-row">
                <label style="font-size:0.8rem; color:var(--text-muted); margin-bottom:5px; display:block;">Description</label>
                <textarea id="editTaskDesc" class="modern-input" style="height:80px;" placeholder="Optional details..."></textarea>
            </div>
        </div>
        <div class="modal-footer" style="padding:15px; text-align:right; border-top:1px solid var(--border-dim);">
            <button onclick="saveEditTask()" class="btn-primary" style="padding:8px 25px; border-radius:8px;">Save Changes</button>
        </div>
    </div>
</div>


@section Scripts {
        <script>
            function getWeatherDesc(code) {
                const map = {
                    0: 'Clear skies', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                    45: 'Fog', 48: 'Depositing rime fog', 51: 'Light drizzle', 53: 'Moderate drizzle',
                    55: 'Dense drizzle', 61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
                    71: 'Slight snow', 73: 'Moderate snow', 75: 'Heavy snow', 77: 'Snow grains',
                    80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
                    95: 'Thunderstorm', 96: 'Thunderstorm with slight hail', 99: 'Thunderstorm with heavy hail'
                };
                return map[code] || 'Clear skies';
            }

            const weatherIcons = {
                0: 'fa-sun', 1: 'fa-cloud-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud',
                45: 'fa-smog', 48: 'fa-smog', 51: 'fa-cloud-rain', 53: 'fa-cloud-rain',
                55: 'fa-cloud-showers-heavy', 61: 'fa-cloud-rain', 63: 'fa-cloud-rain',
                65: 'fa-cloud-showers-heavy', 71: 'fa-snowflake', 73: 'fa-snowflake',
                75: 'fa-snowflake', 80: 'fa-cloud-bolt', 81: 'fa-cloud-bolt',
                82: 'fa-cloud-bolt', 95: 'fa-bolt-lightning'
            };

            function getIcon(code) { return weatherIcons[code] || 'fa-cloud'; }

            // --- GLOBAL NETWORK NODES ---
            let allNodes = [];
            const initialNodes = [
                { name: "Ahmedabad", lat: 23.0225, lon: 72.5714, cc: "GJ, IN" },
                { name: "Surat", lat: 21.1702, lon: 72.8311, cc: "GJ, IN" },
                { name: "Vadodara", lat: 22.3072, lon: 73.1812, cc: "GJ, IN" },
                { name: "Rajkot", lat: 22.3039, lon: 70.8022, cc: "GJ, IN" },
                { name: "London", lat: 51.5074, lon: -0.1278, cc: "GB" },
                { name: "New York", lat: 40.7128, lon: -74.0060, cc: "US" },
                { name: "Tokyo", lat: 35.6895, lon: 139.6917, cc: "JP" },
                { name: "Mumbai", lat: 19.0760, lon: 72.8777, cc: "IN" },
                { name: "Delhi", lat: 28.6139, lon: 77.2090, cc: "IN" }
            ];

            async function initNodeDirectory() {
                const container = document.getElementById('worldWeatherList');
                if (container) {
                    container.innerHTML = `<div class="loading-state">Syncing Global Nodes...</div>`;
                }

                allNodes = [];
                for (const n of initialNodes) {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${n.lat}&longitude=${n.lon}&current=temperature_2m,weather_code`);
                        const data = await res.json();
                        allNodes.push({ ...n, weather: data.current });
                    } catch (e) { }
                }
                renderNodes(allNodes);
            }

            function renderNodes(nodes) {
                const container = document.getElementById('worldWeatherList');
                const nodeCount = document.getElementById('nodeCount');
                if (!container) return;
                container.innerHTML = '';

                if (nodeCount) {
                    nodeCount.innerText = `${nodes.length} Nodes Active`;
                }

                for (const item of nodes) {
                    const el = document.createElement('div');
                    el.className = 'node-item slide-in';

                    el.onclick = () => {
                        fetchWeatherDeep(item.lat, item.lon, `${item.name}, ${item.cc}`);
                    };

                    const iconClass = getIcon(item.weather.weather_code);
                    const temp = Math.round(item.weather.temperature_2m);
                    el.innerHTML = `<div><h4>${item.name}</h4><span>Region: ${item.cc}</span></div>
                                                                                                                                                    <div class="node-data"><i class="fas ${iconClass}"></i>
                                                                                                                                                    <b>${temp}°C</b></div>`;
                    container.appendChild(el);
                }
            }

            function getCurrentLocation() {
                const display = document.getElementById('weatherResult');
                display.innerHTML = `<div class="loading-state">Triangulating Satellite Uplink...</div>`;

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (p) => fetchWeatherDeep(p.coords.latitude, p.coords.longitude, "Local Terminal"),
                        () => {
                            display.innerHTML = `<div class="text-danger">Uplink Interrupted</div>`;
                        }
                    );
                }
            }

            async function getWeather(cityOverride) {
                const query = cityOverride || document.getElementById('cityInput').value || 'London';
                try {
                    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=1&language=en&format=json`);
                    const data = await res.json();
                    if (!data.results) {
                        document.getElementById('weatherResult').innerHTML = `<div class="text-danger">City not found</div>`;
                        return;
                    }
                    const { latitude, longitude, name, country } = data.results[0];
                    fetchWeatherDeep(latitude, longitude, `${name}, ${country}`);
                } catch (e) {
                    document.getElementById('weatherResult').innerHTML = `<div class="text-danger">City not found</div>`;
                }
            }

            async function fetchWeatherDeep(lat, lon, label) {
                const display = document.getElementById('weatherResult');
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`);
                    const data = await res.json();
                    const cur = data.current;
                    const timezone = data.timezone;

                    const weatherDesc = getWeatherDesc(cur.weather_code);

                    // Calculate Local Time
                    let localTimeStr = "--:--";
                    try {
                        const date = new Date();
                        localTimeStr = new Intl.DateTimeFormat('en-US', {
                            timeZone: timezone, weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                        }).format(date);
                    } catch (e) { console.error("Time calc error", e); }

                    display.innerHTML = `
                                                                                                                                                                                        <div class="loc-label slide-in">${label}</div>
                                                                                                                                                                                        <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;" class="slide-in">${localTimeStr}</div>
                                                                                                                                                                                        <div class="temp-hero slide-in">${Math.round(cur.temperature_2m)}°</div>
                                                                                                                                                                                        <div class="weather-desc slide-in">${weatherDesc}</div>
                                                                                                                                                                                        <div class="stats-deep slide-in">
                                                                                                                                                                                            <div class="stat-box"><i class="fas fa-droplet"></i> <label>Humidity</label> <b>${cur.relative_humidity_2m}%</b></div>
                                                                                                                                                                                            <div class="stat-box"><i class="fas fa-wind"></i> <label>Wind Velocity</label> <b>${Math.round(cur.wind_speed_10m)} km/h</b></div>
                                                                                                                                                                                        </div>`;
                } catch (e) {
                    display.innerHTML = `<div class="text-danger">Satellite Link Failure</div>`;
                }
            }


            // --- FISCAL & TIMEZONE DATA ---
            let currencyContext = null; // Stores { city: string, country: string, currency: string }

            /* --- SHARED DATASET --- */
            /* --- SHARED DATASET --- */
            let globalLocationData = []; // The master list for both Currency and Timezone
            let emergencyCountryList = []; // Master list for Emergency Search


            async function initFiscal(preserveState = false) {
                const f = document.getElementById('fromCurrency');
                const t = document.getElementById('toCurrency');

                // Capture current selection if preserving state
                let currentVals = {};
                if (preserveState) {
                    currentVals = { f: f.value, t: t.value };
                }

                // Major Non-Capital Cities (IANA Timezones) to ensure comprehensive global coverage
                const extraCities = [
                    { country: "United States", city: "New York", currency: "USD", timezone: "America/New_York", code: "US" },
                    { country: "United States", city: "Los Angeles", currency: "USD", timezone: "America/Los_Angeles", code: "US" },
                    { country: "United States", city: "Chicago", currency: "USD", timezone: "America/Chicago", code: "US" },
                    { country: "India", city: "Mumbai", currency: "INR", timezone: "Asia/Kolkata", code: "IN" },
                    { country: "India", city: "Bengaluru", currency: "INR", timezone: "Asia/Kolkata", code: "IN" },
                    { country: "India", city: "Delhi", currency: "INR", timezone: "Asia/Kolkata", code: "IN" },
                    { country: "United Kingdom", city: "London", currency: "GBP", timezone: "Europe/London", code: "GB" },
                    { country: "Japan", city: "Tokyo", currency: "JPY", timezone: "Asia/Tokyo", code: "JP" },
                    { country: "China", city: "Shanghai", currency: "CNY", timezone: "Asia/Shanghai", code: "CN" },
                    { country: "Germany", city: "Berlin", currency: "EUR", timezone: "Europe/Berlin", code: "DE" },
                    { country: "France", city: "Paris", currency: "EUR", timezone: "Europe/Paris", code: "FR" },
                    { country: "Australia", city: "Sydney", currency: "AUD", timezone: "Australia/Sydney", code: "AU" },
                    { country: "Canada", city: "Toronto", currency: "CAD", timezone: "America/Toronto", code: "CA" },
                    { country: "United Arab Emirates", city: "Dubai", currency: "AED", timezone: "Asia/Dubai", code: "AE" },
                    { country: "Singapore", city: "Singapore", currency: "SGD", timezone: "Asia/Singapore", code: "SG" }
                ];

                // IMMEDIATE RENDER of reliable static data (Popular)
                globalLocationData = [...extraCities];

                // Define Helper Functions LOCALLY to ensure they exist
                const createOpt = (c) => {
                    const val = `${c.currency}|${c.country}`;
                    const opt = new Option(`${c.city}, ${c.country}`, val);
                    opt.setAttribute('data-city', c.city);
                    opt.setAttribute('data-country', c.country);
                    opt.setAttribute('data-currency', c.currency);
                    opt.setAttribute('data-timezone', c.timezone);
                    return opt;
                };

                const appendGroup = (parent, label, items) => {
                    if (items.length === 0) return;
                    const group = document.createElement('optgroup');
                    group.label = label;
                    items.forEach(c => group.appendChild(createOpt(c)));
                    parent.appendChild(group);
                };

                // Helper to populate
                const populateDropdowns = async (data) => {
                    f.innerHTML = ''; t.innerHTML = '';
                    const uniqueLocs = [];
                    const seen = new Set();
                    data.forEach(loc => {
                        const key = `${loc.city}|${loc.country}`;
                        if (!seen.has(key)) { seen.add(key); uniqueLocs.push(loc); }
                    });
                    const sorted = uniqueLocs.sort((a, b) => a.city.localeCompare(b.city));

                    const popNames = ['United States', 'India', 'United Kingdom', 'Japan', 'China', 'Germany', 'France', 'Australia', 'Canada', 'Switzerland', 'United Arab Emirates', 'Singapore'];
                    const topLocs = sorted.filter(c => popNames.includes(c.country));
                    const otherLocs = sorted.filter(c => !popNames.includes(c.country));

                    appendGroup(f, 'Popular', topLocs);
                    appendGroup(f, 'Global Locations', otherLocs);

                    appendGroup(t, 'Popular', topLocs);
                    appendGroup(t, 'Global Locations', otherLocs);

                    // Restore or Default
                    if (preserveState && currentVals.f && currentVals.t) {
                        f.value = currentVals.f; t.value = currentVals.t;
                    } else {
                        const setDefault = (el, country) => {
                            for (let i = 0; i < el.options.length; i++) {
                                if (el.options[i].getAttribute('data-country') === country) {
                                    el.selectedIndex = i; break;
                                }
                            }
                        };
                        setDefault(f, 'United States');
                        setDefault(t, 'India');
                    }
                };

                // 1. Render Defaults Immediately
                // 1. Render Defaults Immediately
                await populateDropdowns(globalLocationData);
                // Pre-fill emergency list with static data
                emergencyCountryList = extraCities.map(c => ({ name: c.country, code: c.code }));


                initTimezones(); // Needed for clock

                try {
                    // 2. Fetch Country/Currency Data (Background Enhancement)
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 4000);

                    const res = await fetch('https://restcountries.com/v3.1/all?fields=name,currencies,flags,cca2,capital,timezones', { signal: controller.signal });
                    clearTimeout(timeoutId);

                    const data = await res.json();



                    // 2. Build Base List from Countries (Capitals)
                    let apiLocations = data
                        .filter(c => c.currencies && Object.keys(c.currencies).length > 0)
                        .map(c => {
                            const code = Object.keys(c.currencies)[0];
                            const city = (c.capital && c.capital.length > 0) ? c.capital[0] : c.name.common;
                            return {
                                country: c.name.common,
                                code: c.cca2,
                                city: city,
                                flag: c.flags.svg || '',
                                currency: code,
                                symbol: c.currencies[code].symbol,
                                timezone: (c.timezones && c.timezones.length > 0 && (c.timezones[0] === 'UTC' || c.timezones[0].includes('/')))
                                    ? c.timezones[0]
                                    : null
                            };
                        });

                    // 3. Merge and Sort
                    const finalApiList = [...extraCities, ...apiLocations];
                    // Update Global List
                    globalLocationData = finalApiList;





                    // Update Emergency Search List (Countries + Cities)
                    const eList = [];
                    const addedCodes = new Set();

                    finalApiList.forEach(loc => {
                        if (!loc.code) return;

                        // Add City (if distinct from country name)
                        if (loc.city && loc.city !== loc.country) {
                            eList.push({
                                name: loc.city,
                                code: loc.code,
                                official: loc.country,
                                type: 'city',
                                parent: loc.country
                            });
                        }

                        // Add Country (Unique)
                        if (!addedCodes.has(loc.code)) {
                            addedCodes.add(loc.code);
                            eList.push({
                                name: loc.country,
                                code: loc.code,
                                official: loc.country,
                                type: 'country'
                            });
                        }
                    });
                    emergencyCountryList = eList;


                    await populateDropdowns(globalLocationData);
                    initTimezones(); // Refresh Timezone List with full data

                } catch (e) {
                    console.warn('Fiscal API failed or timed out, keeping default list.', e);
                }


                // End Init
            }

            // --- PDF CONVERTER LOGIC ---
            // --- PDF CONVERTER LOGIC ---
            let pdfCollection = [];

            function convertFileToPdf() {
                const fileInput = document.getElementById('pdfInputFile');
                const formatSelect = document.getElementById('pdfTargetFormat');
                const resultArea = document.getElementById('pdfResult');
                const listSection = document.getElementById('pdfListSection');

                if (!fileInput.files || fileInput.files.length === 0) {
                    alert("Please select a file first.");
                    return;
                }
                
                // UI Loading State - Minimal (optional: disable button?)
                resultArea.style.display = 'none';
                resultArea.innerHTML = '';

                const merge = document.getElementById('pdfMergeCheck').classList.contains('checked');
                const pageSize = document.getElementById('pdfPageSize').value;
                const orientation = document.getElementById('pdfOrientation').value;
                const quality = document.getElementById('pdfQuality').value;

                const formData = new FormData();
                for (let i = 0; i < fileInput.files.length; i++) {
                    formData.append("files", fileInput.files[i]);
                }
                formData.append("targetFormat", formatSelect.value);
                formData.append("mergeFiles", merge);
                formData.append("pageSize", pageSize);
                formData.append("orientation", orientation);
                formData.append("quality", quality);

                fetch('/Tools/ConvertToPdf', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Success - Add to List with returned ID
                            const newDoc = {
                                id: data.id || Date.now(),
                                name: data.fileName,
                                url: data.downloadUrl
                            };
                            pdfCollection.unshift(newDoc);
                            renderPdfList();
                            listSection.style.display = 'block';
                        } else {
                            resultArea.style.display = 'flex';
                            resultArea.innerHTML = `
                                <div class="error-state" style="text-align: center; color: var(--accent-danger);">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                                    <p>Error: ${data.message}</p>
                                </div>`;
                        }
                    })
                    .catch(error => {
                        resultArea.style.display = 'flex';
                        resultArea.innerHTML = `
                            <div class="error-state" style="text-align: center; color: var(--accent-danger);">
                                <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                                <p>System Failure: ${error.message}</p>
                            </div>`;
                    });
            }

            async function initPdfHistory() {
                if (typeof ensureWidgetUnlocked === 'function') ensureWidgetUnlocked('pdfBody');
                try {
                    const res = await fetch('/Tools/GetUserPdfs');
                    if(res.ok) {
                        const data = await res.json();
                        // Map server model to local model
                        // Server: { id, userId, fileName, filePath, createdAt }
                        pdfCollection = data.map(d => ({
                            id: d.id,
                            name: d.fileName,
                            url: d.filePath
                        }));
                        renderPdfList();
                        if (pdfCollection.length > 0) {
                            document.getElementById('pdfListSection').style.display = 'block';
                        }
                    }
                } catch(e) { console.error("Failed to load PDF history", e); }
            }

            function clearPdfList() {
                if(confirm('Clear all converted files history? This will delete files from server.')) {
                    // Loop delete or just clear local? Requirement: "Persist... until explicitly deleted".
                    // "Clear All" usually implies local cleanup or mass delete.
                    // Given the constraint "Users can only see... their own PDFs", let's make Clear All massive.
                    // But we don't have a Mass Delete endpoint.
                    // Let's iterate for now or just hide.
                    // Better: UI requirement said "Clear all/reset option", usually implies session reset.
                    // But User Request says "Persist...".
                    // Let's implement individual deletes properly.
                    // For "Clear All", let's just do individual deletes for all locally known to ensure consistency.
                    // Or add a DeleteAll endpoint. 
                    // Let's just keep it UI only for now? No, that violates persistence.
                    // Let's iterate delete.
                    
                    // Actually, for simplicity/safety, let's just make Clear All hide/reset LOCAL view if user wants to declutter, 
                    // BUT prompt says "Delete" action is for each item. 
                    // Let's make Clear All iterate delete.
                    
                    pdfCollection.forEach(p => deletePdfDoc(p.id, true)); // true = suppress render
                    pdfCollection = [];
                    renderPdfList();
                }
            }
            
            async function savePdfName(id) {
                const input = document.getElementById(`input-${id}`);
                let val = input.value.trim();
                
                if(val) {
                    if(!val.toLowerCase().endsWith('.pdf') && !val.toLowerCase().endsWith('.zip') && !val.toLowerCase().endsWith('.jpg')) {
                         // Keep extension
                         const doc = pdfCollection.find(d => d.id === id);
                         const ext = doc.name.split('.').pop();
                         val += '.' + ext;
                    }

                    const doc = pdfCollection.find(d => d.id === id);
                    if(doc) {
                        doc.name = val;
                        // Server Update
                        try {
                            await fetch('/Tools/RenameUserPdf', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ Id: id, FileName: val })
                            });
                        } catch(e) { console.error(e); }
                    }
                }
                renderPdfList(); 
            }

            async function deletePdfDoc(id, suppressRender = false) {
                if (!suppressRender && !confirm('Delete this file?')) return;
                
                try {
                    await fetch('/Tools/DeleteUserPdf', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(id)
                    });
                    
                    pdfCollection = pdfCollection.filter(d => d.id !== id);
                    if(!suppressRender) renderPdfList();
                } catch(e) { console.error(e); }
            }

            function renderPdfList() {
                const list = document.getElementById('pdfFilesListContainer');
                list.innerHTML = '';
                
                if(pdfCollection.length === 0) {
                     document.getElementById('pdfListSection').style.display = 'none';
                     return;
                }

                pdfCollection.forEach(doc => {
                    const el = document.createElement('div');
                    el.className = 'pdf-history-item'; // Reuse existing style
                    el.style.background = 'rgba(0,0,0,0.2)';
                    
                    el.innerHTML = `
                        <div class="pdf-history-icon"><i class="fas fa-file-pdf"></i></div>
                        <div class="pdf-history-meta">
                            <div class="pdf-history-name" onclick="editPdfName(${doc.id})" title="Click to Rename" id="name-${doc.id}">${doc.name}</div>
                            <input type="text" id="input-${doc.id}" value="${doc.name}" class="modern-input" 
                                style="display:none; padding:4px 8px; width:100%; font-size:0.9rem; height:auto;" 
                                onblur="savePdfName(${doc.id})" 
                                onkeydown="if(event.key==='Enter') savePdfName(${doc.id})">
                        </div>
                        <div class="pdf-history-actions">
                            <button class="btn-mini-action preview" onclick="openPdfPreview(${doc.id})" title="Preview Document"><i class="fas fa-eye"></i></button>
                            <button class="btn-mini-action" onclick="editPdfName(${doc.id})" title="Rename"><i class="fas fa-pen"></i></button>
                            <a href="${doc.url}" download="${doc.name}" class="btn-mini-action download" title="Download"><i class="fas fa-download"></i></a>
                            <button class="btn-mini-action" onclick="deletePdfDoc(${doc.id})" title="Delete" style="color:var(--accent-danger);"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(el);
                });
            }

            function editPdfName(id) {
                document.getElementById(`name-${id}`).style.display = 'none';
                const input = document.getElementById(`input-${id}`);
                input.style.display = 'block';
                input.focus();
            }

            function savePdfName(id) {
                const input = document.getElementById(`input-${id}`);
                let val = input.value.trim();
                
                if(val) {
                    if(!val.toLowerCase().endsWith('.pdf')) val += '.pdf';
                    const doc = pdfCollection.find(d => d.id === id);
                    if(doc) doc.name = val;
                }
                renderPdfList();
            }

            function deletePdfDoc(id) {
                if(confirm('Delete this file?')) {
                    pdfCollection = pdfCollection.filter(d => d.id !== id);
                    renderPdfList();
                }
            }

            function openPdfPreview(id) {
                const doc = pdfCollection.find(d => d.id === id);
                if(!doc) return;
                
                const modal = document.getElementById('pdfPreviewModal');
                const frame = document.getElementById('pdfModalFrame');
                const title = document.getElementById('pdfPreviewTitle');
                
                modal.style.display = 'flex'; // Flex for centering
                title.innerText = doc.name;
                frame.src = doc.url;
            }

            function closePdfPreview() {
                const modal = document.getElementById('pdfPreviewModal');
                const frame = document.getElementById('pdfModalFrame');
                
                modal.style.display = 'none';
                frame.src = '';
            }




            async function fetchLatestRates(shouldConvert = true) {
                const rawVal = document.getElementById('fromCurrency').value;
                // Ensure we have a value. If list empty (load error), return.
                if (!rawVal) return;

                const f = rawVal.split('|')[0];
                try {
                    // Using a fallback or free API
                    const res = await fetch(`https://open.er-api.com/v6/latest/${f}`);
                    const data = await res.json();
                    window.baseCurrencyRates = data.rates;

                    const updateEl = document.getElementById('lastExchangeUpdate');

                    if (updateEl) {
                        updateEl.innerText = `Last Synced: ${new Date().toLocaleTimeString()} (${f})`;
                    }

                    // Only convert if requested (user action)
                    if (shouldConvert) convertCurrency();

                } catch (e) { console.error('Rate Fetch Error:', e); }
            }

            async function convertCurrency() {
                const amount = parseFloat(document.getElementById('amountInput').value) || 0;
                const fEl = document.getElementById('fromCurrency');
                const tEl = document.getElementById('toCurrency');

                const rawF = fEl.value;
                const rawT = tEl.value;
                if (!rawF || !rawT) return;

                const f = rawF.split('|')[0];
                const t = rawT.split('|')[0];

                // Logic to update stored context based on user interaction
                const getMeta = (el) => {
                    const opt = el.options[el.selectedIndex];
                    if (!opt) return null;
                    return {
                        city: opt.getAttribute('data-city'),
                        country: opt.getAttribute('data-country'),
                        currency: opt.getAttribute('data-currency'),
                        timezone: opt.getAttribute('data-timezone')
                    };
                };

                let targetMeta = getMeta(tEl);
                let baseMeta = getMeta(fEl);

                if (!currencyContext || (currencyContext.country !== baseMeta.country && currencyContext.country !== targetMeta.country)) {
                    currencyContext = targetMeta;
                }

                const display = document.getElementById('currencyResult');

                if (!window.baseCurrencyRates || !window.baseCurrencyRates[t]) {
                    display.innerHTML = `<div class="loading-state">Syncing New Base Rates...</div>`;
                    await fetchLatestRates();
                    // Check again
                    if (!window.baseCurrencyRates || !window.baseCurrencyRates[t]) return;
                }

                const rate = window.baseCurrencyRates[t];
                const calc = amount * rate;

                // Check Context for Location Display
                let locationDisplay = '';

                if (currencyContext) {
                    let contextMatch = null;
                    if (currencyContext.country === baseMeta.country) contextMatch = 'Base';
                    else if (currencyContext.country === targetMeta.country) contextMatch = 'Target';

                    if (contextMatch) {
                        // Calculate Time
                        let timeStr = '';
                        if (currencyContext.timezone) {
                            try {
                                const now = new Date();
                                const time = now.toLocaleTimeString('en-US', { timeZone: currencyContext.timezone, hour: '2-digit', minute: '2-digit' });
                                const date = now.toLocaleDateString('en-US', { timeZone: currencyContext.timezone, day: 'numeric', month: 'short' });
                                timeStr = `<div style="font-size: 0.75rem; opacity: 0.8; margin-top: 2px;">
                                                                                                                                                                                                                                                                     <i class="fas fa-clock" style="font-size:0.7em"></i> ${date} • ${time}
                                                                                                                                                                                                                                                                   </div>`;
                            } catch (e) { }
                        }

                        const label = contextMatch === 'Base' ? 'Base Location' : 'Target Location';
                        const city = currencyContext.city;
                        const country = currencyContext.country;

                        const colorVar = contextMatch === 'Base' ? 'var(--accent-primary)' : 'var(--accent-emerald)';
                        const bgVar = contextMatch === 'Base' ? 'rgba(88, 166, 255, 0.1)' : 'rgba(52, 211, 153, 0.1)';
                        const borderVar = contextMatch === 'Base' ? 'rgba(88, 166, 255, 0.2)' : 'rgba(52, 211, 153, 0.2)';

                        locationDisplay = `<div style="text-align:center; margin-bottom: 12px; color: ${colorVar}; background: ${bgVar}; padding: 8px; border-radius: 8px; border: 1px solid ${borderVar};">
                                                                                                                                                                                                                                                                     <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 4px;">${label}</div>
                                                                                                                                                                                                                                                                     <div style="font-weight: 700; font-size: 0.95rem;">
                                                                                                                                                                                                                                                                        <i class="fas fa-location-dot"></i> ${city}, ${country}
                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                     ${timeStr}
                                                                                                                                                                                                                                                                   </div>`;
                    }
                }


                display.innerHTML = `
                                                                                                                                                                                                                                            ${locationDisplay}
                                                                                                                                                                                                                                                <div class="val-grid">
                                                                                                                                                                                                                                                    <div class="val-box slide-in highlight-border">
                                                                                                                                                                                                                                                        <div class="val-label">${f}</div>
                                                                                                                                                                                                                                                        <div class="val-number">${amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                                                                                                                                                                                                                                                        <div class="val-loc-meta">Base Amount</div>
                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                    <div class="val-box slide-in">
                                                                                                                                                                                                                                                        <div class="val-label">${t}</div>
                                                                                                                                                                                                                                                        <div class="val-number highlight">${calc.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                                                                                                                                                                                                                                         <div class="val-loc-meta">Rate: ${rate.toFixed(4)}</div>
                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                </div>`;
            }

            /* --- TIMEZONE LOGIC --- */
            function initTimezones() {
                const select = document.getElementById('timezoneSelect');
                if (!select) return;

                // Preserve current selection if possible
                const currentVal = select.value;
                select.innerHTML = '';

                // USE globalLocationData (Shared Dataset)
                // Filter out entries that have garbage timezones (like "UTC+05:00") if we want strict IANA,
                // BUT for the "System" to work, we accept what we have.
                // Ideally we prioritized the `extraCities` for good IANA zones.

                // Sort and Deduplicate
                const sorted = [...globalLocationData].sort((a, b) => a.city.localeCompare(b.city));
                const seen = new Set();

                sorted.forEach(loc => {
                    let tzValue = loc.timezone;
                    // Only add if we have a valid timezone string
                    if (!tzValue) return;

                    const label = `${loc.city}, ${loc.country}`;
                    if (seen.has(label)) return;
                    seen.add(label);

                    const opt = document.createElement('option');
                    opt.value = tzValue;
                    opt.text = `${loc.city}, ${loc.country}`;
                    opt.setAttribute('data-full', tzValue);
                    if (tzValue === currentVal) opt.selected = true;
                    select.appendChild(opt);
                });

                // Default if nothing selected
                if (select.selectedIndex === -1) {
                    // Try to select Mumbai or New York
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value.includes('Kolkata') || select.options[i].value.includes('New_York')) {
                            select.selectedIndex = i;
                            break;
                        }
                    }
                }

                updateConvertedTime();
            }

            // Helper to get rigorous locale for formatting
            function getCurrentLocale() {
                const lang = (window.translator && window.translator.currentLang) ? window.translator.currentLang : 'en';
                const map = {
                    'en': 'en-US',
                    'es': 'es-ES',
                    'fr': 'fr-FR',
                    'de': 'de-DE',
                    'hi': 'hi-IN',
                    'gu': 'gu-IN',
                    'zh': 'zh-CN',
                    'ja': 'ja-JP',
                    'ru': 'ru-RU',
                    'ar': 'ar-EG'
                };
                return map[lang] || 'en-US';
            }

            function runChronos() {
                try {
                    const now = new Date();
                    const locale = getCurrentLocale();

                    const dateEl = document.getElementById('headerDate');
                    if (dateEl) {
                        // Use format: Weekday, Month Day, Year (in locale)
                        // e.g. Friday, January 23, 2026
                        dateEl.innerText = now.toLocaleDateString(locale, {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }

                    const timeEl = document.getElementById('headerTime');
                    if (timeEl) {
                        timeEl.innerText = now.toLocaleTimeString(locale, { hour12: false });
                        // Should we use hour12 based on locale? Default is usually good.
                        // But military time is often preferred in dashboards. 
                        // Let's stick to locale default but maybe force 2-digit? 
                        // User said "clean, readable format similar to English".
                        // Most locales do HH:mm:ss nicely.
                        // Actually, let's trust the locale default for TimeString.
                        timeEl.innerText = now.toLocaleTimeString(locale);
                    }

                    const localLargeEl = document.getElementById('localTimeLarge');
                    if (localLargeEl) localLargeEl.innerText = now.toLocaleTimeString(locale);

                    // Also update the accent box if it exists
                    if (typeof updateConvertedTime === 'function') updateConvertedTime();
                } catch (e) {
                    console.error("Chronos Error:", e);
                    // Hard Fallback
                    try {
                        const fb = new Date().toLocaleTimeString();
                        if (document.getElementById('headerTime')) document.getElementById('headerTime').innerText = fb;
                    } catch (z) { }
                }
            }

            function updateConvertedTime() {
                const zone = document.getElementById('timezoneSelect').value;
                const now = new Date();
                const locale = getCurrentLocale();

                try {
                    const timeString = now.toLocaleTimeString(locale, { timeZone: zone });
                    const dateString = now.toLocaleDateString(locale, { timeZone: zone, weekday: 'short', month: 'short', day: 'numeric' });

                    // Get offset safely - keeping this part English-y or technical is often better for "GMT+5" etc.
                    // But let's try locale.
                    const typePart = Intl.DateTimeFormat(locale, { timeZone: zone, timeZoneName: 'longOffset' }).formatToParts(now).find(p => p.type === 'timeZoneName');
                    const type = typePart ? typePart.value : zone;

                    document.getElementById('convertedTime').innerHTML = `<div class="no-translate">${timeString} <span style="font-size:0.5em; opacity:0.7; display:block;">${dateString} • ${type}</span></div>`;
                } catch (e) {
                    console.error("Time calc error", e);
                }
            }

            // --- NEWS FEED ---
            // Redirects to dedicated Details page

            function triggerNewsSearch() {
                const val = document.getElementById('newsInput').value;
                if (!val) {
                    // Default to Global Technology if empty? Or do nothing?
                    // Requirement: "When the user searches..." implication is explicit action.
                    // But let's provide a default if they click empty search.
                    window.location.href = '/News/Details?query=Global%20Technology';
                    return;
                }

                // Treat comma as strict location signal
                let query = val;
                let fallback = '';

                if (val.includes(',')) {
                    // If "City, Country", pass both.
                    // details page logic uses fallbackQuery if query fails.
                    // But wait, the Details page expects "query" to be the main search.
                    // If I pass "Paris, France", logic there handles it.
                    // We can separate for fallback purposes.
                    fallback = val.split(',').pop().trim();
                }

                window.location.href = `/News/Details?query=${encodeURIComponent(query)}&fallbackQuery=${encodeURIComponent(fallback)}`;
            }

            // Removed fetchGlobalNews and related rendering logic as results are now shown on separate page.


            // --- NOTES SYSTEM ---
            let currentNotes = [];

            async function initNotes() {
                if (typeof ensureWidgetUnlocked === 'function') ensureWidgetUnlocked('notesBody');
                fetchNotes();
            }

            async function fetchNotes() {
                const container = document.getElementById('notesList');
                try {
                    const res = await fetch('/Notes/GetAll');
                    if (res.ok) {
                        const notes = await res.json();
                        renderNotes(notes);
                    } else {
                        if (container) {
                            container.innerHTML = `<div class="text-danger">Error loading notes</div>`;
                        }
                    }
                } catch (e) {
                    if (container) {
                        container.innerHTML = `<div class="text-danger">Connection Error</div>`;
                    }
                }
            }

            function renderNotes(notes) {
                currentNotes = notes;
                const container = document.getElementById('notesList');
                if (!container) return;
                container.innerHTML = '';

                if (notes.length === 0) {
                    container.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;">No Notes Found</div>`;
                    return;
                }

                notes.forEach(note => {
                    const locale = getCurrentLocale();
                    const date = new Date(note.createdDate).toLocaleDateString(locale, { year: 'numeric', month: 'short', day: 'numeric' });
                    const div = document.createElement('div');
                    div.className = 'note-item slide-in';
                    div.onclick = (e) => {
                        if (e.target.closest('.btn-note-action')) return;
                        editNote(note.id);
                    };
                    div.innerHTML = `
                                                                                                                                                                                                                                                                                    <div class="note-header">
                                                                                                                                                                                                                                                                                        <div class="note-title">${escapeHtml(note.title)}</div>
                                                                                                                                                                                                                                                                                        <div class="note-date">${date}</div>
                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                    <div class="note-desc">${escapeHtml(note.description)}</div>
                                                                                                                                                                                                                                                                                    <div class="note-actions">
                                                                                                                                                                                                                                                                                        <button class="btn-note-action" onclick="event.stopPropagation(); editNote(${note.id})"><i class="fas fa-edit"></i></button>
                                                                                                                                                                                                                                                                                        <button class="btn-note-action delete" onclick="event.stopPropagation(); deleteNote(${note.id})"><i class="fas fa-trash"></i></button>
                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                `;
                    container.appendChild(div);
                });
            }

            function escapeHtml(text) {
                if (!text) return '';
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function (m) { return map[m]; });
            }

            async function searchGlobalIntel() {
                const query = document.getElementById('globalSearchInput').value;
                if (!query) return;
                window.location.href = `/Home/CountryDetails?name=${encodeURIComponent(query)}`;
            }

            async function renderGlobalResult(loc, country) {
                const display = document.getElementById('globalSearchResult');

                // Safe currency access
                let currency = { name: 'N/A', symbol: '' };
                if (country && country.currencies) {
                    const keys = Object.keys(country.currencies);
                    if (keys.length > 0) currency = country.currencies[keys[0]];
                }

                // Await all translations independently
                const cityName = await window.translator.translateText(loc.name);
                const countryName = country ? await window.translator.translateText(country.name.common) : '';
                const region = country ? await window.translator.translateText(country.region) : '';
                const capital = (country && country.capital && country.capital.length > 0) ? await window.translator.translateText(country.capital[0]) : 'N/A';
                const currName = currency.name !== 'N/A' ? await window.translator.translateText(currency.name) : 'N/A';

                // Labels
                const l_coords = await window.translator.translateText('Coordinates');
                const l_timezone = await window.translator.translateText('Chronos Sync');
                const l_curr = await window.translator.translateText('Currency');
                const l_pop = await window.translator.translateText('Population');
                const l_cap = await window.translator.translateText('Capital');
                const l_reg = await window.translator.translateText('Region');

                // --- BUILD HTML SAFELY ---

                let html = '<div class="result-card slide-in" style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 20px; border: 1px solid var(--border-dim);">';

                // Header
                html += '<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 16px;">';
                html += '<div>';
                html += '<div style="font-size: 1.5rem; font-weight: 800; color: var(--text-bright);">' + cityName + '</div>';

                let subText = (loc.admin1 || '') + (country ? ', ' + countryName : '');
                html += '<div style="color: var(--text-muted); font-size: 0.9rem;">' + subText + '</div>';
                html += '</div>';

                if (country && country.flag) {
                    html += '<div style="font-size: 2.5rem; line-height: 1;">' + country.flag + '</div>';
                }
                html += '</div>'; // End Header

                // Stats
                html += '<div class="stats-deep" style="grid-template-columns: 1fr 1fr; margin-top: 8px;">';

                // Coords
                html += '<div class="stat-box" style="padding: 12px;">';
                html += '<label>' + l_coords + '</label>';
                html += '<b>' + loc.latitude.toFixed(2) + ', ' + loc.longitude.toFixed(2) + '</b>';
                html += '</div>';

                // Timezone
                html += '<div class="stat-box" style="padding: 12px;">';
                html += '<label>' + l_timezone + '</label>';
                html += '<b style="font-size: 1rem;">' + loc.timezone + '</b>';
                html += '</div>';

                html += '</div>'; // End Top Stats

                // Bottom Stats (Country only)
                if (country) {
                    const popM = (country.population / 1000000).toFixed(1) + 'M';

                    html += '<div class="stats-deep" style="grid-template-columns: 1fr 1fr; margin-top: 12px;">';

                    // Currency
                    html += '<div class="stat-box" style="padding: 12px;">';
                    html += '<label>' + l_curr + '</label>';
                    html += '<b>' + currency.symbol + ' ' + currName + '</b>';
                    html += '</div>';

                    // Pop
                    html += '<div class="stat-box" style="padding: 12px;">';
                    html += '<label>' + l_pop + '</label>';
                    html += '<b>' + popM + '</b>';
                    html += '</div>';

                    // Cap
                    html += '<div class="stat-box" style="padding: 12px;">';
                    html += '<label>' + l_cap + '</label>';
                    html += '<b>' + capital + '</b>';
                    html += '</div>';

                    // Reg
                    html += '<div class="stat-box" style="padding: 12px;">';
                    html += '<label>' + l_reg + '</label>';
                    html += '<b>' + region + '</b>';
                    html += '</div>';

                    html += '</div>';
                }

                // Sync Badge
                html += '<div style="margin-top:16px; text-align:center;">';
                html += '<span style="color:var(--accent-success); font-size:0.8rem; display:block; margin-bottom:8px;">';
                html += '<i class="fas fa-check-circle"></i> Dashboard Synced';
                html += '</span></div></div>';

                display.innerHTML = html;

                // Auto-Sync Dashboard
                syncDashboardToLocation(loc, country);
            }

            async function syncDashboardToLocation(loc, country) {
                // 1. Sync Weather
                if (loc.latitude && loc.longitude) {
                    fetchWeatherDeep(loc.latitude, loc.longitude, `${loc.name}, ${loc.country_code}`);
                }

                // 2. Sync Timezone
                if (loc.timezone) {
                    const tzSelect = document.getElementById('timezoneSelect');
                    let exists = false;
                    for (let i = 0; i < tzSelect.options.length; i++) {
                        if (tzSelect.options[i].value === loc.timezone) {
                            tzSelect.selectedIndex = i;
                            exists = true;
                            break;
                        }
                    }

                    // If not in list (rare given we load all), attempt to add it or find formatted match
                    if (!exists) {
                        // Try to find by raw value
                        const opt = document.createElement('option');
                        opt.value = loc.timezone;
                        opt.text = `${loc.name}, ${loc.country_code}`; // Fallback format
                        opt.selected = true;
                        tzSelect.add(opt);
                    }
                    updateConvertedTime();

                    // Highlight effect
                    const chronoCard = document.querySelector('.chrono-hub');
                    if (chronoCard) {
                        chronoCard.style.borderColor = 'var(--accent-indigo)';
                        setTimeout(() => chronoCard.style.borderColor = '', 1500);
                    }
                }

                // 3. Sync Currency
                if (country && country.currencies) {
                    const currencyCode = Object.keys(country.currencies)[0];
                    const tSelect = document.getElementById('toCurrency');

                    // Update Context
                    currencyContext = {
                        city: loc.name,
                        country: country.name.common,
                        currency: currencyCode,
                        timezone: loc.timezone
                    };

                    // Find matching option for country/currency
                    // We prioritize country match
                    let found = false;
                    for (let i = 0; i < tSelect.options.length; i++) {
                        const opt = tSelect.options[i];
                        if (opt.getAttribute('data-country') === country.name.common || opt.value.split('|')[0] === currencyCode) {
                            tSelect.selectedIndex = i;
                            found = true;
                            break;
                        }
                    }

                    if (found) {
                        convertCurrency();

                        // Highlight effect
                        const currencyCard = document.querySelector('.currency-hub');
                        if (currencyCard) {
                            currencyCard.style.borderColor = 'var(--accent-emerald)';
                            setTimeout(() => currencyCard.style.borderColor = '', 1500);
                        }
                    }
                }

                // 4. News Sync - DISABLED AUTO FETCH
                // User must manually trigger news search to save bandwidth/quota
                // const cityQuery = `"${loc.name}" "${country.name.common}"`;
                // const countryQuery = `"${country.name.common}"`;
                // fetchGlobalNews(cityQuery, countryQuery);
            }

            let isFormVisible = false;

            async function toggleNoteForm(forceState) {
                const form = document.getElementById('noteFormArea');
                const btn = document.getElementById('btnNewNote');

                if (typeof forceState !== 'undefined') {
                    isFormVisible = forceState;
                } else {
                    isFormVisible = !isFormVisible;
                }

                if (isFormVisible) {
                    form.style.display = 'block';
                    btn.style.display = 'none';

                    if (!document.getElementById('noteId').value) {
                        document.getElementById('noteTitle').value = '';
                        document.getElementById('noteDesc').value = '';
                        const newNoteTitle = await window.translator.translateText('New Note');
                        document.getElementById('formTitle').innerText = newNoteTitle;
                        document.getElementById('formTitle').setAttribute('data-i18n', 'NewNote');
                    }
                } else {
                    form.style.display = 'none';
                    btn.style.display = 'block';
                    document.getElementById('noteId').value = '';
                }
            }

            async function editNote(id) {
                const note = currentNotes.find(n => n.id === id);
                if (!note) return;

                document.getElementById('noteId').value = id;
                document.getElementById('noteTitle').value = note.title;
                document.getElementById('noteDesc').value = note.description;
                const editTitle = await window.translator.translateText('Edit Note');
                document.getElementById('formTitle').innerText = editTitle;
                document.getElementById('formTitle').setAttribute('data-i18n', 'EditNote');

                toggleNoteForm(true);
            }

            async function saveNote() {
                const title = document.getElementById('noteTitle').value;
                const desc = document.getElementById('noteDesc').value;
                const id = document.getElementById('noteId').value;

                if (!title || !desc) {
                    alert(await window.translator.translateText('Please fill all fields'));
                    return;
                }

                const url = id ? '/Notes/Update' : '/Notes/Create';
                const body = { title: title, description: desc };
                if (id) body.id = parseInt(id);

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (res.ok) {
                        toggleNoteForm(false);
                        fetchNotes();
                    } else {
                        const errSave = await window.translator.translateText('Error saving note');
                        alert(errSave);
                    }
                } catch (e) {
                    const errSave = await window.translator.translateText('Error saving note');
                    alert(errSave);
                }
            }

            async function deleteNote(id) {
                const confirmText = await window.translator.translateText('Are you sure you want to delete this note?');
                if (!confirm(confirmText)) return;
                try {
                    const res = await fetch('/Notes/Delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(id)
                    });
                    if (res.ok) {
                        fetchNotes();
                    } else {
                        alert(await window.translator.translateText('Error deleting note'));
                    }
                } catch (e) {
                    console.error(e);
                    alert(await window.translator.translateText('Error deleting note'));
                }
            }




            // --- EMERGENCY CONTACTS ---
            let lastEmergencyCode = null;

            function handleEmergencySearch() {
                const input = document.getElementById('emergencyInput');
                const val = input.value.trim().toLowerCase();
                const dropdown = document.getElementById('emergencyDropdown');

                if (val.length < 1) {
                    dropdown.style.display = 'none';
                    return;
                }

                // 1. Filter Matches
                const matches = emergencyCountryList.filter(c =>
                    c.name.toLowerCase().startsWith(val) ||
                    c.name.toLowerCase().includes(val)
                );

                // 2. Sort Matches
                matches.sort((a, b) => {
                    const aName = a.name.toLowerCase();
                    const bName = b.name.toLowerCase();
                    if (aName === val) return -1;
                    if (bName === val) return 1;
                    if (aName.startsWith(val) && !bName.startsWith(val)) return -1;
                    if (!aName.startsWith(val) && bName.startsWith(val)) return 1;
                    return aName.localeCompare(bName);
                });

                // 3. Render Dropdown
                if (matches.length > 0) {
                    dropdown.innerHTML = '';
                    matches.slice(0, 8).forEach(match => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';

                        const safeVal = val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(`(${safeVal})`, 'gi');
                        const highlighted = match.name.replace(regex, '<span style="color:var(--accent-sky); font-weight:700;">$1</span>');

                        let displayMeta = "";
                        if (match.type === 'country') {
                            displayMeta = `<span style="opacity:0.6; font-size:0.8em; margin-left:6px;">(${match.official})</span>`;
                        } else {
                            displayMeta = `<span style="opacity:0.6; font-size:0.8em; margin-left:6px;">(${match.parent || match.official})</span>`;
                        }

                        div.innerHTML = `
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span style="font-family:monospace; font-weight:700; color:var(--accent-emerald); background:rgba(52,211,153,0.1); padding:2px 6px; border-radius:4px; font-size:0.8em;">${match.code}</span>
                                    <div style="display:flex; flex-direction:column; justify-content:center;">
                                        <div style="line-height:1.2;">${highlighted} ${displayMeta}</div>
                                        ${match.type === 'city' ? `<span style="font-size:0.7em; opacity:0.5; margin-top:2px;">City</span>` : ''}
                                    </div>
                                </div>`;

                        div.onclick = () => selectEmergencyCountry(match);
                        dropdown.appendChild(div);
                    });
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            }

            function selectEmergencyCountry(country) {
                const input = document.getElementById('emergencyInput');
                const dropdown = document.getElementById('emergencyDropdown');
                const container = document.getElementById('emergencyResult');

                input.value = country.name;
                dropdown.style.display = 'none';
                container.innerHTML = '';
                lastEmergencyCode = null;

                const normalizedCode = (country.code || '').trim().toUpperCase();

                if (normalizedCode) {
                    fetchEmergencyNumbers(normalizedCode, country.name);
                } else {
                    container.innerHTML = `<div class="empty-state"><i class="fas fa-circle-exclamation" style="color:var(--accent-warning)"></i><p>Emergency data unavailable for <b>${country.name}</b></p></div>`;
                }
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                const dropdown = document.getElementById('emergencyDropdown');
                const input = document.getElementById('emergencyInput');
                if (dropdown && input) {
                    if (!dropdown.contains(e.target) && e.target !== input) {
                        dropdown.style.display = 'none';
                    }
                }
            });

            async function fetchEmergencyNumbers(code, countryName) {
                const container = document.getElementById('emergencyResult');
                container.innerHTML = `<div class="loading-state" style="text-align:center; padding:40px;"><i class="fas fa-circle-notch fa-spin" style="font-size:2rem; color:var(--accent-sky); margin-bottom:10px;"></i><div style="opacity:0.7">Accessing Global Grid...</div></div>`;

                try {
                    const safeCode = code.trim().toUpperCase();
                    const res = await fetch(`/Emergency/GetNumbers?code=${safeCode}`);
                    if (!res.ok) throw new Error("API Failure");
                    const data = await res.json();
                    if (!data || !data.data) throw new Error("No data");
                    renderEmergency(data.data, countryName);
                } catch (e) {
                    console.error(e);
                    container.innerHTML = `<div class="empty-state"><i class="fas fa-triangle-exclamation" style="color:#ef4444"></i><p>Emergency Protocols Not Found for <b>${countryName}</b></p></div>`;
                }
            }

            function renderEmergency(d, countryName) {
                const container = document.getElementById('emergencyResult');
                let nums = {
                    dispatch: d.dispatch && d.dispatch.all ? d.dispatch.all : [],
                    police: d.police && d.police.all ? d.police.all : [],
                    ambulance: d.ambulance && d.ambulance.all ? d.ambulance.all : [],
                    fire: d.fire && d.fire.all ? d.fire.all : []
                };
                
                // Fallback to Dispatch
                if (nums.dispatch.length > 0) {
                    if (nums.police.length === 0) nums.police = nums.dispatch;
                    if (nums.ambulance.length === 0) nums.ambulance = nums.dispatch;
                    if (nums.fire.length === 0) nums.fire = nums.dispatch;
                }

                let html = `<div style="margin-bottom:12px; font-weight:700; color:var(--text-bright); font-size:1.1rem;"><i class="fas fa-flag" style="margin-right:8px; color:var(--text-muted);"></i> ${countryName}</div><div class="emergency-cards">`;
                
                const createCard = (label, icon, arr, colorClass) => {
                    if (!arr || arr.length === 0) return '';
                    const mainNum = arr[0];
                    return `<div class="emergency-number-card ${colorClass}">
                                <div class="card-icon-wrapper"><i class="fas ${icon}"></i></div>
                                <div class="em-info"><span class="em-label">${label}</span><span class="em-number">${arr.join(' / ')}</span></div>
                                <div style="display:flex; gap:6px;">
                                    <a href="tel:${mainNum}" class="copy-btn" title="Call Now" style="text-decoration:none; display:flex; align-items:center; justify-content:center; color:var(--accent-emerald); background:rgba(52, 211, 153, 0.1);"><i class="fas fa-phone"></i></a>
                                    <button class="copy-btn" onclick="navigator.clipboard.writeText('${mainNum}')" title="Copy"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>`;
                };

                if (nums.dispatch && nums.dispatch.length > 0) html += createCard('Unified / GSM', 'fa-tower-broadcast', nums.dispatch, 'unified-card');
                if (nums.police && nums.police.length > 0) html += createCard('Police', 'fa-shield-halved', nums.police, '');
                if (nums.ambulance && nums.ambulance.length > 0) html += createCard('Ambulance', 'fa-truck-medical', nums.ambulance, '');
                if (nums.fire && nums.fire.length > 0) html += createCard('Fire Dept', 'fa-fire-extinguisher', nums.fire, '');
                html += `</div>`;
                container.innerHTML = html;
            }

            // --- TRANSLATOR WIDGET LOGIC ---
            const translationLanguages = [
                {code: "af", name: "Afrikaans"}, {code: "sq", name: "Albanian"}, {code: "am", name: "Amharic"}, {code: "ar", name: "Arabic"},
                {code: "hy", name: "Armenian"}, {code: "az", name: "Azerbaijani"}, {code: "eu", name: "Basque"}, {code: "be", name: "Belarusian"},
                {code: "bn", name: "Bengali"}, {code: "bs", name: "Bosnian"}, {code: "bg", name: "Bulgarian"}, {code: "ca", name: "Catalan"},
                {code: "ceb", name: "Cebuano"}, {code: "ny", name: "Chichewa"}, {code: "zh-CN", name: "Chinese (Simplified)"}, {code: "zh-TW", name: "Chinese (Traditional)"},
                {code: "co", name: "Corsican"}, {code: "hr", name: "Croatian"}, {code: "cs", name: "Czech"}, {code: "da", name: "Danish"},
                {code: "nl", name: "Dutch"}, {code: "en", name: "English"}, {code: "eo", name: "Esperanto"}, {code: "et", name: "Estonian"},
                {code: "tl", name: "Filipino"}, {code: "fi", name: "Finnish"}, {code: "fr", name: "French"}, {code: "fy", name: "Frisian"},
                {code: "gl", name: "Galician"}, {code: "ka", name: "Georgian"}, {code: "de", name: "German"}, {code: "el", name: "Greek"},
                {code: "gu", name: "Gujarati"}, {code: "ht", name: "Haitian Creole"}, {code: "ha", name: "Hausa"}, {code: "haw", name: "Hawaiian"},
                {code: "iw", name: "Hebrew"}, {code: "hi", name: "Hindi"}, {code: "hmn", name: "Hmong"}, {code: "hu", name: "Hungarian"},
                {code: "is", name: "Icelandic"}, {code: "ig", name: "Igbo"}, {code: "id", name: "Indonesian"}, {code: "ga", name: "Irish"},
                {code: "it", name: "Italian"}, {code: "ja", name: "Japanese"}, {code: "jw", name: "Javanese"}, {code: "kn", name: "Kannada"},
                {code: "kk", name: "Kazakh"}, {code: "km", name: "Khmer"}, {code: "ko", name: "Korean"}, {code: "ku", name: "Kurdish (Kurmanji)"},
                {code: "ky", name: "Kyrgyz"}, {code: "lo", name: "Lao"}, {code: "la", name: "Latin"}, {code: "lv", name: "Latvian"},
                {code: "lt", name: "Lithuanian"}, {code: "lb", name: "Luxembourgish"}, {code: "mk", name: "Macedonian"}, {code: "mg", name: "Malagasy"},
                {code: "ms", name: "Malay"}, {code: "ml", name: "Malayalam"}, {code: "mt", name: "Maltese"}, {code: "mi", name: "Maori"},
                {code: "mr", name: "Marathi"}, {code: "mn", name: "Mongolian"}, {code: "my", name: "Myanmar (Burmese)"}, {code: "ne", name: "Nepali"},
                {code: "no", name: "Norwegian"}, {code: "ps", name: "Pashto"}, {code: "fa", name: "Persian"}, {code: "pl", name: "Polish"},
                {code: "pt", name: "Portuguese"}, {code: "pa", name: "Punjabi"}, {code: "ro", name: "Romanian"}, {code: "ru", name: "Russian"},
                {code: "sm", name: "Samoan"}, {code: "gd", name: "Scots Gaelic"}, {code: "sr", name: "Serbian"}, {code: "st", name: "Sesotho"},
                {code: "sn", name: "Shona"}, {code: "sd", name: "Sindhi"}, {code: "si", name: "Sinhala"}, {code: "sk", name: "Slovak"},
                {code: "sl", name: "Slovenian"}, {code: "so", name: "Somali"}, {code: "es", name: "Spanish"}, {code: "su", name: "Sundanese"},
                {code: "sw", name: "Swahili"}, {code: "sv", name: "Swedish"}, {code: "tg", name: "Tajik"}, {code: "ta", name: "Tamil"},
                {code: "te", name: "Telugu"}, {code: "th", name: "Thai"}, {code: "tr", name: "Turkish"}, {code: "uk", name: "Ukrainian"},
                {code: "ur", name: "Urdu"}, {code: "uz", name: "Uzbek"}, {code: "vi", name: "Vietnamese"}, {code: "cy", name: "Welsh"},
                {code: "xh", name: "Xhosa"}, {code: "yi", name: "Yiddish"}, {code: "yo", name: "Yoruba"}, {code: "zu", name: "Zulu"}
            ];

            let debounceTimer = null;

            function initTranslatorWidget() {
                const src = document.getElementById('transSourceLang');
                const tgt = document.getElementById('transTargetLang');
                if(!src || !tgt) return;

                translationLanguages.forEach(l => {
                    const op1 = document.createElement('option');
                    op1.value = l.code;
                    op1.text = l.name;
                    if(l.code === 'en') op1.selected = true; 
                    src.appendChild(op1);

                    const op2 = document.createElement('option');
                    op2.value = l.code;
                    op2.text = l.name;
                    if(l.code === 'es') op2.selected = true; 
                    tgt.appendChild(op2);
                });
                
                src.value = 'auto'; // Force Default
                tgt.value = 'es';
            }

            function debounceTranslate() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(translateWidget, 800);
            }

            async function translateWidget() {
                const input = document.getElementById('transInput').value.trim();
                const srcLang = document.getElementById('transSourceLang').value;
                const tgtLang = document.getElementById('transTargetLang').value;
                const output = document.getElementById('transOutput');

                if (!input) {
                    output.value = '';
                    return;
                }

                if(srcLang === tgtLang) {
                    output.value = input;
                    return;
                }

                output.setAttribute('placeholder', 'Translating...');
                
                try {
                    const res = await fetch('/api/Translation/translate-batch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            Texts: [input],
                            TargetLanguage: tgtLang,
                            SourceLanguage: srcLang === 'auto' ? null : srcLang
                        })
                    });

                    if (!res.ok) throw new Error("Translation Failed");
                    const result = await res.json();
                    const translatedText = result[input] || result[Object.keys(result)[0]]; 

                    output.value = translatedText;
                    // Auto-resize for very long text?
                    
                } catch (e) {
                    console.error(e);
                    output.value = "Error: Could not translate.";
                } finally {
                     output.setAttribute('placeholder', 'Translation...');
                }
            }

            function swapLanguages() {
                const src = document.getElementById('transSourceLang');
                const tgt = document.getElementById('transTargetLang');
                const input = document.getElementById('transInput');
                const output = document.getElementById('transOutput');
                
                // Swap Values
                const tempLang = src.value;
                src.value = tgt.value;
                tgt.value = (tempLang === 'auto') ? 'en' : tempLang; 
                
                // Swap Text (if output has content)
                if (output.value && output.value !== "Error: Could not translate.") {
                    input.value = output.value;
                    translateWidget(); // Trigger translation of the new input
                }
            }

            function copyTranslation() {
                const output = document.getElementById('transOutput');
                if (output && output.value) {
                    output.select();
                    navigator.clipboard.writeText(output.value);
                    
                    const btn = document.getElementById('btnCopyTrans');
                    const icon = btn.querySelector('i');
                    if(icon) {
                        icon.className = 'fas fa-check';
                        icon.style.color = 'var(--accent-emerald)';
                        setTimeout(() => {
                            icon.className = 'fas fa-copy';
                            icon.style.color = '';
                        }, 2000);
                    }
                }
            }
            
            // Add init to ready
            document.addEventListener('DOMContentLoaded', initTranslatorWidget);



            // --- HABIT TRACKER LOGIC ---
            let habits = [];
            let editingHabitId = null;

            async function initHabits() {
                if (typeof ensureWidgetUnlocked === 'function') ensureWidgetUnlocked('habitBody');
                try {
                    const res = await fetch('/Habit/GetHabits');
                    if (res.status === 401) return; // Not logged in
                    if (res.ok) {
                        habits = await res.json();
                        renderHabits();
                    }
                } catch (e) {
                    console.error("Failed to load habits", e);
                }
            }

            function toggleCustomDaysInput() {
                const type = document.getElementById('newHabitType').value;
                const section = document.getElementById('customDaysInput');
                section.style.display = type === 'Custom' ? 'block' : 'none';
            }

            function renderHabits() {
                const list = document.getElementById('habitList');
                if (!habits || habits.length === 0) {
                    list.innerHTML = `<div class="empty-state">
                                            <i class="fas fa-seedling" style="color:var(--accent-green)"></i>
                                            <p>Start building good habits!</p>
                                          </div>`;
                    updateDailyProgress(0, 0);
                    return;
                }

                // Normalizing Date Logic
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.getFullYear() + '-' +
                    String(today.getMonth() + 1).padStart(2, '0') + '-' +
                    String(today.getDate()).padStart(2, '0');

                const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                const todayName = dayNames[today.getDay()];

                list.innerHTML = '';

                let totalActiveToday = 0;
                let completedToday = 0;

                habits.forEach(h => {
                    // Start Date Check
                    const startRaw = new Date(h.startDate);
                    startRaw.setHours(0, 0, 0, 0);
                    
                    // Logic: If today < startDate, hide completely or show as locked
                    if (today < startRaw) return;

                    // Custom Day Check
                    let isActiveDay = true;
                    if (h.frequencyType === 'Custom' && h.customDays && h.customDays.length > 0) {
                        if (!h.customDays.includes(todayName)) {
                            isActiveDay = false;
                        }
                    }

                    // Completion Check
                    // Server returns completedDates as full ISO strings usually. We match Prefix YYYY-MM-DD
                    const isDoneToday = h.completedDates.some(d => d.startsWith(todayStr));

                    if (isActiveDay) {
                        totalActiveToday++;
                        if (isDoneToday) completedToday++;
                    }

                    const div = document.createElement('div');
                    div.className = `habit-item ${isDoneToday ? 'completed' : ''}`;
                    if (!isActiveDay) {
                        div.style.opacity = '0.4';
                        div.style.filter = 'grayscale(100%)';
                    }

                    div.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="display:flex; align-items:center; gap:12px; flex:1;">
                                    <div class="custom-checkbox ${isDoneToday ? 'checked' : ''}" 
                                         onclick="${isActiveDay ? `toggleHabit('${h.id}')` : ''}" 
                                         style="${!isActiveDay ? 'cursor:not-allowed; border-color:rgba(255,255,255,0.1);' : 'cursor:pointer;'}">
                                        ${isDoneToday ? '<i class="fas fa-check"></i>' : (isActiveDay ? '' : '<i class="fas fa-minus" style="font-size:0.6rem; opacity:0.3;"></i>')}
                                    </div>
                                    <div style="flex:1;">
                                        <div class="habit-name">${escapeHtml(h.name)}</div>
                                        <div class="habit-meta">
                                            <span class="badge badge-daily">${h.frequencyType}</span> 
                                            ${h.goal ? `<span style="margin-left:8px; display:inline-flex; align-items:center; opacity:0.7; font-size:0.75rem;"><i class="fas fa-bullseye" style="margin-right:4px;"></i> ${escapeHtml(h.goal)}</span>` : ''}
                                            ${!isActiveDay ? '<span style="margin-left:8px; font-size:0.7rem; color:var(--text-muted);">Rest Day</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:4px;">
                                     <button class="icon-btn edit-habit-btn" onclick="editHabit('${h.id}')" title="Edit"><i class="fas fa-pen"></i></button>
                                     <button class="icon-btn delete-habit-btn" onclick="deleteHabit('${h.id}')" title="Delete"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        `;
                    list.appendChild(div);
                });

                updateDailyProgress(completedToday, totalActiveToday);
            }

            function updateDailyProgress(done, total) {
                const el = document.getElementById('dailyProgress');
                if (el) {
                    el.innerText = total > 0 ? `Today: ${done}/${total}` : '';
                }
            }

            function toggleAddHabitForm(reset = true) {
                const form = document.getElementById('addHabitForm');
                const btn = document.getElementById('showAddHabitBtn');
                const submitBtn = form.querySelector('.btn-primary'); // The create/save button

                if (form.style.display === 'none') {
                    form.style.display = 'block';
                    btn.style.display = 'none';
                    document.getElementById('newHabitName').focus();
                    
                    if(reset) {
                         editingHabitId = null;
                         submitBtn.innerText = "Create"; 
                         document.getElementById('newHabitName').value = '';
                         document.getElementById('newHabitGoal').value = '';
                         document.getElementById('newHabitType').value = 'Daily';
                         toggleCustomDaysInput(); // hide custom days
                         // Clear checkboxes
                         document.querySelectorAll('#customDaysInput input').forEach(cb => cb.checked = false);
                         
                         // Default Date to Today
                         const today = new Date().toISOString().split('T')[0];
                         document.getElementById('newHabitStartDate').value = today;
                    }
                } else {
                    form.style.display = 'none';
                    btn.style.display = 'block';
                    if(reset) editingHabitId = null;
                }
            }
            
            function editHabit(id) {
                const h = habits.find(x => x.id === id);
                if (!h) return;
                
                // Open form without resetting
                toggleAddHabitForm(false);
                editingHabitId = id;
                
                // Populate fields
                document.getElementById('newHabitName').value = h.name;
                document.getElementById('newHabitGoal').value = h.goal || '';
                document.getElementById('newHabitType').value = h.frequencyType;
                
                // Formulate Start Date (h.startDate is ISO)
                if(h.startDate) {
                    const d = new Date(h.startDate);
                    const iso = d.toISOString().split('T')[0];
                    document.getElementById('newHabitStartDate').value = iso;
                }
                
                toggleCustomDaysInput();
                
                // Checkboxes
                const cbs = document.querySelectorAll('#customDaysInput input');
                cbs.forEach(cb => cb.checked = false); // clear all first
                
                if (h.frequencyType === 'Custom' && h.customDays) {
                    h.customDays.forEach(day => {
                        const cb = Array.from(cbs).find(input => input.value === day);
                        if(cb) cb.checked = true;
                    });
                }
                
                // Set Button Text
                const form = document.getElementById('addHabitForm');
                const submitBtn = form.querySelector('.btn-primary');
                submitBtn.innerText = "Update";
                
                // Scroll to form
                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            async function saveNewHabit() {
                const name = document.getElementById('newHabitName').value.trim();
                const goal = document.getElementById('newHabitGoal').value.trim();
                const type = document.getElementById('newHabitType').value;
                const startDate = document.getElementById('newHabitStartDate').value;
                
                if (!name) return;
                if (!startDate) { alert("Please select a start date"); return; }

                // Gather Custom Days
                let customDays = [];
                if (type === 'Custom') {
                    const checkboxes = document.querySelectorAll('#customDaysInput input:checked');
                    checkboxes.forEach(cb => customDays.push(cb.value));
                    if(customDays.length === 0) {
                        alert("Please select at least one day for Custom Frequency.");
                        return;
                    }
                }

                const payload = {
                    Id: editingHabitId, // Include ID if editing
                    Name: name,
                    Goal: goal,
                    FrequencyType: type,
                    StartDate: startDate,
                    CustomDays: customDays
                };

                try {
                    const url = editingHabitId ? '/Habit/Update' : '/Habit/Create';
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        toggleAddHabitForm(true);
                        initHabits();
                    } else {
                        alert("Failed to save habit.");
                    }
                } catch(e) { console.error(e); }
            }

            async function toggleHabit(id) {
                const now = new Date(); // Local time
                // Send ISO string in UTC or just send local time components if backend needs to be strict?
                // Backend treats Date as Date only (uses .Date).
                // Ensure we send a valid JSON ISO string.
                
                try {
                    const res = await fetch('/Habit/Toggle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ HabitId: id, Date: now.toISOString() })
                    });
                    if (res.ok) {
                        // Optimistic update or refresh
                        initHabits();
                    }
                } catch(e) { console.error(e); }
            }

            async function deleteHabit(id) {
                if (confirm('Delete this habit?')) {
                     try {
                        const res = await fetch('/Habit/Delete?id=' + id, { method: 'POST' });
                        if(res.ok) initHabits();
                    } catch(e) { console.error(e); }
                }
            }

            // --- HABIT VAULT LOGIC ---
            function openHabitVault() {
                const modal = document.getElementById('habitVaultModal');
                const list = document.getElementById('habitVaultList');
                const count = document.getElementById('vaultCount');
                
                modal.style.display = 'flex';
                count.innerText = habits.length;
                list.innerHTML = '';

                if (habits.length === 0) {
                    list.innerHTML = '<div class="empty-state" style="padding:40px;"><i class="fas fa-box-open" style="font-size:2rem; opacity:0.5;"></i><p>No habits stored in the vault.</p></div>';
                    return;
                }

                const today = new Date();
                const todayStr = today.getFullYear() + '-' +
                    String(today.getMonth() + 1).padStart(2, '0') + '-' +
                    String(today.getDate()).padStart(2, '0');

                habits.forEach(h => {
                    const isDoneToday = h.completedDates.some(d => d.startsWith(todayStr));
                    
                    const item = document.createElement('div');
                    item.className = 'vault-item';
                    
                    // Left Side
                    const left = document.createElement('div');
                    
                    const title = document.createElement('div');
                    title.style.fontWeight = '600';
                    title.style.color = 'var(--text-bright)';
                    title.style.fontSize = '1rem';
                    title.textContent = h.name;
                    
                    const meta = document.createElement('div');
                    meta.className = 'vault-meta';
                    
                    // Time Ago Logic
                    const created = new Date(h.createdDate);
                    const diffTime = Math.abs(today - created);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
                    const timeLabel = diffDays < 1 ? "Added today" : `Added ${diffDays} days ago`;
                    
                    meta.textContent = `${h.frequencyType} • ${timeLabel}`;
                    
                    left.appendChild(title);
                    left.appendChild(meta);
                    
                    // Right Side
                    const right = document.createElement('div');
                    right.style.textAlign = 'right';
                    
                    if(isDoneToday) {
                        right.innerHTML = '<span style="color:var(--accent-emerald); font-weight:700; font-size:0.75rem;"><i class="fas fa-check"></i> Completed</span>';
                    } else {
                        right.innerHTML = '<span style="color:var(--text-muted); font-size:0.75rem;"><i class="fas fa-clock"></i> Pending</span>';
                    }
                    
                    item.appendChild(left);
                    item.appendChild(right);
                    list.appendChild(item);
                });
            }

            function closeHabitVault() {
                document.getElementById('habitVaultModal').style.display = 'none';
            }



            const widgetContentCache = {};

            function ensureWidgetUnlocked(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    if (widgetContentCache[containerId]) {
                        container.innerHTML = widgetContentCache[containerId];
                    } else {
                        const template = document.getElementById(containerId + 'Template');
                        if (template) {
                            container.innerHTML = template.innerHTML;
                            widgetContentCache[containerId] = template.innerHTML;
                        }
                    }
                }
            }

            function renderLockedState(containerId, actionName, hasPin = true) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                // If not already cached, try to cache from template if it exists
                if (!widgetContentCache[containerId]) {
                    const template = document.getElementById(containerId + 'Template');
                    if (template) {
                        widgetContentCache[containerId] = template.innerHTML;
                    } else {
                        // Fallback: capture current innerHTML (only if it doesn't look like locked-state already)
                        if (!container.querySelector('.locked-state')) {
                            widgetContentCache[containerId] = container.innerHTML;
                        }
                    }
                }
                
                const message = hasPin ? "Security Verification Required" : "Security PIN not configured";
                const buttonHtml = hasPin ? `
                    <button onclick="secureAccess('${actionName}')" class="btn-primary" style="padding:10px 24px; font-size:0.9rem; border-radius:10px; width:auto;">
                        <i class="fas fa-key"></i> Unlock Module
                    </button>` : `
                    <div style="background:rgba(239, 68, 68, 0.1); border:1px solid var(--accent-danger); border-radius:10px; padding:10px 20px; color:var(--accent-danger); font-size:0.85rem;">
                        <i class="fas fa-exclamation-triangle"></i> Contact Admin to enable access
                    </div>`;

                container.innerHTML = `
                    <div class="locked-state" style="padding:40px; text-align:center; background:rgba(0,0,0,0.2); border-radius:16px; border:1px dashed var(--border-dim); height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                        <i class="fas ${hasPin ? 'fa-lock' : 'fa-user-lock'}" style="font-size:2.5rem; color:${hasPin ? 'var(--accent-warning)' : 'var(--accent-danger)'}; margin-bottom:15px; display:block;"></i>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">${message}</p>
                        ${buttonHtml}
                    </div>
                `;
            }

            $(document).ready(function () {

                // 1. Critical Base Systems (Clock, basic UI)
                if (typeof runChronos === 'function') {
                    runChronos();
                    setInterval(runChronos, 1000);
                }

                // 2. Data Initialization (Fail-safe wrapper)
                try { initNodeDirectory(); } catch (e) { console.error('NodeDir failed:', e); }
                try { initFiscal(); } catch (e) { console.error('Fiscal failed:', e); }

                // Protected Initialization - ALWAYS Locked by default for Notes, Habits, PDF History
                // This call verifies IF they already unlocked it (unlikely on fresh load as per requirement)
                syncSecurityState().then(status => {
                    if (status.isVerified) {
                        try { initNotes(); } catch (e) { console.error('Notes failed:', e); }
                        try { initHabits(); } catch (e) { console.error('Habits failed:', e); }
                        try { initPdfHistory(); } catch (e) { console.error('PDF History failed:', e); }
                    } else {
                        // Ensure properly rendered in case Razor didn't (e.g. Admin or legacy edge cases)
                        // But mostly Razor handles it now for immediate appearance.
                        renderLockedState('notesBody', 'initNotes', status.hasPin);
                        renderLockedState('habitBody', 'initHabits', status.hasPin);
                        renderLockedState('pdfBody', 'initPdfHistory', status.hasPin);
                    }
                });

                // Re-bind events to ensure interactivity persists
                const fC = document.getElementById('fromCurrency');
                const tC = document.getElementById('toCurrency');
                const aI = document.getElementById('amountInput');
                if (fC) fC.onchange = fetchLatestRates;
                if (tC) tC.onchange = convertCurrency;
                if (aI) aI.oninput = convertCurrency;
                
                // Ensure all search inputs are explicitly cleared on load to prevent browser autofill
                ['emergencyInput', 'globalSearchInput', 'cityInput', 'newsInput'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.value = '';
                        el.setAttribute('autocomplete', 'new-password');
                    }
                });

                // Initialize SMART GOALS
                initGoals();
            });
            $(document).on('languageChanged', function (e, lang) {
                console.log('Dashboard detected language change:', lang);
                runChronos();
                renderNodes(allNodes);
                initFiscal(true);
                fetchNotes();
                initGoals(); // Initialize Goals on load
            });

            // --- SMART GOAL TRACKER LOGIC ---
            let allGoals = [];
            let selectedGoalId = null;
            let currentTab = 'strategy';

            async function initGoals() {
                try {
                    const res = await fetch('/Goal/GetGoals');
                    if (res.ok) {
                        allGoals = await res.json();
                        renderGoalList();
                        renderTodayTasks();
                        updateGoalAnalytics();
                    }
                } catch (e) { console.error('Goals failed:', e); }
            }

            async function updateGoalAnalytics() {
                try {
                    const res = await fetch('/Goal/GetAnalytics');
                    if (res.ok) {
                        const data = await res.json();
                        document.getElementById('prodScore').innerText = data.score;
                        document.getElementById('activeGoalsCount').innerText = data.active;
                        document.getElementById('successRatio').innerText = data.successRatio;
                        document.getElementById('weeklyPerf').innerText = data.weeklyPerformance;
                    }
                } catch (e) { console.error('Goal Analytics failed:', e); }
            }

            function renderGoalList() {
                const container = document.getElementById('goalListContainer');
                if (!container) return;

                if (allGoals.length === 0) {
                    container.innerHTML = `<div style="padding: 30px; text-align: center; opacity: 0.6;"><i class="fas fa-bullseye" style="font-size: 2rem; margin-bottom: 10px;"></i><p>No active goals</p></div>`;
                    return;
                }

                container.innerHTML = allGoals.map(g => {
                    const statusColor = g.status === 'Completed' ? 'var(--accent-success)' : 
                                      (g.status === 'Overdue' ? 'var(--accent-danger)' : 'var(--accent-primary)');
                    const scheduleColor = g.scheduleStatus === 'Completed' ? 'var(--accent-success)' : 'var(--accent-primary)';

                    const deadline = new Date(g.endDate).toLocaleDateString();
                    const remainingDays = Math.ceil((new Date(g.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                    const remainingText = remainingDays > 0 ? `${remainingDays}d left` : (remainingDays === 0 ? 'Due today' : 'Overdue');

                    return `
                        <div class="goal-item-card" onclick="viewGoalDetails('${g.id}')" style="background:rgba(255,255,255,0.03); border:1px solid var(--border-dim); border-radius:12px; padding:12px; cursor:pointer; transition:all 0.3s ease; position:relative; overflow:hidden;">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                                <div>
                                    <h4 style="margin:0; font-size:0.95rem; color:var(--text-bright);">${g.title}</h4>
                                    <div style="display:flex; gap:8px; align-items:center; margin-top:2px;">
                                        <span style="font-size:0.7rem; color:var(--text-muted);">${g.category}</span>
                                        <span style="font-size:0.65rem; color:${scheduleColor}; text-transform:uppercase; font-weight:700;">• ${g.scheduleStatus}</span>
                                    </div>
                                </div>
                                <span class="badge" style="background:${statusColor}20; color:${statusColor}; font-size:0.7rem; border:1px solid ${statusColor}40;">${g.status}</span>
                            </div>
                            <div class="goal-progress-mini" style="margin-bottom:8px;">
                                <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:var(--text-dim); margin-bottom:4px;">
                                    <span>Progress</span>
                                    <span>${Math.round(g.progress)}%</span>
                                </div>
                                <div style="height:6px; background:rgba(0,0,0,0.2); border-radius:3px; overflow:hidden;">
                                    <div style="height:100%; width:${g.progress}%; background:${statusColor}; transition:width 0.5s ease;"></div>
                                </div>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.7rem; color:var(--text-muted);">
                                <span><i class="far fa-calendar"></i> ${deadline}</span>
                                <span style="color:${remainingDays <= 2 ? 'var(--accent-warning)' : 'inherit'}">${remainingText}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function renderTodayTasks() {
                const container = document.getElementById('todayTasksContainer');
                const listSection = document.getElementById('todayTaskList');
                if (!container || !listSection) return;

                const now = new Date();
                const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                let todayTasks = [];

                allGoals.forEach(g => {
                    const tasks = g.dailyTasks.filter(t => t.date.split('T')[0] === today);
                    tasks.forEach(t => todayTasks.push({ goalId: g.id, goalTitle: g.title, ...t }));
                });

                if (todayTasks.length === 0) {
                    listSection.style.display = 'none';
                    return;
                }

                listSection.style.display = 'block';
                const completedCount = todayTasks.filter(t => t.isCompleted).length;
                const progress = Math.round((completedCount / todayTasks.length) * 100);
                document.getElementById('todayProgress').innerText = `${progress}% Done Today`;

                container.innerHTML = todayTasks.map(t => `
                    <div class="daily-task-item" style="padding:10px; background:rgba(255,255,255,0.04); border:1px solid var(--border-dim); border-radius:10px; display:flex; align-items:center; gap:12px; cursor:default;">
                        <div onclick="toggleDailyTask('${t.goalId}', '${t.id}', ${!t.isCompleted})" style="width:20px; height:20px; border-radius:6px; border:2px solid ${t.isCompleted ? 'var(--accent-success)' : 'var(--border-dim)'}; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--accent-success);">
                            ${t.isCompleted ? '<i class="fas fa-check" style="font-size:0.75rem;"></i>' : ''}
                        </div>
                        <div style="flex:1; overflow:hidden;">
                            <div style="font-size:0.8rem; color:${t.isCompleted ? 'var(--text-muted)' : 'var(--text-bright)'}; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-decoration:${t.isCompleted ? 'line-through' : 'none'};">${t.title || t.content}</div>
                            <div style="font-size:0.65rem; color:var(--text-dim); display:flex; justify-content:space-between;">
                                <span>${t.goalTitle}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            async function toggleDailyTask(goalId, taskId, isCompleted) {
                try {
                    const res = await fetch(`/Goal/UpdateDailyTask?goalId=${goalId}&taskId=${taskId}&isCompleted=${isCompleted}`, {
                        method: 'POST'
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success && data.goal) {
                            const idx = allGoals.findIndex(g => g.id === goalId);
                            if (idx !== -1) allGoals[idx] = data.goal;
                            
                            renderGoalList();
                            renderTodayTasks();
                            updateGoalAnalytics();
                            if (selectedGoalId === goalId) viewGoalDetails(goalId);
                        } else {
                            await initGoals();
                        }
                    }
                } catch (e) { console.error('Toggle task failed:', e); }
            }

            function openGoalModal() {
                document.getElementById('goalModal').style.display = 'flex';
                document.getElementById('goalStart').valueAsDate = new Date();
                const end = new Date();
                end.setDate(end.getDate() + 7);
                document.getElementById('goalEnd').valueAsDate = end;
                document.getElementById('goalWarning').style.display = 'none';
            }

            function closeGoalModal() {
                document.getElementById('goalModal').style.display = 'none';
                document.getElementById('goalTitle').value = '';
                document.getElementById('goalDesc').value = '';
            }



            function viewGoalDetails(id) {
                const goal = allGoals.find(g => g.id === id);
                if (!goal) return;
                selectedGoalId = id;

                document.getElementById('detailTitle').innerText = goal.title;
                document.getElementById('detailCategory').innerText = goal.category;
                document.getElementById('detailProgressText').innerText = `${Math.round(goal.progress)}%`;
                document.getElementById('detailProgressBar').style.width = `${goal.progress}%`;
                document.getElementById('detailStreak').innerText = `${goal.streak} Day Streak 🔥`;
                document.getElementById('detailScheduleStatus').innerText = goal.scheduleStatus;
                
                const schedColor = goal.scheduleStatus === 'Completed' ? 'var(--accent-success)' : 'var(--text-dim)';
                document.getElementById('detailScheduleStatus').style.color = schedColor;

                // Monthly Overview Stats
                const tasksByDate = goal.dailyTasks.reduce((acc, t) => {
                    const d = t.date.split('T')[0];
                    if (!acc[d]) acc[d] = [];
                    acc[d].push(t);
                    return acc;
                }, {});

                const dates = Object.keys(tasksByDate).sort();
                const completedDays = Object.values(tasksByDate).filter(dayTasks => dayTasks.every(t => t.isCompleted)).length;
                const missedDays = Object.values(tasksByDate).filter(dayTasks => {
                    const dayDate = new Date(dayTasks[0].date);
                    return dayDate < new Date().setHours(0,0,0,0) && dayTasks.some(t => !t.isCompleted);
                }).length;

                document.getElementById('ovTotalDays').innerText = dates.length;
                document.getElementById('ovDoneDays').innerText = completedDays;
                document.getElementById('ovMissedDays').innerText = missedDays;
                document.getElementById('ovMonthProgress').innerText = `${Math.round(goal.progress)}%`;

                // Initial render from goal object, but switchGoalTab will fetch fresh if tab is strategy
                renderMonthlyDailyList(goal, tasksByDate);
                renderGoalMilestones(goal);
                renderGoalCalendar(goal);
                renderGoalHeatmap(goal);

                document.getElementById('deadlineWarning').style.display = goal.status === 'Overdue' ? 'block' : 'none';
                document.getElementById('goalDetailModal').style.display = 'flex';
                // Always reset to strategy tab on open and fetch fresh
                switchGoalTab('strategy');
            }

            function renderGoalMilestones(goal) {
                const container = document.getElementById('milestoneList');
                if (!container) return;

                if (!goal.milestones || goal.milestones.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.8rem;">No milestones generated.</div>';
                    return;
                }

                container.innerHTML = goal.milestones.map(m => {
                    const dueDate = new Date(m.dueDate);
                    const isOverdue = !m.isCompleted && dueDate < new Date().setHours(0,0,0,0);
                    
                    return `
                        <div class="milestone-item" style="background:rgba(255,255,255,0.03); border:1px solid ${m.isCompleted ? 'var(--accent-success)' : (isOverdue ? 'var(--accent-danger)' : 'var(--border-dim)')}; padding:15px; border-radius:12px; display:flex; gap:15px; align-items:flex-start;">
                            <div onclick="toggleMilestone('${goal.id}', '${m.id}', ${!m.isCompleted})" style="width:24px; height:24px; border-radius:50%; border:2px solid ${m.isCompleted ? 'var(--accent-success)' : 'var(--border-dim)'}; background:${m.isCompleted ? 'var(--accent-success)' : 'transparent'}; display:flex; align-items:center; justify-content:center; cursor:pointer; color:white; flex-shrink:0;">
                                ${m.isCompleted ? '<i class="fas fa-check" style="font-size:0.8rem;"></i>' : ''}
                            </div>
                            <div style="flex:1;">
                                <div style="font-weight:600; font-size:0.9rem; color:${m.isCompleted ? 'var(--text-muted)' : 'var(--text-bright)'}; text-decoration:${m.isCompleted ? 'line-through' : 'none'};">${m.title}</div>
                                <div style="font-size:0.75rem; color:${isOverdue ? 'var(--accent-danger)' : 'var(--text-muted)'}; margin-top:5px;">
                                    <i class="far fa-calendar-alt"></i> ${dueDate.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' })}
                                    ${isOverdue ? ' <span style="font-weight:700;">(OVERDUE)</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async function toggleMilestone(goalId, milestoneId, isCompleted) {
                try {
                    const res = await fetch(`/Goal/UpdateMilestone?goalId=${goalId}&milestoneId=${milestoneId}&isCompleted=${isCompleted}`, { method: 'POST' });
                    if (res.ok) {
                        const data = await res.json();
                        // Update the goal in our global allGoals array
                        const goalIdx = allGoals.findIndex(g => g.id === goalId);
                        if (goalIdx !== -1) allGoals[goalIdx] = data.goal;
                        
                        viewGoalDetails(goalId); // Refresh UI
                        await initGoals(); // Update dashboard cards
                    }
                } catch (e) { console.error('Milestone toggle failed:', e); }
            }

            async function fetchDailyTasks(goalId) {
                try {
                    const res = await fetch(`/Goal/GetDailyTasks?goalId=${goalId}`);
                    if (res.ok) {
                        const tasksByDate = await res.json();
                        const goal = allGoals.find(g => g.id === goalId);
                        renderMonthlyDailyList(goal, tasksByDate);
                    }
                } catch (e) { console.error('Fetch tasks failed:', e); }
            }

            function renderMonthlyDailyList(goal, tasksByDate) {
                const container = document.getElementById('monthlyDailyList');
                if (!container) return;

                const sortedDates = Object.keys(tasksByDate).sort();
                if (sortedDates.length === 0) {
                    container.innerHTML = `<div style="padding: 30px; text-align: center; opacity: 0.6;"><i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 10px;"></i><p>No tasks added</p></div>`;
                    return;
                }

                const now = new Date();
                const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                container.innerHTML = sortedDates.map(dateStr => {
                    const tasks = tasksByDate[dateStr];
                    const date = new Date(dateStr);
                    const isToday = dateStr === todayStr;
                    const allDone = tasks.every(t => t.isCompleted);
                    const anyDone = tasks.some(t => t.isCompleted);
                    const isPast = date < new Date().setHours(0,0,0,0);
                    
                    let statusColor = 'var(--text-muted)';
                    if (allDone) statusColor = 'var(--accent-success)';
                    else if (isPast && !allDone) statusColor = 'var(--accent-danger)';
                    else if (anyDone) statusColor = 'var(--accent-warning)';

                    return `
                        <div class="day-card" style="background:rgba(255,255,255,0.02); border:1px solid ${isToday ? 'var(--accent-primary)' : 'var(--border-dim)'}; border-radius:10px; overflow:hidden;">
                            <div onclick="toggleDayCollapse('${dateStr}')" style="padding:12px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; background:${isToday ? 'rgba(56, 189, 248, 0.05)' : 'transparent'};">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span style="font-weight:700; color:${isToday ? 'var(--accent-primary)' : 'var(--text-bright)'};">${date.toLocaleDateString('en-US', { day:'numeric', month:'short' })}</span>
                                    <span style="font-size:0.7rem; color:${statusColor}; text-transform:uppercase;">• ${allDone ? 'Completed' : (isPast ? 'Missed' : 'Pending')}</span>
                                </div>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span style="font-size:0.7rem; color:var(--text-dim);">${tasks.filter(t => t.isCompleted).length}/${tasks.length}</span>
                                    <i class="fas fa-chevron-down" id="chevron-${dateStr}" style="font-size:0.8rem; transition:transform 0.3s;"></i>
                                </div>
                            </div>
                            <div id="tasks-${dateStr}" style="display:${isToday ? 'block' : 'none'}; padding:0 12px 12px 12px; border-top:1px solid rgba(255,255,255,0.05);">
                                <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
                                    ${tasks.map(t => `
                                        <div class="task-row" style="display:flex; align-items:flex-start; gap:10px; background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; group">
                                            <div onclick="toggleDailyTask('${goal.id}', '${t.id}', ${!t.isCompleted})" style="width:18px; height:18px; border-radius:4px; border:2px solid ${t.isCompleted ? 'var(--accent-success)' : 'var(--border-dim)'}; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--accent-success); margin-top:2px;">
                                                ${t.isCompleted ? '<i class="fas fa-check" style="font-size:0.6rem;"></i>' : ''}
                                            </div>
                                            <div style="flex:1;">
                                                <div style="font-size:0.85rem; font-weight:600; color:${t.isCompleted ? 'var(--text-muted)' : 'var(--text-bright)'}; text-decoration:${t.isCompleted ? 'line-through' : 'none'};">${t.title || t.content}</div>
                                                ${t.description ? `<div style="font-size:0.75rem; color:var(--text-muted); margin-top:2px;">${t.description}</div>` : ''}
                                            </div>
                                            <div class="actions" style="display:flex; gap:8px; opacity:0.6;">
                                                <button onclick="editTaskContent('${goal.id}', '${t.id}', '${(t.title || t.content || '').replace(/'/g, "\\'")}', '${(t.description || '').replace(/'/g, "\\'")}')" class="btn-icon" style="font-size:0.7rem;"><i class="fas fa-edit"></i></button>
                                                <button onclick="deleteTask('${goal.id}', '${t.id}')" class="btn-icon text-danger" style="font-size:0.7rem;"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                    `).join('')}
                                    
                                    ${tasks.length === 0 ? `
                                        <button onclick="addTaskToDate('${goal.id}', '${dateStr}')" style="margin-top:5px; background:rgba(16, 185, 129, 0.1); border:1px dashed var(--accent-success); color:var(--accent-success); padding:6px; border-radius:6px; font-size:0.75rem; cursor:pointer; width:100%;">
                                            <i class="fas fa-plus-circle"></i> Add Task
                                        </button>
                                    ` : `
                                        <div style="margin-top:5px; padding:6px; text-align:center; font-size:0.65rem; color:var(--text-muted); background:rgba(255,255,255,0.02); border-radius:6px; border:1px solid var(--border-dim);">
                                            <i class="fas fa-info-circle"></i> Only one task allowed per day.
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function toggleDayCollapse(dateStr) {
                const el = document.getElementById(`tasks-${dateStr}`);
                const chevron = document.getElementById(`chevron-${dateStr}`);
                if (el.style.display === 'none') {
                    el.style.display = 'block';
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    el.style.display = 'none';
                    chevron.style.transform = 'rotate(0deg)';
                }
            }

            async function handleTaskAction(goalId, taskId, action, content) {
                try {
                    const formData = new URLSearchParams();
                    formData.append('goalId', goalId);
                    formData.append('taskId', taskId);
                    formData.append('action', action);
                    formData.append('content', content);

                    const res = await fetch('/Goal/TaskAction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success && data.goal) {
                            const idx = allGoals.findIndex(g => g.id === goalId);
                            if (idx !== -1) allGoals[idx] = data.goal;
                            
                            renderGoalList();
                            renderTodayTasks();
                            updateGoalAnalytics();
                            if (selectedGoalId === goalId) viewGoalDetails(goalId);
                        } else {
                            await initGoals();
                        }
                    }
                } catch (e) { console.error('Task action failed:', e); }
            }

            function addTaskToDate(goalId, dateStr) {
                const title = prompt("Enter task title:");
                if (!title) return;
                const desc = prompt("Enter task description (optional):") || "";
                handleTaskAction(goalId, '', 'add_to_date', `${dateStr}|${title}|${desc}`);
            }

            function editTaskContent(goalId, taskId, title, desc) {
                document.getElementById('editTaskGoalId').value = goalId;
                document.getElementById('editTaskId').value = taskId;
                document.getElementById('editTaskTitle').value = title;
                document.getElementById('editTaskDesc').value = desc || '';
                document.getElementById('editTaskModal').style.display = 'flex';
            }

            function closeEditTaskModal() {
                document.getElementById('editTaskModal').style.display = 'none';
            }

            async function saveEditTask() {
                const goalId = document.getElementById('editTaskGoalId').value;
                const taskId = document.getElementById('editTaskId').value;
                const title = document.getElementById('editTaskTitle').value;
                const desc = document.getElementById('editTaskDesc').value;

                if (!title) return alert("Title is required");

                try {
                    const formData = new URLSearchParams();
                    formData.append('goalId', goalId);
                    formData.append('taskId', taskId);
                    formData.append('title', title);
                    formData.append('description', desc);

                    const res = await fetch('/Goal/UpdateDailyTaskDetail', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success && data.goal) {
                            const idx = allGoals.findIndex(g => g.id === goalId);
                            if (idx !== -1) allGoals[idx] = data.goal;
                            
                            renderGoalList();
                            renderTodayTasks();
                            updateGoalAnalytics();
                            if (selectedGoalId === goalId) {
                                viewGoalDetails(goalId);
                            }
                            closeEditTaskModal();
                        }
                    }
                } catch (e) { console.error('Save edit task failed:', e); }
            }

            function deleteTask(goalId, taskId) {
                if (confirm("Delete this task?")) {
                    handleTaskAction(goalId, taskId, 'delete', '');
                }
            }

            function renderGoalCalendar(goal) {
                const grid = document.getElementById('goalCalendar');
                if (!grid) return;

                const startDate = new Date(goal.startDate);
                const year = startDate.getFullYear();
                const month = startDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                let html = '';
                ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => {
                    html += `<div style="text-align:center; font-size:0.65rem; padding:4px; color:var(--text-muted); font-weight:700;">${d}</div>`;
                });

                for (let i = 0; i < firstDay; i++) html += '<div></div>';

                const today = new Date().setHours(0,0,0,0);

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const k = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    const tasks = goal.dailyTasks.filter(t => t.date.split('T')[0] === k);
                    
                    let bg = 'rgba(255,255,255,0.05)';
                    let border = 'none';
                    let color = 'var(--text-dim)';

                    if (tasks.length > 0) {
                        const done = tasks.filter(t => t.isCompleted).length;
                        if (done === tasks.length) bg = 'var(--accent-success)'; // Green
                        else if (done > 0) bg = '#10b98160'; // Light Green
                        else if (date.getTime() < today) bg = 'var(--accent-danger)'; // Red
                    }

                    if (date.getTime() === today) {
                        bg = 'var(--accent-primary)'; // Blue as requested
                        border = '1px solid white';
                        color = 'white';
                    } else if (date.getTime() > today) {
                        bg = 'rgba(255,255,255,0.05)'; // Gray for future
                    }

                    html += `
                        <div onclick="showDayTasks('${goal.id}', '${k}')" style="aspect-ratio:1; display:flex; align-items:center; justify-content:center; font-size:0.75rem; background:${bg}; border:${border}; border-radius:6px; color:${color}; cursor:pointer; transition:all 0.2s;">
                            ${day}
                        </div>
                    `;
                }
                grid.innerHTML = html;
            }

            function showDayTasks(goalId, dateStr) {
                const goal = allGoals.find(g => g.id === goalId);
                const tasks = goal.dailyTasks.filter(t => t.date.split('T')[0] === dateStr);
                const container = document.getElementById('selectedDayTasksContainer');
                const titleEl = document.getElementById('selectedDateTitle');
                
                if (titleEl) titleEl.innerText = `Action Plan: ${dateStr}`;
                
                if (container) {
                    if (tasks.length === 0) {
                        container.innerHTML = `<div style="font-size:0.75rem; color:var(--text-muted); padding:10px; text-align:center;">No tasks for this day.</div>`;
                        if (document.getElementById('calendarAddTaskBtn')) document.getElementById('calendarAddTaskBtn').style.display = 'block';
                        if (document.getElementById('calendarLimitMsg')) document.getElementById('calendarLimitMsg').style.display = 'none';
                    } else {
                        container.innerHTML = tasks.map(t => `
                            <div class="daily-task-item" style="padding:12px; background:rgba(255,255,255,0.04); border:1px solid var(--border-dim); border-radius:10px; display:flex; align-items:flex-start; gap:12px;">
                                <div onclick="toggleDailyTask('${goalId}', '${t.id}', ${!t.isCompleted})" style="width:20px; height:20px; border-radius:6px; border:2px solid ${t.isCompleted ? 'var(--accent-success)' : 'var(--border-dim)'}; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--accent-success); margin-top:2px;">
                                    ${t.isCompleted ? '<i class="fas fa-check" style="font-size:0.75rem;"></i>' : ''}
                                </div>
                                <div style="flex:1;">
                                    <div style="font-size:0.9rem; font-weight:600; color:${t.isCompleted ? 'var(--text-muted)' : 'var(--text-bright)'}; text-decoration:${t.isCompleted ? 'line-through' : 'none'};">${t.title || t.content}</div>
                                    ${t.description ? `<div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">${t.description}</div>` : ''}
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button onclick="editTaskContent('${goalId}', '${t.id}', '${(t.title || t.content || '').replace(/'/g, "\\'")}', '${(t.description || '').replace(/'/g, "\\'")}')" class="btn-icon"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteTask('${goalId}', '${t.id}')" class="btn-icon text-danger"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('');
                        
                        if (document.getElementById('calendarAddTaskBtn')) document.getElementById('calendarAddTaskBtn').style.display = 'none';
                        if (document.getElementById('calendarLimitMsg')) document.getElementById('calendarLimitMsg').style.display = 'block';
                    }
                }
                // Save the date context for the "Add Task" button in the tab
                window.currentSelectedDateString = dateStr;
                const displayArea = document.getElementById('selectedDayTasks');
                if (displayArea) displayArea.style.display = 'block';
            }

            function addTaskToSelectedDate() {
                if (window.currentSelectedDateString) {
                    addTaskToDate(selectedGoalId, window.currentSelectedDateString);
                }
            }

            function renderGoalHeatmap(goal) {
                const container = document.getElementById('heatmapContainer');
                if (!container) return;

                const heatmapDays = [];
                for (let i = 89; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    heatmapDays.push(date.toDateString());
                }

                container.innerHTML = heatmapDays.map(dateStr => {
                    const tasks = goal.dailyTasks.filter(t => new Date(t.date).toDateString() === dateStr);
                    let color = 'rgba(255,255,255,0.05)';
                    let title = `${new Date(dateStr).toLocaleDateString()}: No Activity`;

                    if (tasks.length > 0) {
                        const done = tasks.filter(t => t.isCompleted).length;
                        const ratio = done / tasks.length;
                        if (ratio === 1) color = '#10b981';
                        else if (ratio > 0.5) color = '#059669';
                        else if (ratio > 0) color = '#065f46';
                        else if (new Date(dateStr) < new Date().setHours(0,0,0,0)) color = '#450a0a';
                        title = `${new Date(dateStr).toLocaleDateString()}: ${done}/${tasks.length} Done`;
                    }

                    return `<div title="${title}" style="width:10px; height:10px; background:${color}; border-radius:2px;"></div>`;
                }).join('');
            }

            function switchGoalTab(tab) {
                currentTab = tab;
                document.querySelectorAll('.goal-tab-content').forEach(c => c.style.display = 'none');
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active');
                    b.style.color = 'var(--text-muted)';
                    b.style.borderBottom = 'none';
                });

                const content = document.getElementById(`goalTab_${tab}`);
                if (content) content.style.display = 'block';
                
                const btn = document.getElementById(`tab_${tab}`);
                if (btn) {
                    btn.classList.add('active');
                    btn.style.color = 'var(--text-bright)';
                    btn.style.borderBottom = '2px solid gold';
                }

                if (tab === 'strategy' && selectedGoalId) {
                    fetchDailyTasks(selectedGoalId);
                } else if (tab === 'milestones' && selectedGoalId) {
                    const goal = allGoals.find(g => g.id === selectedGoalId);
                    if (goal) renderGoalMilestones(goal);
                }
            }

            async function redistributeTasks() {
                if (!selectedGoalId) return;
                if (!confirm("Redistribute all missed tasks across future days? This will help your productivity score recover.")) return;
                
                try {
                    const res = await fetch(`/Goal/RedistributeTasks?goalId=${selectedGoalId}`, { method: 'POST' });
                    if (res.ok) {
                        await initGoals();
                        viewGoalDetails(selectedGoalId);
                    }
                } catch (e) { console.error('Redistribute failed:', e); }
            }



            function closeGoalDetailModal() {
                document.getElementById('goalDetailModal').style.display = 'none';
                const dayTasks = document.getElementById('selectedDayTasks');
                if (dayTasks) dayTasks.style.display = 'none';
                selectedGoalId = null;
            }

            function confirmDeleteGoal() {
                if (confirm("Permanently delete this goal and all tracking history?")) {
                    deleteGoal(selectedGoalId);
                }
            }

            async function deleteGoal(id) {
                if (!confirm("Are you sure you want to delete this goal? This action cannot be undone.")) return;
                
                try {
                    const res = await fetch(`/Goal/DeleteGoal?id=${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        closeGoalDetailModal();
                        initGoals();
                    }
                } catch (e) { console.error('Delete failed:', e); }
            }

            // Refresh dynamic form elements on language change

            $(document).on('languageChanged', function (e, lang) {
                const isEdit = document.getElementById('noteId').value !== '';
                const titleKey = isEdit ? 'EditNote' : 'NewNote';
                if (isFormVisible) {
                    document.getElementById('formTitle').innerText = window.i18n.t(titleKey);
                }
            });
        </script>
}
