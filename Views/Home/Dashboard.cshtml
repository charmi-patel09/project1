@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["GlobalIntelligenceDashboard"];
    ViewData["TitleKey"] = "GlobalIntelligenceDashboard";
}

<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap"
    rel="stylesheet">

<div class="dashboard-shell">
    <div class="dashboard-content">
        <!-- Persistent Header -->
        <header class="main-header">
            <div class="header-brief">
                <div class="status-chip">
                    <span class="pulse-dot"></span>
                    <span data-i18n="GlobalSatelliteLinkActive">@Localizer["GlobalSatelliteLinkActive"]</span>
                </div>
                <h1 data-i18n="IntelligenceHub">@Localizer["IntelligenceHub"]</h1>
                <p><span data-i18n="TelemetryFor">@Localizer["TelemetryFor"]</span> <span
                        class="accent-text">@(Context.Session.GetString("AdminUser") ??
                        Context.Session.GetString("StudentUser") ?? Localizer["Operator"].Value)</span>.</p>
            </div>
            <div class="header-chrono">
                <div class="chrono-date" id="headerDate">--/--/----</div>
                <div class="chrono-time" id="headerTime">00:00:00</div>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Global Search Hub -->
            <section class="tool-card global-search-hub">
                <div class="card-title">
                    <div class="title-icon cyan-glow">
                        <i class="fas fa-globe-americas"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="GlobalSearch">@Localizer["GlobalSearch"]</h3>
                        <p data-i18n="SearchPlaceholder">@Localizer["SearchPlaceholder"]</p>
                    </div>
                </div>

                <div class="hub-controls">
                    <div class="search-field">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearchInput" data-i18n-placeholder="SearchPlaceholder"
                            placeholder="@Localizer["SearchPlaceholder"]"
                            onkeypress="if(event.key === 'Enter') searchGlobalIntel()">
                    </div>
                    <div class="action-group">
                        <button onclick="searchGlobalIntel()" class="btn-primary"
                            data-i18n="Analyze">@Localizer["Analyze"]</button>
                    </div>
                </div>

                <div id="globalSearchResult" class="hub-display" style="gap: 12px;">
                    <!-- Results -->
                </div>
            </section>

            <!-- Weather Card -->
            <section class="tool-card weather-hub">
                <div class="card-title">
                    <div class="title-icon sky-glow">
                        <i class="fas fa-satellite"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="Weather">@Localizer["Weather"]</h3>
                        <p data-i18n="DeepSpaceMeteorologicalTelemetry">@Localizer["DeepSpaceMeteorologicalTelemetry"]
                        </p>
                    </div>
                </div>

                <div class="hub-controls">
                    <div class="search-field">
                        <i class="fas fa-magnifying-glass"></i>
                        <input type="text" id="cityInput" data-i18n-placeholder="LocateAnyCityOrCountry"
                            placeholder="@Localizer["LocateAnyCityOrCountry"]"
                            onkeypress="if(event.key === 'Enter') getWeather()">
                    </div>
                    <div class="action-group">
                        <button onclick="getWeather()" class="btn-primary"
                            data-i18n="Analyze">@Localizer["Analyze"]</button>
                        <button onclick="getCurrentLocation()" class="btn-icon" title="Local coordinates"><i
                                class="fas fa-location-crosshairs"></i></button>
                    </div>
                </div>

                <div class="hub-display">
                    <div id="weatherResult" class="primary-result">
                        <div class="loading-state" data-i18n="InitialisingSatelliteLink">
                            @Localizer["InitialisingSatelliteLink"]</div>
                    </div>
                </div>
            </section>

            <!-- Fiscal Exchange Card -->
            <section class="tool-card currency-hub">
                <div class="card-title">
                    <div class="title-icon emerald-glow">
                        <i class="fas fa-vault"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="CurrencyExchange">@Localizer["CurrencyExchange"]</h3>
                        <p data-i18n="GlobalValuationProtocols">@Localizer["GlobalValuationProtocols"]</p>
                    </div>
                </div>

                <div class="tool-body">
                    <div class="form-row">
                        <label data-i18n="TransactionVolume">@Localizer["TransactionVolume"]</label>
                        <input type="number" id="amountInput" value="1.00" step="0.01" class="modern-input"
                            oninput="convertCurrency()">
                    </div>
                    <div class="form-grid">
                        <div class="form-row">
                            <label data-i18n="BaseLocation">@Localizer["BaseLocation"]</label>
                            <select id="fromCurrency" class="modern-select" onchange="convertCurrency()"></select>
                        </div>
                        <div class="swap-indicator"><i class="fas fa-right-left"></i></div>
                        <div class="form-row">
                            <label data-i18n="TargetLocation">@Localizer["TargetLocation"]</label>
                            <select id="toCurrency" class="modern-select" onchange="convertCurrency()"></select>
                        </div>
                    </div>
                    <div class="action-row" style="margin-top: 10px;">
                        <button onclick="convertCurrency()" class="btn-emerald" style="width: 100%;">
                            <i class="fas fa-bolt"></i> <span
                                data-i18n="RefreshValuation">@Localizer["RefreshValuation"]</span>
                        </button>
                    </div>
                    <div class="result-section">
                        <div class="result-status">
                            <label class="result-header"
                                data-i18n="RealTimeFiscalTelemetry">@Localizer["RealTimeFiscalTelemetry"]</label>
                            <div class="live-tag">
                                <span class="pulse-dot"></span>
                                <span data-i18n="Live">@Localizer["Live"]</span>
                            </div>
                        </div>
                        <div id="currencyResult" class="valuation-output">
                            <div class="loading-state" data-i18n="InitializingSensorLink">
                                @Localizer["InitializingSensorLink"]</div>
                        </div>
                        <div class="update-info" id="lastExchangeUpdate">
                            <span data-i18n="LastSync">@Localizer["LastSync"]</span>: --:--:--
                        </div>
                    </div>

                    <div class="fiscal-directory" style="display: none;">
                        <label data-i18n="CurrencyOriginReference">@Localizer["CurrencyOriginReference"]</label>
                        <div id="currencyReferenceList" class="reference-scroll">
                            <!-- JS Populated -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Chronos Sync Card -->
            <section class="tool-card chrono-hub">
                <div class="card-title">
                    <div class="title-icon indigo-glow">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="TimeZone">@Localizer["TimeZone"]</h3>
                        <p data-i18n="UniversalTimeCoordination">@Localizer["UniversalTimeCoordination"]</p>
                    </div>
                </div>

                <div class="tool-body">
                    <div class="clock-display">
                        <label data-i18n="SystemBaseTime">@Localizer["SystemBaseTime"]</label>
                        <div id="localTimeLarge" class="digits-hero">00:00:00</div>
                    </div>
                    <div class="zone-sync">
                        <label data-i18n="CoordinateZone">@Localizer["CoordinateZone"]</label>
                        <select id="timezoneSelect" class="modern-select" onchange="updateConvertedTime()">
                            <option value="UTC" data-i18n="Timezone_UTC">Universal (UTC)</option>
                            <option value="America/New_York" data-i18n="Timezone_NY">New York (EDT)</option>
                            <option value="Europe/London" data-i18n="Timezone_London">London (BST)</option>
                            <option value="Asia/Tokyo" data-i18n="Timezone_Tokyo">Tokyo (JST)</option>
                            <option value="Asia/Kolkata" selected data-i18n="Timezone_Mumbai">Mumbai (IST)</option>
                            <option value="Australia/Sydney" data-i18n="Timezone_Sydney">Sydney (AEST)</option>
                            <option value="Asia/Dubai" data-i18n="Timezone_Dubai">Dubai (GST)</option>
                        </select>
                        <div id="convertedTime" class="digits-accent">00:00:00</div>
                    </div>
                </div>
            </section>

            <!-- News Hub Card -->
            <section class="tool-card news-hub">
                <div class="card-title">
                    <div class="title-icon rose-glow">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="GlobalNewsFeed">@Localizer["GlobalNewsFeed"]</h3>
                        <p data-i18n="LiveIntelStream">@Localizer["LiveIntelStream"]</p>
                    </div>
                </div>

                <div class="hub-controls">
                    <div class="search-field">
                        <i class="fas fa-search"></i>
                        <input type="text" id="newsInput" data-i18n-placeholder="SearchNews"
                            placeholder="@Localizer["SearchNews"]"
                            onkeypress="if(event.key === 'Enter') fetchNews(this.value)">
                    </div>
                    <div class="action-group">
                        <button onclick="fetchNews(document.getElementById('newsInput').value)" class="btn-primary"
                            data-i18n="Analyze">@Localizer["Analyze"]</button>
                    </div>
                </div>

                <div class="news-list" id="newsFeed">
                    <div class="loading-state" data-i18n="InitializingSensorLink">@Localizer["InitializingSensorLink"]
                    </div>
                </div>
            </section>

            <!-- Notes Hub Card -->
            <section class="tool-card notes-hub">
                <div class="card-title">
                    <div class="title-icon purple-glow">
                        <i class="fas fa-sticky-note"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="Notes">@Localizer["Notes"]</h3>
                        <p data-i18n="PersonalLog">@Localizer["PersonalLog"]</p>
                    </div>
                </div>

                <div class="hub-controls">
                    <button id="btnNewNote" onclick="toggleNoteForm()" class="btn-primary" style="width:100%">
                        <i class="fas fa-plus"></i> <span data-i18n="NewNote">@Localizer["NewNote"]</span>
                    </button>
                </div>

                <div id="noteFormArea"
                    style="display:none; margin-bottom: 20px; background: rgba(255,255,255,0.02); padding: 16px; border-radius: 16px; border: 1px solid var(--border-dim);"
                    class="slide-in">
                    <div style="margin-bottom: 12px; font-weight: 700; color: var(--accent-purple);" id="formTitle"
                        data-i18n="NewNote">
                        @Localizer["NewNote"]</div>
                    <input type="hidden" id="noteId">
                    <div class="form-row" style="margin-bottom:12px;">
                        <input type="text" id="noteTitle" class="modern-input" placeholder="@Localizer["NoteTitle"]"
                            data-i18n-placeholder="NoteTitle">
                    </div>
                    <div class="form-row" style="margin-bottom:12px;">
                        <textarea id="noteDesc" class="modern-input" rows="3" placeholder="@Localizer["NoteDetails"]"
                            data-i18n-placeholder="NoteDetails"></textarea>
                    </div>
                    <div class="action-group" style="width: 100%; display: flex; gap: 10px;">
                        <button onclick="saveNote()" class="btn-primary" style="flex: 1;"
                            data-i18n="Save">@Localizer["Save"]</button>
                        <button onclick="toggleNoteForm()" class="btn-icon"
                            style="flex: 1; border: 1px solid var(--border-dim); background: transparent; color: var(--text-muted);"
                            data-i18n="Cancel">@Localizer["Cancel"]</button>
                    </div>
                </div>

                <div class="notes-list" id="notesList">
                    <div class="loading-state" data-i18n="DecryptingLogs">@Localizer["InitialisingSatelliteLink"]</div>
                </div>
            </section>




        </div>
    </div>
</div>



<link rel="stylesheet" href="~/css/dashboard.css" />

@section Scripts {
    <script>
        function getWeatherDesc(code) {
            const map = {
                0: 'ClearSkies', 1: 'MainlyClear', 2: 'PartiallyCloudy', 3: 'Overcast',
                45: 'FogPresence', 48: 'DepositingRimeFog', 51: 'LightDrizzle', 53: 'ModerateDrizzle',
                55: 'DenseDrizzle', 61: 'SlightRain', 63: 'ModerateRain', 65: 'HeavyRain',
                71: 'SlightSnowfall', 73: 'ModerateSnowfall', 75: 'HeavySnowfall', 77: 'IceParticles',
                80: 'RainShowersSlight', 81: 'RainShowersModerate', 82: 'RainShowersExtreme',
                95: 'ThunderstormActive', 96: 'StormSlightHail', 99: 'StormHeavyHail'
            };
            return window.i18n.t(map[code] || 'OptimizedAtmosphere');
        }

        const weatherIcons = {
            0: 'fa-sun', 1: 'fa-cloud-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud',
            45: 'fa-smog', 48: 'fa-smog', 51: 'fa-cloud-rain', 53: 'fa-cloud-rain',
            55: 'fa-cloud-showers-heavy', 61: 'fa-cloud-rain', 63: 'fa-cloud-rain',
            65: 'fa-cloud-showers-heavy', 71: 'fa-snowflake', 73: 'fa-snowflake',
            75: 'fa-snowflake', 80: 'fa-cloud-bolt', 81: 'fa-cloud-bolt',
            82: 'fa-cloud-bolt', 95: 'fa-bolt-lightning'
        };

        function getIcon(code) { return weatherIcons[code] || 'fa-cloud'; }

        // --- GLOBAL NETWORK NODES ---
        let allNodes = [];
        const initialNodes = [
            { name: "Ahmedabad", lat: 23.0225, lon: 72.5714, cc: "GJ, IN" },
            { name: "Surat", lat: 21.1702, lon: 72.8311, cc: "GJ, IN" },
            { name: "Vadodara", lat: 22.3072, lon: 73.1812, cc: "GJ, IN" },
            { name: "Rajkot", lat: 22.3039, lon: 70.8022, cc: "GJ, IN" },
            { name: "London", lat: 51.5074, lon: -0.1278, cc: "GB" },
            { name: "New York", lat: 40.7128, lon: -74.0060, cc: "US" },
            { name: "Tokyo", lat: 35.6895, lon: 139.6917, cc: "JP" },
            { name: "Mumbai", lat: 19.0760, lon: 72.8777, cc: "IN" },
            { name: "Delhi", lat: 28.6139, lon: 77.2090, cc: "IN" }
        ];

        async function initNodeDirectory() {
            const container = document.getElementById('worldWeatherList');
            if (container) container.innerHTML = `<div class="loading-state">${window.i18n.t('SyncingGlobalNodes')}</div>`;

            allNodes = [];
            for (const n of initialNodes) {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${n.lat}&longitude=${n.lon}&current=temperature_2m,weather_code`);
                    const data = await res.json();
                    allNodes.push({ ...n, weather: data.current });
                } catch (e) { }
            }
            renderNodes(allNodes);
        }

        function renderNodes(nodes) {
            const container = document.getElementById('worldWeatherList');
            const nodeCount = document.getElementById('nodeCount');
            if (!container) return;
            container.innerHTML = '';
            if (nodeCount) nodeCount.innerText = `${nodes.length} ${window.i18n.t('NodesActive')}`;

            nodes.forEach(item => {
                const el = document.createElement('div');
                el.className = 'node-item slide-in';
                el.onclick = () => fetchWeatherDeep(item.lat, item.lon, `${window.i18n.t(item.name)}, ${item.cc}`);
                el.innerHTML = `<div><h4>${window.i18n.t(item.name)}</h4><span>Region: ${item.cc}</span></div>
                                                                                            <div class="node-data"><i class="fas ${getIcon(item.weather.weather_code)}"></i>
                                                                                            <b>${Math.round(item.weather.temperature_2m)}°C</b></div>`;
                container.appendChild(el);
            });
        }

        async function getCurrentLocation() {
            const display = document.getElementById('weatherResult');
            display.innerHTML = `<div class="loading-state">${window.i18n.t('TriangulatingSatelliteUplink')}</div>`;
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => fetchWeatherDeep(p.coords.latitude, p.coords.longitude, "Local Terminal"),
                    () => { display.innerHTML = `<div class="text-danger">${window.i18n.t('UplinkInterrupted')}</div>`; }
                );
            }
        }

        async function getWeather(cityOverride) {
            const query = cityOverride || document.getElementById('cityInput').value || 'London';
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=1&language=en&format=json`);
                const data = await res.json();
                if (!data.results) {
                    document.getElementById('weatherResult').innerHTML = `<div class="text-danger">${window.i18n.t('NodeNotFound')}</div>`;
                    return;
                }
                const { latitude, longitude, name, country } = data.results[0];
                fetchWeatherDeep(latitude, longitude, `${name}, ${country}`);
            } catch (e) { console.error(e); }
        }

        async function fetchWeatherDeep(lat, lon, label) {
            const display = document.getElementById('weatherResult');
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`);
                const data = await res.json();
                const cur = data.current;
                display.innerHTML = `
                                                                                <div class="loc-label slide-in">${label}</div>
                                                                                <div class="temp-hero slide-in">${Math.round(cur.temperature_2m)}°</div>
                                                                                <div class="weather-desc slide-in">${getWeatherDesc(cur.weather_code)}</div>
                                                                                <div class="stats-deep slide-in">
                                                                                    <div class="stat-box"><i class="fas fa-droplet"></i> <label>${window.i18n.t('Humidity')}</label> <b>${cur.relative_humidity_2m}%</b></div>
                                                                                    <div class="stat-box"><i class="fas fa-wind"></i> <label>${window.i18n.t('WindVelocity')}</label> <b>${Math.round(cur.wind_speed_10m)} km/h</b></div>
                                                                                </div>`;
            } catch (e) { display.innerHTML = `<div class="text-danger">${window.i18n.t('SatelliteLinkFailure')}</div>`; }
        }

        let baseCurrencyRates = {};
        const globalLocations = [
            { name: 'India', flag: '🇮🇳', currency: 'INR' },
            { name: 'United States', flag: '🇺🇸', currency: 'USD' },
            { name: 'United Kingdom', flag: '🇬🇧', currency: 'GBP' },
            { name: 'Germany', flag: '🇩🇪', currency: 'EUR' },
            { name: 'Japan', flag: '🇯🇵', currency: 'JPY' }
        ];

        async function initFiscal() {
            try {
                const f = document.getElementById('fromCurrency');
                const t = document.getElementById('toCurrency');
                // Preserve selection if just reloading
                const selF = f.value;
                const selT = t.value;

                f.innerHTML = ''; t.innerHTML = '';
                globalLocations.forEach(location => {
                    const opt = new Option(`${location.flag} ${location.name} (${location.currency})`, location.currency);
                    f.add(opt.cloneNode(true)); t.add(opt.cloneNode(true));
                });

                if (selF) f.value = selF; else f.value = 'USD';
                if (selT) t.value = selT; else t.value = 'INR';

                await fetchLatestRates();
            } catch (e) { }
        }

        async function fetchLatestRates() {
            const f = document.getElementById('fromCurrency').value;
            try {
                const res = await fetch(`https://open.er-api.com/v6/latest/${f}`);
                const data = await res.json();
                baseCurrencyRates = data.rates;
                const updateEl = document.getElementById('lastExchangeUpdate');
                const lang = window.i18n.locale;
                const locale = lang === 'en' ? 'en-US' : (lang === 'hi' ? 'hi-IN' : 'gu-IN');
                if (updateEl) updateEl.innerText = `${window.i18n.t('LastSync')}: ${new Date().toLocaleTimeString(locale)} (${f} Base)`;
                convertCurrency();
            } catch (e) { }
        }

        async function convertCurrency() {
            const amount = parseFloat(document.getElementById('amountInput').value) || 0;
            const f = document.getElementById('fromCurrency').value;
            const t = document.getElementById('toCurrency').value;
            const display = document.getElementById('currencyResult');
            if (!baseCurrencyRates[t]) {
                display.innerHTML = `<div class="loading-state">${window.i18n.t('SyncingNewBaseRates')}</div>`;
                await fetchLatestRates(); return;
            }
            const calc = amount * baseCurrencyRates[t];
            const lang = window.i18n.locale;
            const locale = lang === 'en' ? 'en-US' : (lang === 'hi' ? 'hi-IN' : 'gu-IN');
            display.innerHTML = `
                                                                            <div class="val-grid">
                                                                                <div class="val-box slide-in highlight-border">
                                                                                    <div class="val-label">${f}</div>
                                                                                    <div class="val-number">${amount.toLocaleString(locale, { minimumFractionDigits: 2 })}</div>
                                                                                    <div class="val-loc-meta">${window.i18n.t('RealCurrency')}</div>
                                                                                </div>
                                                                                <div class="val-box slide-in">
                                                                                    <div class="val-label">${t}</div>
                                                                                    <div class="val-number highlight">${calc.toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                                                                    <div class="val-loc-meta">${window.i18n.t('ExchangeTarget')}</div>
                                                                                </div>
                                                                            </div>`;
        }

        function runChronos() {
            const now = new Date();
            const lang = window.i18n.locale;
            const locale = lang === 'en' ? 'en-US' : (lang === 'hi' ? 'hi-IN' : 'gu-IN');

            const dateEl = document.getElementById('headerDate');
            if (dateEl) dateEl.innerText = now.toLocaleDateString(locale, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const timeEl = document.getElementById('headerTime');
            if (timeEl) timeEl.innerText = now.toLocaleTimeString(locale);

            const localLargeEl = document.getElementById('localTimeLarge');
            if (localLargeEl) localLargeEl.innerText = now.toLocaleTimeString(locale);
        }

        function updateConvertedTime() {
            const zone = document.getElementById('timezoneSelect').value;
            const now = new Date();
            const lang = window.i18n.locale;
            const locale = lang === 'en' ? 'en-US' : (lang === 'hi' ? 'hi-IN' : 'gu-IN');

            const timeString = now.toLocaleTimeString(locale, { timeZone: zone });
            const dateString = now.toLocaleDateString(locale, { timeZone: zone, weekday: 'short', month: 'short', day: 'numeric' });

            // Calculate Offset
            const type = Intl.DateTimeFormat(locale, { timeZone: zone, timeZoneName: 'longOffset' }).formatToParts(now).find(p => p.type === 'timeZoneName').value;

            document.getElementById('convertedTime').innerHTML = `${timeString} <span style="font-size:0.5em; opacity:0.7; display:block;">${dateString} • ${type}</span>`;
        }

        // --- NEWS FEED ---
        const newsApiKey = '947acf3b268e4d7da27bf2404e62e3e0';
        let currentArticles = [];

        async function fetchNews(query) {
            const container = document.getElementById('newsFeed');
            // Show loading state
            if (container) container.innerHTML = `<div class="loading-state">${window.i18n.t('InitializingSensorLink')}</div>`;

            try {
                let url;
                if (query && query.trim().length > 0) {
                    // Search mode: uses "everything" endpoint sorted by date
                    url = `https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&sortBy=publishedAt&apiKey=${newsApiKey}`;
                } else {
                    // Default mode: Top Headlines for India
                    const country = 'in';
                    url = `https://newsapi.org/v2/top-headlines?country=${country}&apiKey=${newsApiKey}`;
                }

                const res = await fetch(url);
                const data = await res.json();

                if (data.status === 'ok') {
                    if (data.articles.length === 0) {
                        container.innerHTML = `<div style="padding:40px; text-align:center; color: var(--text-muted);">${window.i18n.t('NoNewsFound')}</div>`;
                    } else {
                        currentArticles = data.articles;
                        renderNews();
                    }
                } else {
                    container.innerHTML = `<div class="text-danger" style="padding:20px;">${window.i18n.t('SatelliteLinkFailure')} (${data.message || 'API Error'})</div>`;
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="text-danger" style="padding:20px;">${window.i18n.t('SatelliteLinkFailure')}</div>`;
            }
        }

        function renderNews() {
            const container = document.getElementById('newsFeed');
            if (!container) return;
            container.innerHTML = '';

            const locale = window.i18n.locale === 'en' ? 'en-US' : (window.i18n.locale === 'hi' ? 'hi-IN' : 'gu-IN');

            currentArticles.slice(0, 15).forEach(article => {
                const el = document.createElement('a');
                el.className = 'news-item slide-in';
                el.href = article.url;
                el.target = '_blank';

                // Fallback image
                const imgUrl = article.urlToImage || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=100&auto=format&fit=crop';
                const date = new Date(article.publishedAt).toLocaleDateString(locale, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                el.innerHTML = `
                                                    <img src="${imgUrl}" class="news-image" onerror="this.src='https://images.unsplash.com/photo-1585829365295-ab7cd400c167?q=80&w=100&auto=format&fit=crop'">
                                                    <div class="news-content">
                                                        <div class="news-title">${article.title}</div>
                                                        <div class="news-meta">
                                                            <span class="news-source">${article.source.name}</span>
                                                            <span>${date}</span>
                                                        </div>
                                                        <div style="margin-top:8px; font-size:0.75rem; color:var(--accent-sky); font-weight:600;">
                                                            ${window.i18n.t('ReadFullReport')} &rarr;
                                                        </div>
                                                    </div>
                                                `;
                container.appendChild(el);
            });
        }




        // --- NOTES SYSTEM ---
        let currentNotes = [];

        async function initNotes() {
            fetchNotes();
        }

        async function fetchNotes() {
            const container = document.getElementById('notesList');
            try {
                const res = await fetch('/Notes/GetAll');
                if (res.ok) {
                    const notes = await res.json();
                    renderNotes(notes);
                } else {
                    if (container) container.innerHTML = `<div class="text-danger">${window.i18n.t('LoadNotesError')}</div>`;
                }
            } catch (e) {
                if (container) container.innerHTML = `<div class="text-danger">${window.i18n.t('ConnectionError')}</div>`;
            }
        }

        function renderNotes(notes) {
            currentNotes = notes;
            const container = document.getElementById('notesList');
            if (!container) return;
            container.innerHTML = '';

            if (notes.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;">${window.i18n.t('NoNotesFound')}</div>`;
                return;
            }

            notes.forEach(note => {
                const date = new Date(note.createdDate).toLocaleDateString();
                const div = document.createElement('div');
                div.className = 'note-item slide-in';
                div.onclick = (e) => {
                    if (e.target.closest('.btn-note-action')) return;
                    editNote(note.id);
                };
                div.innerHTML = `
                                        <div class="note-header">
                                            <div class="note-title">${escapeHtml(note.title)}</div>
                                            <div class="note-date">${date}</div>
                                        </div>
                                        <div class="note-desc">${escapeHtml(note.description)}</div>
                                        <div class="note-actions">
                                            <button class="btn-note-action" onclick="editNote(${note.id})"><i class="fas fa-edit"></i></button>
                                            <button class="btn-note-action delete" onclick="deleteNote(${note.id})"><i class="fas fa-trash"></i></button>
                                        </div>
                                    `;
                container.appendChild(div);
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        }

        async function searchGlobalIntel() {
            const query = document.getElementById('globalSearchInput').value;
            const display = document.getElementById('globalSearchResult');

            if (!query) return;

            display.innerHTML = `<div class="loading-state">${window.i18n.t('InitializingSensorLink')}</div>`;

            try {
                // 1. Geocoding Search
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=1&language=en&format=json`);
                const geoData = await geoRes.json();

                if (!geoData.results || geoData.results.length === 0) {
                    display.innerHTML = `<div class="text-danger" style="text-align:center; padding: 20px;">${window.i18n.t('NoResult')}</div>`;
                    return;
                }

                const location = geoData.results[0];
                const countryCode = location.country_code;

                // 2. Fetch Country Details
                let countryData = null;
                try {
                    if (countryCode) {
                        const countryRes = await fetch(`https://restcountries.com/v3.1/alpha/${countryCode}`);
                        const cData = await countryRes.json();
                        countryData = cData[0];
                    }
                } catch (e) { console.warn('Country data fetch failed'); }

                // 3. Render
                renderGlobalResult(location, countryData);

            } catch (e) {
                display.innerHTML = `<div class="text-danger">${window.i18n.t('SatelliteLinkFailure')}</div>`;
            }
        }

        function renderGlobalResult(loc, country) {
            const display = document.getElementById('globalSearchResult');
            const currency = country && country.currencies ? Object.values(country.currencies)[0] : { name: 'N/A', symbol: '' };
            const lang = window.i18n.locale;
            const locale = lang === 'en' ? 'en-US' : (lang === 'hi' ? 'hi-IN' : 'gu-IN');

            let html = `
                                <div class="result-card slide-in" style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 20px; border: 1px solid var(--border-dim);">
                                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 16px;">
                                        <div>
                                            <div style="font-size: 1.5rem; font-weight: 800; color: var(--text-bright);">${loc.name}</div>
                                            <div style="color: var(--text-muted); font-size: 0.9rem;">${loc.admin1 || ''} ${country ? ', ' + country.name.common : ''}</div>
                                        </div>
                                        ${country ? `<div style="font-size: 2.5rem; line-height: 1;">${country.flag}</div>` : ''}
                                    </div>

                                    <div class="stats-deep" style="grid-template-columns: 1fr 1fr; margin-top: 0;">
                                        <div class="stat-box" style="padding: 12px;">
                                            <label data-i18n="Coordinates">${window.i18n.t('Coordinates')}</label>
                                            <b>${loc.latitude.toFixed(2)}, ${loc.longitude.toFixed(2)}</b>
                                        </div>
                                        <div class="stat-box" style="padding: 12px;">
                                            <label data-i18n="TimeZone">${window.i18n.t('TimeZone')}</label>
                                            <b style="font-size: 1rem;">${loc.timezone}</b>
                                        </div>
                                    </div>
                            `;

            if (country) {
                html += `
                                    <div class="stats-deep" style="grid-template-columns: 1fr 1fr; margin-top: 12px;">
                                        <div class="stat-box" style="padding: 12px;">
                                            <label data-i18n="Currency">${window.i18n.t('Currency')}</label>
                                            <b>${currency.symbol} ${currency.name}</b>
                                        </div>
                                        <div class="stat-box" style="padding: 12px;">
                                            <label data-i18n="Population">${window.i18n.t('Population')}</label>
                                            <b>${(country.population / 1000000).toFixed(1)}M</b>
                                        </div>
                                         <div class="stat-box" style="padding: 12px;">
                                            <label data-i18n="Capital">${window.i18n.t('Capital')}</label>
                                            <b>${country.capital ? country.capital[0] : 'N/A'}</b>
                                        </div>
                                         <div class="stat-box" style="padding: 12px;">
                                            <label data-i18n="Region">${window.i18n.t('Region')}</label>
                                            <b>${country.region}</b>
                                        </div>
                                    </div>
                                `;
            }

            html += `</div>`;
            display.innerHTML = html;
        }

        let isFormVisible = false;

        function toggleNoteForm(forceState) {
            const form = document.getElementById('noteFormArea');
            const btn = document.getElementById('btnNewNote');

            // If forceState is provided, set to that state, otherwise toggle
            if (typeof forceState !== 'undefined') {
                isFormVisible = forceState;
            } else {
                isFormVisible = !isFormVisible;
            }

            if (isFormVisible) {
                // Show Form
                form.style.display = 'block';
                btn.style.display = 'none'; // Optional: Hide the "New Note" button while adding

                // If it's a new note (no ID), clear fields
                if (!document.getElementById('noteId').value) {
                    document.getElementById('noteTitle').value = '';
                    document.getElementById('noteDesc').value = '';
                    document.getElementById('formTitle').innerText = window.i18n ? window.i18n.t('NewNote') : '@Localizer["NewNote"]';
                    document.getElementById('formTitle').setAttribute('data-i18n', 'NewNote');
                }
            } else {
                // Hide Form
                form.style.display = 'none';
                btn.style.display = 'block';
                // Clear ID so next open is fresh
                document.getElementById('noteId').value = '';
            }
        }

        function editNote(id) {
            const note = currentNotes.find(n => n.id === id);
            if (!note) return;

            document.getElementById('noteId').value = id;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteDesc').value = note.description;
            document.getElementById('formTitle').innerText = window.i18n ? window.i18n.t('EditNote') : 'Edit Note';
            document.getElementById('formTitle').setAttribute('data-i18n', 'EditNote');

            toggleNoteForm(true);
        }

        async function saveNote() {
            const title = document.getElementById('noteTitle').value;
            const desc = document.getElementById('noteDesc').value;
            const id = document.getElementById('noteId').value;

            if (!title || !desc) {
                alert(window.i18n.t('FillAllFields'));
                return;
            }

            const url = id ? '/Notes/Update' : '/Notes/Create';
            const body = { title: title, description: desc };
            if (id) body.id = parseInt(id);

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    toggleNoteForm(false);
                    fetchNotes();
                } else {
                    alert(window.i18n.t('SaveError'));
                }
            } catch (e) {
                alert(window.i18n.t('SaveError'));
            }
        }

        async function deleteNote(id) {
            if (!confirm(window.i18n.t('DeleteNoteConfirm'))) return;
            try {
                const res = await fetch('/Notes/Delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(id)
                });
                if (res.ok) fetchNotes();
            } catch (e) { console.error(e); }
        }

        $(document).ready(function () {
            runChronos();
            initNodeDirectory();
            initFiscal();
            getWeather('Ahmedabad');
            updateConvertedTime();
            fetchNews();
            initNotes();
        });

        $(document).on('languageChanged', function (e, lang) {
            console.log('Dashboard detected language change:', lang);
            runChronos();
            renderNodes(allNodes);
            fetchLatestRates();
            renderNews();
            fetchNotes();
            fetchNotes();
        });

        // Refresh dynamic form elements on language change
        $(document).on('languageChanged', function (e, lang) {
            const isEdit = document.getElementById('noteId').value !== '';
            const titleKey = isEdit ? 'EditNote' : 'NewNote';
            // Update form title state (other elements update via data-i18n automatically if the system parses them)
            // If the system renders fetchNotes() it will rebuild the list with new strings.
            // We just need to ensure the form title is correct if it is open
            if (isFormVisible) {
                const titleEl = document.getElementById('formTitle');
                if (titleEl) {
                    titleEl.setAttribute('data-i18n', titleKey);
                    titleEl.innerText = window.i18n.t(titleKey);
                }
            }
        });

        setInterval(runChronos, 1000);
        setInterval(updateConvertedTime, 1000);
    </script>
}
