@{
    ViewData["Title"] = "Dashboard";
    ViewData["TitleKey"] = "Dashboard";
}

<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap"
    rel="stylesheet">

<div class="dashboard-shell">
    <div class="dashboard-content">
        <!-- Persistent Header -->
        <header class="main-header">
            <div class="header-brief">
                <h1>Dashboard</h1>
            </div>
            <div class="header-chrono">
                <div class="chrono-date no-translate" id="headerDate">--/--/----</div>
                <div class="chrono-time no-translate" id="headerTime">00:00:00</div>
            </div>
        </header>

        <div class="dashboard-grid">


            <!-- Global Search Hub -->
            <section class="tool-card global-search-hub">
                <div class="card-title">
                    <div class="title-icon cyan-glow">
                        <i class="fas fa-globe-americas"></i>
                    </div>
                    <div class="title-text">
                        <h3>Global Search</h3>
                        <p>Search Global Intelligence Database...</p>
                    </div>
                </div>

                <div class="hub-controls">
                    <div class="search-field">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearchInput" placeholder="Search Global Intelligence Database..."
                            onkeypress="if(event.key === 'Enter') searchGlobalIntel()">
                    </div>
                    <div class="action-group">
                        <button onclick="searchGlobalIntel()" class="btn-primary">Search</button>
                    </div>
                </div>

                <div id="globalSearchResult" class="hub-display" style="gap: 12px;">
                    <!-- Results -->
                </div>
            </section>

            <!-- Weather Card -->
            <section class="tool-card weather-hub">
                <div class="card-title">
                    <div class="title-icon sky-glow">
                        <i class="fas fa-satellite"></i>
                    </div>
                    <div class="title-text">
                        <h3>Weather</h3>
                        <p>Deep Space Meteorological Telemetry</p>
                    </div>
                </div>

                <div class="hub-controls">
                    <div class="search-field">
                        <i class="fas fa-magnifying-glass"></i>
                        <input type="text" id="cityInput" placeholder="Locate Any City or Country"
                            onkeypress="if(event.key === 'Enter') getWeather()">
                    </div>
                    <div class="action-group">
                        <button onclick="getWeather()" class="btn-primary">Search</button>
                        <button onclick="getCurrentLocation()" class="btn-icon" title="Local coordinates"><i
                                class="fas fa-location-crosshairs"></i></button>
                    </div>
                </div>

                <div class="hub-display">
                    <div id="weatherResult" class="primary-result">
                        <div style="padding: 20px; text-align: center; color: var(--text-muted); opacity: 0.8;">
                            <i class="fas fa-satellite" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                            <p>Locate Any City or Country</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Fiscal Exchange Card -->
            <section class="tool-card currency-hub">
                <div class="card-title">
                    <div class="title-icon emerald-glow">
                        <i class="fas fa-vault"></i>
                    </div>
                    <div class="title-text">
                        <h3>Currency Exchange</h3>
                        <p>Global Valuation Protocols</p>
                    </div>
                </div>

                <div class="tool-body">
                    <div class="form-row">
                        <label>Transaction Volume</label>
                        <input type="number" id="amountInput" value="1.00" step="0.01" class="modern-input"
                            oninput="convertCurrency()">
                    </div>
                    <div class="form-grid">
                        <div class="form-row">
                            <label>Base Location</label>
                            <select id="fromCurrency" class="modern-select" onchange="convertCurrency()"></select>
                        </div>
                        <div class="swap-indicator"><i class="fas fa-right-left"></i></div>
                        <div class="form-row">
                            <label>Target Location</label>
                            <select id="toCurrency" class="modern-select" onchange="convertCurrency()"></select>
                        </div>
                    </div>
                    <div class="action-row" style="margin-top: 10px;">
                        <button onclick="convertCurrency()" class="btn-emerald" style="width: 100%;">
                            <i class="fas fa-bolt"></i> <span>Refresh</span>
                        </button>
                    </div>
                    <div class="result-section">
                        <div class="result-status">
                            <label class="result-header">Real Currency</label>
                            <div class="live-tag">
                                <span class="pulse-dot"></span>
                                <span>LIVE</span>
                            </div>
                        </div>
                        <div id="currencyResult" class="valuation-output">
                            <!-- Hidden until action -->
                            <div
                                style="padding: 20px; text-align: center; color: var(--text-muted); opacity: 0.6; font-size: 0.9rem;">
                                <i class="fas fa-coins"></i> <span>Convert Currency</span>
                            </div>
                        </div>
                        <div class="update-info no-translate" id="lastExchangeUpdate">
                            <span>Last Sync</span>: --:--:--
                        </div>
                    </div>

                    <div class="fiscal-directory" style="display: none;">
                        <label>Currency Origin Reference</label>
                        <div id="currencyReferenceList" class="reference-scroll">
                            <!-- JS Populated -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Chronos Sync Card -->
            <section class="tool-card chrono-hub">
                <div class="card-title">
                    <div class="title-icon indigo-glow">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="title-text">
                        <h3>Timezone</h3>
                        <p>Universal Time Coordination</p>
                    </div>
                </div>

                <div class="tool-body">
                    <div class="clock-display">
                        <label>System Base Time</label>
                        <div id="localTimeLarge" class="digits-hero no-translate">00:00:00</div>
                    </div>
                    <div class="zone-sync">
                        <label>Chronos Sync</label>
                        <select id="timezoneSelect" class="modern-select" onchange="updateConvertedTime()">
                            <option value="UTC">UTC, Universal</option>
                            <option value="America/New_York">New York, United States</option>
                            <option value="Europe/London">London, United Kingdom</option>
                            <option value="Asia/Tokyo">Tokyo, Japan</option>
                            <option value="Asia/Kolkata" selected>Mumbai, India</option>
                            <option value="Asia/Dubai">Dubai, United Arab Emirates</option>
                            <option value="Australia/Sydney">Sydney, Australia</option>
                            <option value="Europe/Paris">Paris, France</option>
                            <option value="Europe/Berlin">Berlin, Germany</option>
                            <option value="Asia/Singapore">Singapore, Singapore</option>
                            <option value="Asia/Shanghai">Shanghai, China</option>
                            <option value="America/Los_Angeles">Los Angeles, United States</option>
                            <option value="America/Chicago">Chicago, United States</option>
                            <option value="America/Toronto">Toronto, Canada</option>
                            <option value="Europe/Moscow">Moscow, Russia</option>
                        </select>
                        <div id="convertedTime" class="digits-accent no-translate">00:00:00</div>
                    </div>
                </div>
            </section>

            <!-- News Hub Card -->
            <section class="tool-card news-hub">
                <div class="card-title">
                    <div class="title-icon rose-glow">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="title-text">
                        <h3>Global News Feed</h3>
                        <p>Live Intel Stream</p>
                    </div>
                </div>

                <div class="hub-controls">
                    <div class="search-field">
                        <i class="fas fa-magnifying-glass"></i>
                        <input type="text" id="newsInput" placeholder="Search News"
                            onkeypress="if(event.key === 'Enter') triggerNewsSearch()">
                    </div>
                    <div class="action-group">
                        <button onclick="triggerNewsSearch()" class="btn-primary">Search</button>
                    </div>
                </div>

                <div class="news-list" id="newsFeed">
                    <!-- News will load here only upon user search -->
                    <div style="padding: 30px; text-align: center; color: var(--text-muted); opacity: 0.6;">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Search News</p>
                    </div>
                </div>
            </section>

            <!-- Notes Hub Card -->
            <section class="tool-card notes-hub">
                <div class="card-title">
                    <div class="title-icon purple-glow">
                        <i class="fas fa-sticky-note"></i>
                    </div>
                    <div class="title-text">
                        <h3>Notes</h3>
                        <p>Personal Log</p>
                    </div>
                </div>

                <div class="hub-controls">
                    <button id="btnNewNote" onclick="toggleNoteForm()" class="btn-primary" style="width:100%">
                        <i class="fas fa-plus"></i> <span>New Note</span>
                    </button>
                </div>

                <div id="noteFormArea"
                    style="display:none; margin-bottom: 20px; background: rgba(255,255,255,0.02); padding: 16px; border-radius: 16px; border: 1px solid var(--border-dim);"
                    class="slide-in">
                    <div style="margin-bottom: 12px; font-weight: 700; color: var(--accent-purple);" id="formTitle">
                        New Note</div>
                    <input type="hidden" id="noteId">
                    <div class="form-row" style="margin-bottom:12px;">
                        <input type="text" id="noteTitle" class="modern-input" placeholder="Note Title">
                    </div>
                    <div class="form-row" style="margin-bottom:12px;">
                        <textarea id="noteDesc" class="modern-input" rows="3" placeholder="Note Details"></textarea>
                    </div>
                    <div class="action-group" style="width: 100%; display: flex; gap: 10px;">
                        <button onclick="saveNote()" class="btn-primary" style="flex: 1;">Save</button>
                        <button onclick="toggleNoteForm()" class="btn-icon"
                            style="flex: 1; border: 1px solid var(--border-dim); background: transparent; color: var(--text-muted);">Cancel</button>
                    </div>
                </div>

                <div class="notes-list" id="notesList">
                    <div class="loading-state">Establishing Secure Link...</div>
                </div>
            </section>




            </section>

            <!-- Translator Hub Card -->
            <section class="tool-card translator-hub">
                <div class="card-title">
                    <div class="title-icon orange-glow">
                        <i class="fas fa-language"></i>
                    </div>
                    <div class="title-text">
                        <h3>Translator</h3>
                        <p>Universal Language Relay</p>
                    </div>
                </div>

                <div class="tool-body">
                    <div class="form-row">
                        <label>Input Text</label>
                        <textarea id="transInput" class="modern-input" rows="3" placeholder="Enter text to translate..." style="resize:none; padding:12px;"></textarea>
                    </div>

                    <div class="form-grid" style="margin-top:12px; align-items:flex-end;">
                        <div class="form-row" style="flex:1;">
                            <label>Target Language</label>
                            <select id="transLangSelect" class="modern-select">
                                <option value="en">English (EN)</option>
                                <option value="es">Spanish (ES)</option>
                                <option value="fr">French (FR)</option>
                                <option value="de">German (DE)</option>
                                <option value="hi">Hindi (HI)</option>
                                <option value="gu">Gujarati (GU)</option>
                                <option value="zh">Chinese (ZH)</option>
                                <option value="ja">Japanese (JA)</option>
                                <option value="ru">Russian (RU)</option>
                                <option value="ar">Arabic (AR)</option>
                                <option value="pt">Portuguese (PT)</option>
                                <option value="it">Italian (IT)</option>
                                <option value="ko">Korean (KO)</option>
                            </select>
                        </div>
                        <button onclick="translateWidget()" class="btn-primary" id="btnTranslateAction" style="height:48px; border-radius:12px;">
                            <i class="fas fa-arrow-right-arrow-left"></i>
                        </button>
                    </div>

                    <div class="result-section" style="margin-top:20px;">
                        <div class="result-status" style="justify-content: space-between; display: flex;">
                            <label class="result-header">Translation Output</label>
                            <button class="copy-text-btn" onclick="copyTranslation()" title="Copy to Clipboard" style="display:none;" id="btnCopyTrans">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div id="transOutput" class="valuation-output" style="align-items: flex-start; text-align: left; min-height: 100px; padding: 16px; font-size: 0.95rem; line-height: 1.5; color: var(--text-bright);">
                            <div style="width:100%; text-align:center; color:var(--text-muted); opacity:0.6; margin-top:24px;">
                                <i class="fas fa-language" style="font-size:1.5rem; margin-bottom:8px;"></i>
                                <p>Ready to Translate</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Emergency Hub Card -->
            <section class="tool-card emergency-hub">
                <div class="card-title">
                    <div class="title-icon red-glow">
                        <i class="fas fa-kit-medical"></i>
                    </div>
                    <div class="title-text">
                        <h3>Emergency Contacts</h3>
                        <p>Global Distress Signal</p>
                    </div>
                </div>

                <div class="tool-body">
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div class="search-field" style="position:relative;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="emergencyInput" class="modern-input"
                                placeholder="Type Country Name..." autocomplete="off" oninput="handleEmergencySearch()">
                            <div id="emergencyDropdown" class="dropdown-suggestions"></div>
                        </div>
                    </div>

                    <div id="emergencyResult" class="emergency-display">
                        <div class="empty-state">
                            <i class="fas fa-shield-heart"></i>
                            <p>Select a country to view emergency lines</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Habit Tracker Card -->
            <section class="tool-card habit-hub">
                <div class="card-title">
                    <div class="title-icon green-glow">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="title-text">
                        <h3>Habit Tracker</h3>
                        <p>Consistent Growth</p>
                    </div>
                </div>

                <div class="tool-body">
                    <div id="habitList" class="habit-list">
                        <!-- Habits rendered here -->
                        <div class="empty-state">
                            <i class="fas fa-seedling"></i>
                            <p>Start a new habit today!</p>
                        </div>
                    </div>

                    <div class="add-habit-section" style="margin-top:20px; border-top:1px solid var(--glass-border); padding-top:16px;">
                        <div id="addHabitForm" style="display:none; transition:all 0.3s ease;">
                            <div class="form-row" style="margin-bottom:8px;">
                                <input type="text" id="newHabitName" class="modern-input" placeholder="Habit Name (e.g. Read 10 pages)" style="padding:10px;">
                            </div>
                            <div class="form-grid" style="grid-template-columns: 1fr auto; gap:8px;">
                                <select id="newHabitType" class="modern-select" style="padding:10px;">
                                    <option value="daily">Daily Goal</option>
                                    <option value="weekly">Weekly Goal</option>
                                </select>
                                <button onclick="saveNewHabit()" class="btn-primary" style="padding:0 20px; border-radius:8px;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <button onclick="toggleAddHabitForm()" class="text-btn" style="width:100%; margin-top:8px; font-size:0.8rem; opacity:0.7;">Cancel</button>
                        </div>
                        <button id="showAddHabitBtn" onclick="toggleAddHabitForm()" class="btn-secondary" style="width:100%; border-radius:12px; padding:12px;">
                            <i class="fas fa-plus" style="margin-right:8px;"></i> Add New Habit
                        </button>
                    </div>
                </div>
            </section>


        </div>
    </div>
</div>



<link rel="stylesheet" href="~/css/dashboard.css" />

@section Scripts {
    <script>
        function getWeatherDesc(code) {
            const map = {
                0: 'Clear skies', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Depositing rime fog', 51: 'Light drizzle', 53: 'Moderate drizzle',
                55: 'Dense drizzle', 61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
                71: 'Slight snow', 73: 'Moderate snow', 75: 'Heavy snow', 77: 'Snow grains',
                80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
                95: 'Thunderstorm', 96: 'Thunderstorm with slight hail', 99: 'Thunderstorm with heavy hail'
            };
            return map[code] || 'Clear skies';
        }

        const weatherIcons = {
            0: 'fa-sun', 1: 'fa-cloud-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud',
            45: 'fa-smog', 48: 'fa-smog', 51: 'fa-cloud-rain', 53: 'fa-cloud-rain',
            55: 'fa-cloud-showers-heavy', 61: 'fa-cloud-rain', 63: 'fa-cloud-rain',
            65: 'fa-cloud-showers-heavy', 71: 'fa-snowflake', 73: 'fa-snowflake',
            75: 'fa-snowflake', 80: 'fa-cloud-bolt', 81: 'fa-cloud-bolt',
            82: 'fa-cloud-bolt', 95: 'fa-bolt-lightning'
        };

        function getIcon(code) { return weatherIcons[code] || 'fa-cloud'; }

        // --- GLOBAL NETWORK NODES ---
        let allNodes = [];
        const initialNodes = [
            { name: "Ahmedabad", lat: 23.0225, lon: 72.5714, cc: "GJ, IN" },
            { name: "Surat", lat: 21.1702, lon: 72.8311, cc: "GJ, IN" },
            { name: "Vadodara", lat: 22.3072, lon: 73.1812, cc: "GJ, IN" },
            { name: "Rajkot", lat: 22.3039, lon: 70.8022, cc: "GJ, IN" },
            { name: "London", lat: 51.5074, lon: -0.1278, cc: "GB" },
            { name: "New York", lat: 40.7128, lon: -74.0060, cc: "US" },
            { name: "Tokyo", lat: 35.6895, lon: 139.6917, cc: "JP" },
            { name: "Mumbai", lat: 19.0760, lon: 72.8777, cc: "IN" },
            { name: "Delhi", lat: 28.6139, lon: 77.2090, cc: "IN" }
        ];

        async function initNodeDirectory() {
            const container = document.getElementById('worldWeatherList');
            if (container) {
                container.innerHTML = `<div class="loading-state">Syncing Global Nodes...</div>`;
            }

            allNodes = [];
            for (const n of initialNodes) {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${n.lat}&longitude=${n.lon}&current=temperature_2m,weather_code`);
                    const data = await res.json();
                    allNodes.push({ ...n, weather: data.current });
                } catch (e) { }
            }
            renderNodes(allNodes);
        }

        function renderNodes(nodes) {
            const container = document.getElementById('worldWeatherList');
            const nodeCount = document.getElementById('nodeCount');
            if (!container) return;
            container.innerHTML = '';

            if (nodeCount) {
                nodeCount.innerText = `${nodes.length} Nodes Active`;
            }

            for (const item of nodes) {
                const el = document.createElement('div');
                el.className = 'node-item slide-in';

                el.onclick = () => {
                    fetchWeatherDeep(item.lat, item.lon, `${item.name}, ${item.cc}`);
                };

                const iconClass = getIcon(item.weather.weather_code);
                const temp = Math.round(item.weather.temperature_2m);
                el.innerHTML = `<div><h4>${item.name}</h4><span>Region: ${item.cc}</span></div>
                                                                                                                                            <div class="node-data"><i class="fas ${iconClass}"></i>
                                                                                                                                            <b>${temp}°C</b></div>`;
                container.appendChild(el);
            }
        }

        function getCurrentLocation() {
            const display = document.getElementById('weatherResult');
            display.innerHTML = `<div class="loading-state">Triangulating Satellite Uplink...</div>`;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => fetchWeatherDeep(p.coords.latitude, p.coords.longitude, "Local Terminal"),
                    () => {
                        display.innerHTML = `<div class="text-danger">Uplink Interrupted</div>`;
                    }
                );
            }
        }

        async function getWeather(cityOverride) {
            const query = cityOverride || document.getElementById('cityInput').value || 'London';
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=1&language=en&format=json`);
                const data = await res.json();
                if (!data.results) {
                    document.getElementById('weatherResult').innerHTML = `<div class="text-danger">City not found</div>`;
                    return;
                }
                const { latitude, longitude, name, country } = data.results[0];
                fetchWeatherDeep(latitude, longitude, `${name}, ${country}`);
            } catch (e) {
                document.getElementById('weatherResult').innerHTML = `<div class="text-danger">City not found</div>`;
            }
        }

        async function fetchWeatherDeep(lat, lon, label) {
            const display = document.getElementById('weatherResult');
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`);
                const data = await res.json();
                const cur = data.current;
                const timezone = data.timezone;

                const weatherDesc = getWeatherDesc(cur.weather_code);

                // Calculate Local Time
                let localTimeStr = "--:--";
                try {
                    const date = new Date();
                    localTimeStr = new Intl.DateTimeFormat('en-US', {
                        timeZone: timezone, weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                    }).format(date);
                } catch (e) { console.error("Time calc error", e); }

                display.innerHTML = `
                                                                                                                                                                                <div class="loc-label slide-in">${label}</div>
                                                                                                                                                                                <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;" class="slide-in">${localTimeStr}</div>
                                                                                                                                                                                <div class="temp-hero slide-in">${Math.round(cur.temperature_2m)}°</div>
                                                                                                                                                                                <div class="weather-desc slide-in">${weatherDesc}</div>
                                                                                                                                                                                <div class="stats-deep slide-in">
                                                                                                                                                                                    <div class="stat-box"><i class="fas fa-droplet"></i> <label>Humidity</label> <b>${cur.relative_humidity_2m}%</b></div>
                                                                                                                                                                                    <div class="stat-box"><i class="fas fa-wind"></i> <label>Wind Velocity</label> <b>${Math.round(cur.wind_speed_10m)} km/h</b></div>
                                                                                                                                                                                </div>`;
            } catch (e) {
                display.innerHTML = `<div class="text-danger">Satellite Link Failure</div>`;
            }
        }


        // --- FISCAL & TIMEZONE DATA ---
        let currencyContext = null; // Stores { city: string, country: string, currency: string }

        /* --- SHARED DATASET --- */
        /* --- SHARED DATASET --- */
        let globalLocationData = []; // The master list for both Currency and Timezone
        let emergencyCountryList = []; // Master list for Emergency Search

        async function initFiscal(preserveState = false) {
            const f = document.getElementById('fromCurrency');
            const t = document.getElementById('toCurrency');

            // Capture current selection if preserving state
            let currentVals = {};
            if (preserveState) {
                currentVals = { f: f.value, t: t.value };
            }

            // Major Non-Capital Cities (IANA Timezones) to ensure comprehensive global coverage
            const extraCities = [
                { country: "United States", city: "New York", currency: "USD", timezone: "America/New_York", code: "US" },
                { country: "United States", city: "Los Angeles", currency: "USD", timezone: "America/Los_Angeles", code: "US" },
                { country: "United States", city: "Chicago", currency: "USD", timezone: "America/Chicago", code: "US" },
                { country: "India", city: "Mumbai", currency: "INR", timezone: "Asia/Kolkata", code: "IN" },
                { country: "India", city: "Bengaluru", currency: "INR", timezone: "Asia/Kolkata", code: "IN" },
                { country: "India", city: "Delhi", currency: "INR", timezone: "Asia/Kolkata", code: "IN" },
                { country: "United Kingdom", city: "London", currency: "GBP", timezone: "Europe/London", code: "GB" },
                { country: "Japan", city: "Tokyo", currency: "JPY", timezone: "Asia/Tokyo", code: "JP" },
                { country: "China", city: "Shanghai", currency: "CNY", timezone: "Asia/Shanghai", code: "CN" },
                { country: "Germany", city: "Berlin", currency: "EUR", timezone: "Europe/Berlin", code: "DE" },
                { country: "France", city: "Paris", currency: "EUR", timezone: "Europe/Paris", code: "FR" },
                { country: "Australia", city: "Sydney", currency: "AUD", timezone: "Australia/Sydney", code: "AU" },
                { country: "Canada", city: "Toronto", currency: "CAD", timezone: "America/Toronto", code: "CA" },
                { country: "United Arab Emirates", city: "Dubai", currency: "AED", timezone: "Asia/Dubai", code: "AE" },
                { country: "Singapore", city: "Singapore", currency: "SGD", timezone: "Asia/Singapore", code: "SG" }
            ];

            // IMMEDIATE RENDER of reliable static data (Popular)
            globalLocationData = [...extraCities];

            // Define Helper Functions LOCALLY to ensure they exist
            const createOpt = (c) => {
                const val = `${c.currency}|${c.country}`;
                const opt = new Option(`${c.city}, ${c.country}`, val);
                opt.setAttribute('data-city', c.city);
                opt.setAttribute('data-country', c.country);
                opt.setAttribute('data-currency', c.currency);
                opt.setAttribute('data-timezone', c.timezone);
                return opt;
            };

            const appendGroup = (parent, label, items) => {
                if (items.length === 0) return;
                const group = document.createElement('optgroup');
                group.label = label;
                items.forEach(c => group.appendChild(createOpt(c)));
                parent.appendChild(group);
            };

            // Helper to populate
            const populateDropdowns = async (data) => {
                f.innerHTML = ''; t.innerHTML = '';
                const uniqueLocs = [];
                const seen = new Set();
                data.forEach(loc => {
                    const key = `${loc.city}|${loc.country}`;
                    if (!seen.has(key)) { seen.add(key); uniqueLocs.push(loc); }
                });
                const sorted = uniqueLocs.sort((a, b) => a.city.localeCompare(b.city));

                const popNames = ['United States', 'India', 'United Kingdom', 'Japan', 'China', 'Germany', 'France', 'Australia', 'Canada', 'Switzerland', 'United Arab Emirates', 'Singapore'];
                const topLocs = sorted.filter(c => popNames.includes(c.country));
                const otherLocs = sorted.filter(c => !popNames.includes(c.country));

                appendGroup(f, 'Popular', topLocs);
                appendGroup(f, 'Global Locations', otherLocs);

                appendGroup(t, 'Popular', topLocs);
                appendGroup(t, 'Global Locations', otherLocs);

                // Restore or Default
                if (preserveState && currentVals.f && currentVals.t) {
                    f.value = currentVals.f; t.value = currentVals.t;
                } else {
                    const setDefault = (el, country) => {
                        for (let i = 0; i < el.options.length; i++) {
                            if (el.options[i].getAttribute('data-country') === country) {
                                el.selectedIndex = i; break;
                            }
                        }
                    };
                    setDefault(f, 'United States');
                    setDefault(t, 'India');
                }
            };

            // 1. Render Defaults Immediately
            // 1. Render Defaults Immediately
            await populateDropdowns(globalLocationData);
            // Pre-fill emergency list with static data
            emergencyCountryList = extraCities.map(c => ({ name: c.country, code: c.code }));

            initTimezones(); // Needed for clock

            try {
                // 2. Fetch Country/Currency Data (Background Enhancement)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 4000);

                const res = await fetch('https://restcountries.com/v3.1/all?fields=name,currencies,flags,cca2,capital,timezones', { signal: controller.signal });
                clearTimeout(timeoutId);

                const data = await res.json();



                // 2. Build Base List from Countries (Capitals)
                let apiLocations = data
                    .filter(c => c.currencies && Object.keys(c.currencies).length > 0)
                    .map(c => {
                        const code = Object.keys(c.currencies)[0];
                        const city = (c.capital && c.capital.length > 0) ? c.capital[0] : c.name.common;
                        return {
                            country: c.name.common,
                            code: c.cca2,
                            city: city,
                            flag: c.flags.svg || '',
                            currency: code,
                            symbol: c.currencies[code].symbol,
                            timezone: (c.timezones && c.timezones.length > 0 && (c.timezones[0] === 'UTC' || c.timezones[0].includes('/')))
                                ? c.timezones[0]
                                : null
                        };
                    });

                // 3. Merge and Sort
                const finalApiList = [...extraCities, ...apiLocations];
                // Update Global List
                globalLocationData = finalApiList;

                // Populate Emergency List with FULL data: Countries + Cities
                // Add unique countries with Rich Data
                // countryMap stores: name -> { code, official }
                const countryMap = new Map();
                data.forEach(c => {
                    countryMap.set(c.name.common, { code: c.cca2, official: c.name.official });
                });

                let eList = [];

                // 1. Add Countries
                countryMap.forEach((meta, name) => {
                    eList.push({ name: name, official: meta.official, code: meta.code, type: 'country' });
                });

                // 2. Add Cities
                globalLocationData.forEach(loc => {
                    if (loc.city && loc.code) {
                        // Find parent official name
                        let parentMeta = countryMap.get(loc.country);
                        let parentOfficial = parentMeta ? parentMeta.official : loc.country;
                        eList.push({ 
                            name: loc.city, 
                            official: parentOfficial, // City inherits country official name for display context
                            code: loc.code, 
                            type: 'city', 
                            parent: loc.country 
                        });
                    }
                });

                emergencyCountryList = eList;

                await populateDropdowns(globalLocationData);

            } catch (e) {
                console.warn('Fiscal API failed or timed out, keeping default list.', e);
            }


            // End Init
        }





        async function fetchLatestRates(shouldConvert = true) {
            const rawVal = document.getElementById('fromCurrency').value;
            // Ensure we have a value. If list empty (load error), return.
            if (!rawVal) return;

            const f = rawVal.split('|')[0];
            try {
                // Using a fallback or free API
                const res = await fetch(`https://open.er-api.com/v6/latest/${f}`);
                const data = await res.json();
                window.baseCurrencyRates = data.rates;

                const updateEl = document.getElementById('lastExchangeUpdate');

                if (updateEl) {
                    updateEl.innerText = `Last Synced: ${new Date().toLocaleTimeString()} (${f})`;
                }

                // Only convert if requested (user action)
                if (shouldConvert) convertCurrency();

            } catch (e) { console.error('Rate Fetch Error:', e); }
        }

        async function convertCurrency() {
            const amount = parseFloat(document.getElementById('amountInput').value) || 0;
            const fEl = document.getElementById('fromCurrency');
            const tEl = document.getElementById('toCurrency');

            const rawF = fEl.value;
            const rawT = tEl.value;
            if (!rawF || !rawT) return;

            const f = rawF.split('|')[0];
            const t = rawT.split('|')[0];

            // Logic to update stored context based on user interaction
            const getMeta = (el) => {
                const opt = el.options[el.selectedIndex];
                if (!opt) return null;
                return {
                    city: opt.getAttribute('data-city'),
                    country: opt.getAttribute('data-country'),
                    currency: opt.getAttribute('data-currency'),
                    timezone: opt.getAttribute('data-timezone')
                };
            };

            let targetMeta = getMeta(tEl);
            let baseMeta = getMeta(fEl);

            if (!currencyContext || (currencyContext.country !== baseMeta.country && currencyContext.country !== targetMeta.country)) {
                currencyContext = targetMeta;
            }

            const display = document.getElementById('currencyResult');

            if (!window.baseCurrencyRates || !window.baseCurrencyRates[t]) {
                display.innerHTML = `<div class="loading-state">Syncing New Base Rates...</div>`;
                await fetchLatestRates();
                // Check again
                if (!window.baseCurrencyRates || !window.baseCurrencyRates[t]) return;
            }

            const rate = window.baseCurrencyRates[t];
            const calc = amount * rate;

            // Check Context for Location Display
            let locationDisplay = '';

            if (currencyContext) {
                let contextMatch = null;
                if (currencyContext.country === baseMeta.country) contextMatch = 'Base';
                else if (currencyContext.country === targetMeta.country) contextMatch = 'Target';

                if (contextMatch) {
                    // Calculate Time
                    let timeStr = '';
                    if (currencyContext.timezone) {
                        try {
                            const now = new Date();
                            const time = now.toLocaleTimeString('en-US', { timeZone: currencyContext.timezone, hour: '2-digit', minute: '2-digit' });
                            const date = now.toLocaleDateString('en-US', { timeZone: currencyContext.timezone, day: 'numeric', month: 'short' });
                            timeStr = `<div style="font-size: 0.75rem; opacity: 0.8; margin-top: 2px;">
                                                                                                                                                                                                                                                             <i class="fas fa-clock" style="font-size:0.7em"></i> ${date} • ${time}
                                                                                                                                                                                                                                                           </div>`;
                        } catch (e) { }
                    }

                    const label = contextMatch === 'Base' ? 'Base Location' : 'Target Location';
                    const city = currencyContext.city;
                    const country = currencyContext.country;

                    const colorVar = contextMatch === 'Base' ? 'var(--accent-primary)' : 'var(--accent-emerald)';
                    const bgVar = contextMatch === 'Base' ? 'rgba(88, 166, 255, 0.1)' : 'rgba(52, 211, 153, 0.1)';
                    const borderVar = contextMatch === 'Base' ? 'rgba(88, 166, 255, 0.2)' : 'rgba(52, 211, 153, 0.2)';

                    locationDisplay = `<div style="text-align:center; margin-bottom: 12px; color: ${colorVar}; background: ${bgVar}; padding: 8px; border-radius: 8px; border: 1px solid ${borderVar};">
                                                                                                                                                                                                                                                             <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 4px;">${label}</div>
                                                                                                                                                                                                                                                             <div style="font-weight: 700; font-size: 0.95rem;">
                                                                                                                                                                                                                                                                <i class="fas fa-location-dot"></i> ${city}, ${country}
                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                             ${timeStr}
                                                                                                                                                                                                                                                           </div>`;
                }
            }


            display.innerHTML = `
                                                                                                                                                                                                                                    ${locationDisplay}
                                                                                                                                                                                                                                        <div class="val-grid">
                                                                                                                                                                                                                                            <div class="val-box slide-in highlight-border">
                                                                                                                                                                                                                                                <div class="val-label">${f}</div>
                                                                                                                                                                                                                                                <div class="val-number">${amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                                                                                                                                                                                                                                                <div class="val-loc-meta">Base Amount</div>
                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                            <div class="val-box slide-in">
                                                                                                                                                                                                                                                <div class="val-label">${t}</div>
                                                                                                                                                                                                                                                <div class="val-number highlight">${calc.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                                                                                                                                                                                                                                 <div class="val-loc-meta">Rate: ${rate.toFixed(4)}</div>
                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                        </div>`;
        }

        /* --- TIMEZONE LOGIC --- */
        function initTimezones() {
            const select = document.getElementById('timezoneSelect');
            if (!select) return;

            // Preserve current selection if possible
            const currentVal = select.value;
            select.innerHTML = '';

            // USE globalLocationData (Shared Dataset)
            // Filter out entries that have garbage timezones (like "UTC+05:00") if we want strict IANA,
            // BUT for the "System" to work, we accept what we have.
            // Ideally we prioritized the `extraCities` for good IANA zones.

            globalLocationData.forEach(loc => {
                let tzValue = loc.timezone;
                // Only add if we have a valid timezone string
                if (!tzValue) return;

                const opt = document.createElement('option');
                opt.value = tzValue;
                opt.text = `${loc.city}, ${loc.country}`;
                opt.setAttribute('data-full', tzValue);
                if (tzValue === currentVal) opt.selected = true;
                select.appendChild(opt);
            });

            // Default if nothing selected
            if (select.selectedIndex === -1) {
                // Try to select Mumbai or New York
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value.includes('Kolkata') || select.options[i].value.includes('New_York')) {
                        select.selectedIndex = i;
                        break;
                    }
                }
            }

            updateConvertedTime();
        }

        // Helper to get rigorous locale for formatting
        function getCurrentLocale() {
            const lang = (window.translator && window.translator.currentLang) ? window.translator.currentLang : 'en';
            const map = {
                'en': 'en-US',
                'es': 'es-ES',
                'fr': 'fr-FR',
                'de': 'de-DE',
                'hi': 'hi-IN',
                'gu': 'gu-IN',
                'zh': 'zh-CN',
                'ja': 'ja-JP',
                'ru': 'ru-RU',
                'ar': 'ar-EG'
            };
            return map[lang] || 'en-US';
        }

        function runChronos() {
            try {
                const now = new Date();
                const locale = getCurrentLocale();

                const dateEl = document.getElementById('headerDate');
                if (dateEl) {
                    // Use format: Weekday, Month Day, Year (in locale)
                    // e.g. Friday, January 23, 2026
                    dateEl.innerText = now.toLocaleDateString(locale, {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }

                const timeEl = document.getElementById('headerTime');
                if (timeEl) {
                    timeEl.innerText = now.toLocaleTimeString(locale, { hour12: false });
                    // Should we use hour12 based on locale? Default is usually good.
                    // But military time is often preferred in dashboards. 
                    // Let's stick to locale default but maybe force 2-digit? 
                    // User said "clean, readable format similar to English".
                    // Most locales do HH:mm:ss nicely.
                    // Actually, let's trust the locale default for TimeString.
                    timeEl.innerText = now.toLocaleTimeString(locale);
                }

                const localLargeEl = document.getElementById('localTimeLarge');
                if (localLargeEl) localLargeEl.innerText = now.toLocaleTimeString(locale);

                // Also update the accent box if it exists
                if (typeof updateConvertedTime === 'function') updateConvertedTime();
            } catch (e) {
                console.error("Chronos Error:", e);
                // Hard Fallback
                try {
                    const fb = new Date().toLocaleTimeString();
                    if (document.getElementById('headerTime')) document.getElementById('headerTime').innerText = fb;
                } catch (z) { }
            }
        }

        function updateConvertedTime() {
            const zone = document.getElementById('timezoneSelect').value;
            const now = new Date();
            const locale = getCurrentLocale();

            try {
                const timeString = now.toLocaleTimeString(locale, { timeZone: zone });
                const dateString = now.toLocaleDateString(locale, { timeZone: zone, weekday: 'short', month: 'short', day: 'numeric' });

                // Get offset safely - keeping this part English-y or technical is often better for "GMT+5" etc.
                // But let's try locale.
                const typePart = Intl.DateTimeFormat(locale, { timeZone: zone, timeZoneName: 'longOffset' }).formatToParts(now).find(p => p.type === 'timeZoneName');
                const type = typePart ? typePart.value : zone;

                document.getElementById('convertedTime').innerHTML = `<div class="no-translate">${timeString} <span style="font-size:0.5em; opacity:0.7; display:block;">${dateString} • ${type}</span></div>`;
            } catch (e) {
                console.error("Time calc error", e);
            }
        }

        // --- NEWS FEED ---
        // Redirects to dedicated Details page

        function triggerNewsSearch() {
            const val = document.getElementById('newsInput').value;
            if (!val) {
                // Default to Global Technology if empty? Or do nothing?
                // Requirement: "When the user searches..." implication is explicit action.
                // But let's provide a default if they click empty search.
                window.location.href = '/News/Details?query=Global%20Technology';
                return;
            }

            // Treat comma as strict location signal
            let query = val;
            let fallback = '';

            if (val.includes(',')) {
                // If "City, Country", pass both.
                // details page logic uses fallbackQuery if query fails.
                // But wait, the Details page expects "query" to be the main search.
                // If I pass "Paris, France", logic there handles it.
                // We can separate for fallback purposes.
                fallback = val.split(',').pop().trim();
            }

            window.location.href = `/News/Details?query=${encodeURIComponent(query)}&fallbackQuery=${encodeURIComponent(fallback)}`;
        }

        // Removed fetchGlobalNews and related rendering logic as results are now shown on separate page.


        // --- NOTES SYSTEM ---
        let currentNotes = [];

        async function initNotes() {
            fetchNotes();
        }

        async function fetchNotes() {
            const container = document.getElementById('notesList');
            try {
                const res = await fetch('/Notes/GetAll');
                if (res.ok) {
                    const notes = await res.json();
                    renderNotes(notes);
                } else {
                    if (container) {
                        container.innerHTML = `<div class="text-danger">Error loading notes</div>`;
                    }
                }
            } catch (e) {
                if (container) {
                    container.innerHTML = `<div class="text-danger">Connection Error</div>`;
                }
            }
        }

        function renderNotes(notes) {
            currentNotes = notes;
            const container = document.getElementById('notesList');
            if (!container) return;
            container.innerHTML = '';

            if (notes.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;">No Notes Found</div>`;
                return;
            }

            notes.forEach(note => {
                const locale = getCurrentLocale();
                const date = new Date(note.createdDate).toLocaleDateString(locale, { year: 'numeric', month: 'short', day: 'numeric' });
                const div = document.createElement('div');
                div.className = 'note-item slide-in';
                div.onclick = (e) => {
                    if (e.target.closest('.btn-note-action')) return;
                    editNote(note.id);
                };
                div.innerHTML = `
                                                                                                                                                                                                                                                                            <div class="note-header">
                                                                                                                                                                                                                                                                                <div class="note-title">${escapeHtml(note.title)}</div>
                                                                                                                                                                                                                                                                                <div class="note-date">${date}</div>
                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                            <div class="note-desc">${escapeHtml(note.description)}</div>
                                                                                                                                                                                                                                                                            <div class="note-actions">
                                                                                                                                                                                                                                                                                <button class="btn-note-action" onclick="event.stopPropagation(); editNote(${note.id})"><i class="fas fa-edit"></i></button>
                                                                                                                                                                                                                                                                                <button class="btn-note-action delete" onclick="event.stopPropagation(); deleteNote(${note.id})"><i class="fas fa-trash"></i></button>
                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                        `;
                container.appendChild(div);
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        }

        async function searchGlobalIntel() {
            const query = document.getElementById('globalSearchInput').value;
            if (!query) return;
            window.location.href = `/Home/CountryDetails?name=${encodeURIComponent(query)}`;
        }

        async function renderGlobalResult(loc, country) {
            const display = document.getElementById('globalSearchResult');

            // Safe currency access
            let currency = { name: 'N/A', symbol: '' };
            if (country && country.currencies) {
                const keys = Object.keys(country.currencies);
                if (keys.length > 0) currency = country.currencies[keys[0]];
            }

            // Await all translations independently
            const cityName = await window.translator.translateText(loc.name);
            const countryName = country ? await window.translator.translateText(country.name.common) : '';
            const region = country ? await window.translator.translateText(country.region) : '';
            const capital = (country && country.capital && country.capital.length > 0) ? await window.translator.translateText(country.capital[0]) : 'N/A';
            const currName = currency.name !== 'N/A' ? await window.translator.translateText(currency.name) : 'N/A';

            // Labels
            const l_coords = await window.translator.translateText('Coordinates');
            const l_timezone = await window.translator.translateText('Chronos Sync');
            const l_curr = await window.translator.translateText('Currency');
            const l_pop = await window.translator.translateText('Population');
            const l_cap = await window.translator.translateText('Capital');
            const l_reg = await window.translator.translateText('Region');

            // --- BUILD HTML SAFELY ---

            let html = '<div class="result-card slide-in" style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 20px; border: 1px solid var(--border-dim);">';

            // Header
            html += '<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 16px;">';
            html += '<div>';
            html += '<div style="font-size: 1.5rem; font-weight: 800; color: var(--text-bright);">' + cityName + '</div>';

            let subText = (loc.admin1 || '') + (country ? ', ' + countryName : '');
            html += '<div style="color: var(--text-muted); font-size: 0.9rem;">' + subText + '</div>';
            html += '</div>';

            if (country && country.flag) {
                html += '<div style="font-size: 2.5rem; line-height: 1;">' + country.flag + '</div>';
            }
            html += '</div>'; // End Header

            // Stats
            html += '<div class="stats-deep" style="grid-template-columns: 1fr 1fr; margin-top: 0;">';

            // Coords
            html += '<div class="stat-box" style="padding: 12px;">';
            html += '<label>' + l_coords + '</label>';
            html += '<b>' + loc.latitude.toFixed(2) + ', ' + loc.longitude.toFixed(2) + '</b>';
            html += '</div>';

            // Timezone
            html += '<div class="stat-box" style="padding: 12px;">';
            html += '<label>' + l_timezone + '</label>';
            html += '<b style="font-size: 1rem;">' + loc.timezone + '</b>';
            html += '</div>';

            html += '</div>'; // End Top Stats

            // Bottom Stats (Country only)
            if (country) {
                const popM = (country.population / 1000000).toFixed(1) + 'M';

                html += '<div class="stats-deep" style="grid-template-columns: 1fr 1fr; margin-top: 12px;">';

                // Currency
                html += '<div class="stat-box" style="padding: 12px;">';
                html += '<label>' + l_curr + '</label>';
                html += '<b>' + currency.symbol + ' ' + currName + '</b>';
                html += '</div>';

                // Pop
                html += '<div class="stat-box" style="padding: 12px;">';
                html += '<label>' + l_pop + '</label>';
                html += '<b>' + popM + '</b>';
                html += '</div>';

                // Cap
                html += '<div class="stat-box" style="padding: 12px;">';
                html += '<label>' + l_cap + '</label>';
                html += '<b>' + capital + '</b>';
                html += '</div>';

                // Reg
                html += '<div class="stat-box" style="padding: 12px;">';
                html += '<label>' + l_reg + '</label>';
                html += '<b>' + region + '</b>';
                html += '</div>';

                html += '</div>';
            }

            // Sync Badge
            html += '<div style="margin-top:16px; text-align:center;">';
            html += '<span style="color:var(--accent-success); font-size:0.8rem; display:block; margin-bottom:8px;">';
            html += '<i class="fas fa-check-circle"></i> Dashboard Synced';
            html += '</span></div></div>';

            display.innerHTML = html;

            // Auto-Sync Dashboard
            syncDashboardToLocation(loc, country);
        }

        async function syncDashboardToLocation(loc, country) {
            // 1. Sync Weather
            if (loc.latitude && loc.longitude) {
                fetchWeatherDeep(loc.latitude, loc.longitude, `${loc.name}, ${loc.country_code}`);
            }

            // 2. Sync Timezone
            if (loc.timezone) {
                const tzSelect = document.getElementById('timezoneSelect');
                let exists = false;
                for (let i = 0; i < tzSelect.options.length; i++) {
                    if (tzSelect.options[i].value === loc.timezone) {
                        tzSelect.selectedIndex = i;
                        exists = true;
                        break;
                    }
                }

                // If not in list (rare given we load all), attempt to add it or find formatted match
                if (!exists) {
                    // Try to find by raw value
                    const opt = document.createElement('option');
                    opt.value = loc.timezone;
                    opt.text = `${loc.name}, ${loc.country_code}`; // Fallback format
                    opt.selected = true;
                    tzSelect.add(opt);
                }
                updateConvertedTime();

                // Highlight effect
                const chronoCard = document.querySelector('.chrono-hub');
                if (chronoCard) {
                    chronoCard.style.borderColor = 'var(--accent-indigo)';
                    setTimeout(() => chronoCard.style.borderColor = '', 1500);
                }
            }

            // 3. Sync Currency
            if (country && country.currencies) {
                const currencyCode = Object.keys(country.currencies)[0];
                const tSelect = document.getElementById('toCurrency');

                // Update Context
                currencyContext = {
                    city: loc.name,
                    country: country.name.common,
                    currency: currencyCode,
                    timezone: loc.timezone
                };

                // Find matching option for country/currency
                // We prioritize country match
                let found = false;
                for (let i = 0; i < tSelect.options.length; i++) {
                    const opt = tSelect.options[i];
                    if (opt.getAttribute('data-country') === country.name.common || opt.value.split('|')[0] === currencyCode) {
                        tSelect.selectedIndex = i;
                        found = true;
                        break;
                    }
                }

                if (found) {
                    convertCurrency();

                    // Highlight effect
                    const currencyCard = document.querySelector('.currency-hub');
                    if (currencyCard) {
                        currencyCard.style.borderColor = 'var(--accent-emerald)';
                        setTimeout(() => currencyCard.style.borderColor = '', 1500);
                    }
                }
            }

            // 4. News Sync - DISABLED AUTO FETCH
            // User must manually trigger news search to save bandwidth/quota
            // const cityQuery = `"${loc.name}" "${country.name.common}"`;
            // const countryQuery = `"${country.name.common}"`;
            // fetchGlobalNews(cityQuery, countryQuery);
        }

        let isFormVisible = false;

        async function toggleNoteForm(forceState) {
            const form = document.getElementById('noteFormArea');
            const btn = document.getElementById('btnNewNote');

            if (typeof forceState !== 'undefined') {
                isFormVisible = forceState;
            } else {
                isFormVisible = !isFormVisible;
            }

            if (isFormVisible) {
                form.style.display = 'block';
                btn.style.display = 'none';

                if (!document.getElementById('noteId').value) {
                    document.getElementById('noteTitle').value = '';
                    document.getElementById('noteDesc').value = '';
                    const newNoteTitle = await window.translator.translateText('New Note');
                    document.getElementById('formTitle').innerText = newNoteTitle;
                    document.getElementById('formTitle').setAttribute('data-i18n', 'NewNote');
                }
            } else {
                form.style.display = 'none';
                btn.style.display = 'block';
                document.getElementById('noteId').value = '';
            }
        }

        async function editNote(id) {
            const note = currentNotes.find(n => n.id === id);
            if (!note) return;

            document.getElementById('noteId').value = id;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteDesc').value = note.description;
            const editTitle = await window.translator.translateText('Edit Note');
            document.getElementById('formTitle').innerText = editTitle;
            document.getElementById('formTitle').setAttribute('data-i18n', 'EditNote');

            toggleNoteForm(true);
        }

        async function saveNote() {
            const title = document.getElementById('noteTitle').value;
            const desc = document.getElementById('noteDesc').value;
            const id = document.getElementById('noteId').value;

            if (!title || !desc) {
                alert(await window.translator.translateText('Please fill all fields'));
                return;
            }

            const url = id ? '/Notes/Update' : '/Notes/Create';
            const body = { title: title, description: desc };
            if (id) body.id = parseInt(id);

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    toggleNoteForm(false);
                    fetchNotes();
                } else {
                    const errSave = await window.translator.translateText('Error saving note');
                    alert(errSave);
                }
            } catch (e) {
                const errSave = await window.translator.translateText('Error saving note');
                alert(errSave);
            }
        }

        async function deleteNote(id) {
            const confirmText = await window.translator.translateText('Are you sure you want to delete this note?');
            if (!confirm(confirmText)) return;
            try {
                const res = await fetch('/Notes/Delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(id)
                });
                if (res.ok) {
                    fetchNotes();
                } else {
                    alert(await window.translator.translateText('Error deleting note'));
                }
            } catch (e) {
                console.error(e);
                alert(await window.translator.translateText('Error deleting note'));
            }
        }


        // --- EMERGENCY CONTACTS ---
        // --- EMERGENCY CONTACTS ---
        let emergencySearchTimer = null;
        let lastEmergencyCode = null;

        let currentSearchQuery = "";

        // Global state for strict race condition handling
        let latestEmergencyRequestId = 0;

        function handleEmergencySearch() {
            const input = document.getElementById('emergencyInput');
            const val = input.value.trim().toLowerCase();
            const dropdown = document.getElementById('emergencyDropdown');

            if (val.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            // 1. Filter Matches
            // emergencyCountryList is populated in initFiscal()
            const matches = emergencyCountryList.filter(c =>
                c.name.toLowerCase().startsWith(val) ||
                c.name.toLowerCase().includes(val)
            );

            // 2. Sort Matches
            matches.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                if (aName === val) return -1;
                if (bName === val) return 1;
                if (aName.startsWith(val) && !bName.startsWith(val)) return -1;
                if (!aName.startsWith(val) && bName.startsWith(val)) return 1;
                return aName.localeCompare(bName);
            });

            // 3. Render Dropdown
            if (matches.length > 0) {
                dropdown.innerHTML = '';
                // Limit to 8 suggestions for clean UI
                matches.slice(0, 8).forEach(match => { 
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    
                    // Highlight match
                    const safeVal = val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`(${safeVal})`, 'gi');
                    const highlighted = match.name.replace(regex, '<span style="color:var(--accent-sky); font-weight:700;">$1</span>');
                    
                    // Format: CODE – Name (Official)
                    // e.g. IN – India (Republic of India)
                    // For cities: IN – Mumbai (India) or simplified?
                    // User Req: "IN – India (Republic of India)"
                    
                    let displayMeta = "";
                    if (match.type === 'country') {
                        displayMeta = `<span style="opacity:0.6; font-size:0.8em; margin-left:6px;">(${match.official})</span>`;
                    } else {
                        displayMeta = `<span style="opacity:0.6; font-size:0.8em; margin-left:6px;">(${match.parent || match.official})</span>`;
                    }

                    div.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-family:monospace; font-weight:700; color:var(--accent-emerald); background:rgba(52,211,153,0.1); padding:2px 6px; border-radius:4px; font-size:0.8em;">${match.code}</span>
                            <div style="display:flex; flex-direction:column; justify-content:center;">
                                <div style="line-height:1.2;">${highlighted} ${displayMeta}</div>
                                ${match.type === 'city' ? `<span style="font-size:0.7em; opacity:0.5; margin-top:2px;">City</span>` : ''}
                            </div>
                        </div>`;
                        
                    div.onclick = () => selectEmergencyCountry(match);
                    dropdown.appendChild(div);
                });
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function selectEmergencyCountry(country) {
            const input = document.getElementById('emergencyInput');
            const dropdown = document.getElementById('emergencyDropdown');
            const container = document.getElementById('emergencyResult');

            input.value = country.name;
            dropdown.style.display = 'none';

            // CLEAR PREVIOUS DATA IMMEDIATELY
            container.innerHTML = '';
            lastEmergencyCode = null; // Reset state

            // Normalized Code
            const normalizedCode = (country.code || '').trim().toUpperCase();

            // Trigger Load
            if (normalizedCode) {
                fetchEmergencyNumbers(normalizedCode, country.name);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const dropdown = document.getElementById('emergencyDropdown');
            const input = document.getElementById('emergencyInput');
            if (dropdown && input) {
                if (!dropdown.contains(e.target) && e.target !== input) {
                    dropdown.style.display = 'none';
                }
            }
        });

        async function fetchEmergencyNumbers(code, countryName) {
            const container = document.getElementById('emergencyResult');
            const requestId = ++latestEmergencyRequestId;

            // Show loading
            container.innerHTML = `<div class="loading-state" style="text-align:center; padding:40px;">
                                    <i class="fas fa-circle-notch fa-spin" style="font-size:2rem; color:var(--accent-sky); margin-bottom:10px;"></i>
                                    <div style="opacity:0.7">Accessing Global Grid...</div>
                                   </div>`;

            try {
                // Ensure code is normalized
                const safeCode = code.trim().toUpperCase();

                const res = await fetch(`/Emergency/GetNumbers?code=${safeCode}`);
                if (!res.ok) throw new Error("API Failure");

                // Race Condition Check: If a newer request started, ignore this result
                if (requestId !== latestEmergencyRequestId) return;

                const data = await res.json();

                if (!data || !data.data) {
                    throw new Error("No data");
                }

                renderEmergency(data.data, countryName);

            } catch (e) {
                 if (requestId !== latestEmergencyRequestId) return;
                 console.error(e);
                 container.innerHTML = `<div class="empty-state">
                                            <i class="fas fa-triangle-exclamation" style="color:#ef4444"></i>
                                            <p>Emergency Protocols Not Found for <b>${countryName}</b></p>
                                       </div>`;
            }
        }

        function renderEmergency(data, countryName) {
            const container = document.getElementById('emergencyResult');
            let html = '<div class="emergency-cards slide-in">';

            // Helper to get best number
            const getNum = (specificList) => {
                if (specificList && specificList.length > 0) {
                     const valid = specificList.filter(n => n && n.trim().length > 0);
                     if (valid.length > 0) return valid;
                }
                return null;
            };

            // 1. Unified Logic (Dispatch/112/911/999)
            let unifiedNums = null;
            if (data.dispatch && data.dispatch.all && data.dispatch.all.length > 0) {
                unifiedNums = getNum(data.dispatch.all);
            } else if (data.member_112) {
                unifiedNums = ['112']; // EU Standard
            } 
            // Fallback for known unifiers if data missing? 
            // If we have nothing at all, we shouldn't guess, but US/UK is 911/999 usually handled by API.

            // 2. Specifics
            const policeNums = getNum(data.police ? data.police.all : null);
            const ambNums = getNum(data.ambulance ? data.ambulance.all : null);
            const fireNums = getNum(data.fire ? data.fire.all : null);

            // Data Validity Check
            const isTotalFailure = !unifiedNums && !policeNums && !ambNums && !fireNums;

            if (isTotalFailure) {
                 container.innerHTML = `<div class="empty-state">
                                            <i class="fas fa-triangle-exclamation" style="color:#ef4444"></i>
                                            <p>Emergency numbers not available for this location.</p>
                                       </div>`;
                 return;
            }

            const createCard = (type, label, icon, numbers, isHighlight = false) => {
                const isAvail = numbers !== null && numbers.length > 0;
                
                // If unified unavailable, don't show card. But if specific unavailable, show "Unavailable"
                if (!isAvail && isHighlight) return ''; 

                const numStr = isAvail ? numbers.join(' / ') : 'Not Available';
                const availClass = isAvail ? '' : 'unavailable';
                const highlightClass = isHighlight ? 'unified-card' : '';
                
                return `<div class="emergency-number-card ${type} ${availClass} ${highlightClass}">
                        <div class="card-icon-wrapper">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="em-info">
                            <span class="em-label">${label}</span>
                            <span class="em-number">${numStr}</span>
                        </div>
                        ${isAvail ? `<button class="copy-btn" onclick="navigator.clipboard.writeText('${numbers[0]}')" title="Copy"><i class="fas fa-copy"></i></button>` : ''}
                    </div>`;
            };

            // RENDER CARDS
            // 1. Unified (Red Alert Highlight)
            html += createCard('dispatch', 'Unified Emergency', 'fa-tower-broadcast', unifiedNums, true);
            
            // 2. Police
            html += createCard('police', 'Police', 'fa-shield-halved', policeNums);

            // 3. Ambulance
            html += createCard('ambulance', 'Ambulance', 'fa-truck-medical', ambNums);

            // 4. Fire
            html += createCard('fire', 'Fire Dept', 'fa-fire-extinguisher', fireNums);

            html += '</div>';

            // Disclaimer
            html += `<div style="margin-top:16px; text-align:center; font-size:0.7rem; color:var(--text-muted); opacity:0.6;">
                        <i class="fas fa-circle-info"></i> Emergency numbers may vary by region. Verify locally if possible.
                     </div>`;

            container.innerHTML = html;
        }

        // --- TRANSLATOR WIDGET LOGIC ---
        async function translateWidget() {
            const input = document.getElementById('transInput').value.trim();
            const lang = document.getElementById('transLangSelect').value;
            const output = document.getElementById('transOutput');
            const btn = document.getElementById('btnTranslateAction');
            const btnCopy = document.getElementById('btnCopyTrans');

            if (!input) return;

            // UI Loading
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            output.innerHTML = `<div class="loading-state" style="width:100%; text-align:center; margin-top:30px;">Processing Neural Link...</div>`;
            btnCopy.style.display = 'none';

            try {
                const res = await fetch('/api/Translation/translate-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Texts: [input],
                        TargetLanguage: lang
                    })
                });

                if (!res.ok) throw new Error("Translation Failed");

                const result = await res.json();
                
                // Result is Dictionary<string, string>
                const translatedText = result[input] || "Error: Could not translate.";

                output.innerHTML = `<div class="slide-in">${escapeHtml(translatedText)}</div>`;
                btnCopy.style.display = 'block';

            } catch (e) {
                console.error(e);
                output.innerHTML = `<div class="text-danger" style="text-align:center; width:100%; margin-top:30px;">Translation System Offline</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-arrow-right-arrow-left"></i>';
            }
        }

        function copyTranslation() {
            const output = document.getElementById('transOutput').innerText;
            if (output) {
                navigator.clipboard.writeText(output);
                // Visual feedback
                const btn = document.getElementById('btnCopyTrans');
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check" style="color:var(--accent-emerald)"></i>';
                setTimeout(() => btn.innerHTML = original, 2000);
            }
        }



        // --- HABIT TRACKER LOGIC ---
        let habits = [];
        let editingHabitId = null; 

        function initHabits() {
            const stored = localStorage.getItem('userHabits');
            if (stored) {
                habits = JSON.parse(stored);
                // Schema Migration: If old schema (completed/completedDate), convert to history
                habits.forEach(h => {
                    if (!h.history) {
                        h.history = [];
                        if (h.completed && h.completedDate) {
                            h.history.push(new Date(h.completedDate).toDateString());
                        }
                        // Clean old props
                        delete h.completed;
                        delete h.completedDate;
                    }
                });
            }
            renderHabits();
        }

        // Helper to get formatted date string for consistency
        function getTodayStr() {
            return new Date().toDateString();
        }

        function saveHabits() {
            localStorage.setItem('userHabits', JSON.stringify(habits));
            renderHabits();
        }

        function renderHabits() {
            const list = document.getElementById('habitList');
            if (!habits || habits.length === 0) {
                list.innerHTML = `<div class="empty-state">
                                    <i class="fas fa-seedling" style="color:var(--accent-green)"></i>
                                    <p>Start building good habits!</p>
                                  </div>`;
                return;
            }

            const todayStr = getTodayStr();
            const now = new Date();
            // Get Monday of current week for calculation
            const day = now.getDay();
            const diff = now.getDate() - day + (day == 0 ? -6 : 1);
            const monday = new Date(new Date(now).setDate(diff)).setHours(0,0,0,0);

            list.innerHTML = '';
            habits.forEach(h => {
                // Calculate Status & Progress
                let isDoneToday = h.history.includes(todayStr);
                let progress = 0;

                if (h.type === 'daily') {
                    progress = isDoneToday ? 100 : 0;
                } else if (h.type === 'weekly') {
                    // Count unique days in history that are >= this week's Monday
                    const distinctDaysThisWeek = h.history.filter(dateStr => {
                        return new Date(dateStr).getTime() >= monday;
                    });
                     // Let's say weekly goal is 7 days for max progress, or just reflect 'days done'
                     // User req: "completed days in current week"
                     // We display percentage relative to 7 days
                     const count = new Set(distinctDaysThisWeek).size;
                     progress = Math.min(100, Math.round((count / 7) * 100));
                }
                
                const div = document.createElement('div');
                div.className = `habit-item ${isDoneToday ? 'completed' : ''}`;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:12px; flex:1;">
                            <div class="custom-checkbox ${isDoneToday ? 'checked' : ''}" onclick="toggleHabit('${h.id}')">
                                ${isDoneToday ? '<i class="fas fa-check"></i>' : ''}
                            </div>
                            <div style="flex:1;">
                                <div class="habit-name">${escapeHtml(h.name)}</div>
                                <div class="habit-meta">
                                    <span class="badge badge-${h.type}">${h.type}</span>
                                    <span style="margin-left:8px; opacity:0.7;">${progress}%</span>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex; gap:4px;">
                             <button class="icon-btn edit-habit-btn" onclick="editHabit('${h.id}')" title="Edit"><i class="fas fa-pen"></i></button>
                             <button class="icon-btn delete-habit-btn" onclick="deleteHabit('${h.id}')" title="Delete"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width:${progress}%; background-color:${progress > 0 ? 'var(--accent-green)' : 'transparent'};"></div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function toggleAddHabitForm(reset = true) {
            const form = document.getElementById('addHabitForm');
            const btn = document.getElementById('showAddHabitBtn');
            const submitBtn = form.querySelector('.btn-primary'); // The add button
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                btn.style.display = 'none';
                document.getElementById('newHabitName').focus();
                
                // Reset mode to Add just in case
                if (reset) {
                    editingHabitId = null;
                    document.getElementById('newHabitName').value = '';
                    submitBtn.innerHTML = '<i class="fas fa-plus"></i>';
                }
            } else {
                form.style.display = 'none';
                btn.style.display = 'block';
                if(reset) {
                    document.getElementById('newHabitName').value = '';
                    editingHabitId = null;
                }
            }
        }

        function saveNewHabit() {
            const nameInput = document.getElementById('newHabitName');
            const typeInput = document.getElementById('newHabitType');
            const name = nameInput.value.trim();
            const type = typeInput.value;
            
            if (!name) return;

            if (editingHabitId) {
                // UPDATE Existing
                const h = habits.find(x => x.id === editingHabitId);
                if (h) {
                    h.name = name;
                    h.type = type;
                    saveHabits();
                }
                editingHabitId = null;
            } else {
                // CREATE New
                habits.push({
                    id: Date.now().toString(),
                    name: name,
                    type: type,
                    history: []
                });
                saveHabits();
            }
            
            toggleAddHabitForm(true);
        }

        function editHabit(id) {
            const h = habits.find(x => x.id === id);
            if (!h) return;

            // Populate form
            document.getElementById('newHabitName').value = h.name;
            document.getElementById('newHabitType').value = h.type;
            
            // Set state
            editingHabitId = id;

            // Show form
            const form = document.getElementById('addHabitForm');
            const btn = document.getElementById('showAddHabitBtn');
            const submitBtn = form.querySelector('.btn-primary');

            form.style.display = 'block';
            btn.style.display = 'none';
            submitBtn.innerHTML = '<i class="fas fa-check"></i>'; // Change icon to tick
            document.getElementById('newHabitName').focus();
        }

        function toggleHabit(id) {
            const h = habits.find(x => x.id === id);
            if (h) {
                const todayStr = getTodayStr();
                if (h.history.includes(todayStr)) {
                    // Remove (Undo)
                    h.history = h.history.filter(d => d !== todayStr);
                } else {
                    // Add (Complete)
                    h.history.push(todayStr);
                }
                saveHabits();
            }
        }

        function deleteHabit(id) {
            if (confirm('Delete this habit?')) {
                habits = habits.filter(x => x.id !== id);
                saveHabits();
            }
        }

        $(document).ready(function () {

            // 1. Critical Base Systems (Clock, basic UI)
            if (typeof runChronos === 'function') {
                runChronos();
                setInterval(runChronos, 1000);
            } else {
                console.error("runChronos not defined!");
            }

            // 2. Data Initialization (Fail-safe wrapper)
            try { initNodeDirectory(); } catch (e) { console.error('NodeDir failed:', e); }
            try { initFiscal(); } catch (e) { console.error('Fiscal failed:', e); }
            try { initNotes(); } catch (e) { console.error('Notes failed:', e); }
            try { initHabits(); } catch (e) { console.error('Habits failed:', e); }

            // Re-bind events to ensure interactivity persists
            const fC = document.getElementById('fromCurrency');
            const tC = document.getElementById('toCurrency');
            const aI = document.getElementById('amountInput');
            if (fC) fC.onchange = fetchLatestRates;
            if (tC) tC.onchange = convertCurrency;
            if (aI) aI.oninput = convertCurrency;
        });
        $(document).on('languageChanged', function (e, lang) {
            console.log('Dashboard detected language change:', lang);
            runChronos();
            renderNodes(allNodes);
            initFiscal(true); // Re-render dropdowns with new language labels, PRESERVING SELECTION
            // renderNews(); // Removed as it is not defined
            fetchNotes(); // Re-fetch notes (if we had server-side loc, but actually notes are user content)
        });

        // Refresh dynamic form elements on language change
        $(document).on('languageChanged', function (e, lang) {
            const isEdit = document.getElementById('noteId').value !== '';
            const titleKey = isEdit ? 'EditNote' : 'NewNote';
            if (isFormVisible) {
                document.getElementById('formTitle').innerText = window.i18n.t(titleKey);
            }
        });
    </script>
}
