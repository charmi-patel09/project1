@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["GlobalIntelligenceDashboard"];
    ViewData["TitleKey"] = "GlobalIntelligenceDashboard";
}

<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap"
    rel="stylesheet">

<div class="dashboard-shell">
    <div class="dashboard-content">
        <!-- Persistent Header -->
        <header class="main-header">
            <div class="header-brief">
                <div class="status-chip">
                    <span class="pulse-dot"></span>
                    <span data-i18n="GlobalSatelliteLinkActive">@Localizer["GlobalSatelliteLinkActive"]</span>
                </div>
                <h1 data-i18n="IntelligenceHub">@Localizer["IntelligenceHub"]</h1>
                <p><span data-i18n="TelemetryFor">@Localizer["TelemetryFor"]</span> <span
                        class="accent-text">@(Context.Session.GetString("AdminUser") ??
                        Context.Session.GetString("StudentUser") ?? Localizer["Operator"].Value)</span>.</p>
            </div>
            <div class="header-chrono">
                <div class="chrono-date" id="headerDate">--/--/----</div>
                <div class="chrono-time no-translate" id="headerTime">00:00:00</div>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Global Search Hub -->
            <section class="tool-card global-search-hub">
                <div class="card-title">
                    <div class="title-icon cyan-glow">
                        <i class="fas fa-globe-americas"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="GlobalSearch">@Localizer["GlobalSearch"]</h3>
                        <p data-i18n="SearchPlaceholder">@Localizer["SearchPlaceholder"]</p>
                    </div>
                </div>

                <div class="hub-controls">
                    <div class="search-field">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearchInput" data-i18n-placeholder="SearchPlaceholder"
                            placeholder="@Localizer["SearchPlaceholder"]"
                            onkeypress="if(event.key === 'Enter') searchGlobalIntel()">
                    </div>
                    <div class="action-group">
                        <button onclick="searchGlobalIntel()" class="btn-primary"
                            data-i18n="Analyze">@Localizer["Analyze"]</button>
                    </div>
                </div>

                <div id="globalSearchResult" class="hub-display" style="gap: 12px;">
                    <!-- Results -->
                </div>
            </section>

            <!-- Weather Card -->
            <section class="tool-card weather-hub">
                <div class="card-title">
                    <div class="title-icon sky-glow">
                        <i class="fas fa-satellite"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="Weather">@Localizer["Weather"]</h3>
                        <p data-i18n="DeepSpaceMeteorologicalTelemetry">@Localizer["DeepSpaceMeteorologicalTelemetry"]
                        </p>
                    </div>
                </div>

                <div class="hub-controls">
                    <div class="search-field">
                        <i class="fas fa-magnifying-glass"></i>
                        <input type="text" id="cityInput" data-i18n-placeholder="LocateAnyCityOrCountry"
                            placeholder="@Localizer["LocateAnyCityOrCountry"]"
                            onkeypress="if(event.key === 'Enter') getWeather()">
                    </div>
                    <div class="action-group">
                        <button onclick="getWeather()" class="btn-primary"
                            data-i18n="Analyze">@Localizer["Analyze"]</button>
                        <button onclick="getCurrentLocation()" class="btn-icon" title="Local coordinates"><i
                                class="fas fa-location-crosshairs"></i></button>
                    </div>
                </div>

                <div class="hub-display">
                    <div id="weatherResult" class="primary-result">
                        <div style="padding: 20px; text-align: center; color: var(--text-muted); opacity: 0.8;">
                            <i class="fas fa-satellite" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                            <p data-i18n="LocateAnyCityOrCountry">@Localizer["LocateAnyCityOrCountry"]</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Fiscal Exchange Card -->
            <section class="tool-card currency-hub">
                <div class="card-title">
                    <div class="title-icon emerald-glow">
                        <i class="fas fa-vault"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="CurrencyExchange">@Localizer["CurrencyExchange"]</h3>
                        <p data-i18n="GlobalValuationProtocols">@Localizer["GlobalValuationProtocols"]</p>
                    </div>
                </div>

                <div class="tool-body">
                    <div class="form-row">
                        <label data-i18n="TransactionVolume">@Localizer["TransactionVolume"]</label>
                        <input type="number" id="amountInput" value="1.00" step="0.01" class="modern-input"
                            oninput="convertCurrency()">
                    </div>
                    <div class="form-grid">
                        <div class="form-row">
                            <label data-i18n="BaseLocation">@Localizer["BaseLocation"]</label>
                            <select id="fromCurrency" class="modern-select" onchange="convertCurrency()"></select>
                        </div>
                        <div class="swap-indicator"><i class="fas fa-right-left"></i></div>
                        <div class="form-row">
                            <label data-i18n="TargetLocation">@Localizer["TargetLocation"]</label>
                            <select id="toCurrency" class="modern-select" onchange="convertCurrency()"></select>
                        </div>
                    </div>
                    <div class="action-row" style="margin-top: 10px;">
                        <button onclick="convertCurrency()" class="btn-emerald" style="width: 100%;">
                            <i class="fas fa-bolt"></i> <span
                                data-i18n="RefreshValuation">@Localizer["RefreshValuation"]</span>
                        </button>
                    </div>
                    <div class="result-section">
                        <div class="result-status">
                            <label class="result-header"
                                data-i18n="RealTimeFiscalTelemetry">@Localizer["RealTimeFiscalTelemetry"]</label>
                            <div class="live-tag">
                                <span class="pulse-dot"></span>
                                <span data-i18n="Live">@Localizer["Live"]</span>
                            </div>
                        </div>
                        <div id="currencyResult" class="valuation-output">
                            <!-- Hidden until action -->
                            <div
                                style="padding: 20px; text-align: center; color: var(--text-muted); opacity: 0.6; font-size: 0.9rem;">
                                <i class="fas fa-coins"></i> <span
                                    data-i18n="ConvertCurrency">@Localizer["ConvertCurrency"]</span>
                            </div>
                        </div>
                        <div class="update-info no-translate" id="lastExchangeUpdate">
                            <span data-i18n="LastSync">@Localizer["LastSync"]</span>: --:--:--
                        </div>
                    </div>

                    <div class="fiscal-directory" style="display: none;">
                        <label data-i18n="CurrencyOriginReference">@Localizer["CurrencyOriginReference"]</label>
                        <div id="currencyReferenceList" class="reference-scroll">
                            <!-- JS Populated -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Chronos Sync Card -->
            <section class="tool-card chrono-hub">
                <div class="card-title">
                    <div class="title-icon indigo-glow">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="TimeZone">@Localizer["TimeZone"]</h3>
                        <p data-i18n="UniversalTimeCoordination">@Localizer["UniversalTimeCoordination"]</p>
                    </div>
                </div>

                <div class="tool-body">
                    <div class="clock-display">
                        <label data-i18n="SystemBaseTime">@Localizer["SystemBaseTime"]</label>
                        <div id="localTimeLarge" class="digits-hero no-translate">00:00:00</div>
                    </div>
                    <div class="zone-sync">
                        <label data-i18n="CoordinateZone">@Localizer["CoordinateZone"]</label>
                        <select id="timezoneSelect" class="modern-select" onchange="updateConvertedTime()">
                            <option value="UTC" data-i18n="Timezone_UTC">Universal (UTC)</option>
                            <option value="America/New_York" data-i18n="Timezone_NY">New York (EDT)</option>
                            <option value="Europe/London" data-i18n="Timezone_London">London (BST)</option>
                            <option value="Asia/Tokyo" data-i18n="Timezone_Tokyo">Tokyo (JST)</option>
                            <option value="Asia/Kolkata" selected data-i18n="Timezone_Mumbai">Mumbai (IST)</option>
                            <option value="Australia/Sydney" data-i18n="Timezone_Sydney">Sydney (AEST)</option>
                            <option value="Asia/Dubai" data-i18n="Timezone_Dubai">Dubai (GST)</option>
                        </select>
                        <div id="convertedTime" class="digits-accent no-translate">00:00:00</div>
                    </div>
                </div>
            </section>

            <!-- News Hub Card -->
            <section class="tool-card news-hub">
                <div class="card-title">
                    <div class="title-icon rose-glow">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="GlobalNewsFeed">@Localizer["GlobalNewsFeed"]</h3>
                        <p data-i18n="LiveIntelStream">@Localizer["LiveIntelStream"]</p>
                    </div>
                </div>

                <div class="hub-controls">
                    <div class="search-field" style="display:flex; gap:8px;">
                        <input type="text" id="newsInput" data-i18n-placeholder="SearchNews"
                            placeholder="@Localizer["SearchNews"]" style="flex-grow:1;"
                            onkeypress="if(event.key === 'Enter') triggerNewsSearch()">
                        <button class="btn-glass" onclick="triggerNewsSearch()" style="padding: 0 16px; color: #000;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="news-list" id="newsFeed">
                    <!-- News will load here only upon user search -->
                    <div style="padding: 30px; text-align: center; color: var(--text-muted); opacity: 0.6;">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p data-i18n="SearchNews">@Localizer["SearchNews"]</p>
                    </div>
                </div>
            </section>

            <!-- Notes Hub Card -->
            <section class="tool-card notes-hub">
                <div class="card-title">
                    <div class="title-icon purple-glow">
                        <i class="fas fa-sticky-note"></i>
                    </div>
                    <div class="title-text">
                        <h3 data-i18n="Notes">@Localizer["Notes"]</h3>
                        <p data-i18n="PersonalLog">@Localizer["PersonalLog"]</p>
                    </div>
                </div>

                <div class="hub-controls">
                    <button id="btnNewNote" onclick="toggleNoteForm()" class="btn-primary" style="width:100%">
                        <i class="fas fa-plus"></i> <span data-i18n="NewNote">@Localizer["NewNote"]</span>
                    </button>
                </div>

                <div id="noteFormArea"
                    style="display:none; margin-bottom: 20px; background: rgba(255,255,255,0.02); padding: 16px; border-radius: 16px; border: 1px solid var(--border-dim);"
                    class="slide-in">
                    <div style="margin-bottom: 12px; font-weight: 700; color: var(--accent-purple);" id="formTitle"
                        data-i18n="NewNote">
                        @Localizer["NewNote"]</div>
                    <input type="hidden" id="noteId">
                    <div class="form-row" style="margin-bottom:12px;">
                        <input type="text" id="noteTitle" class="modern-input" placeholder="@Localizer["NoteTitle"]"
                            data-i18n-placeholder="NoteTitle">
                    </div>
                    <div class="form-row" style="margin-bottom:12px;">
                        <textarea id="noteDesc" class="modern-input" rows="3" placeholder="@Localizer["NoteDetails"]"
                            data-i18n-placeholder="NoteDetails"></textarea>
                    </div>
                    <div class="action-group" style="width: 100%; display: flex; gap: 10px;">
                        <button onclick="saveNote()" class="btn-primary" style="flex: 1;"
                            data-i18n="Save">@Localizer["Save"]</button>
                        <button onclick="toggleNoteForm()" class="btn-icon"
                            style="flex: 1; border: 1px solid var(--border-dim); background: transparent; color: var(--text-muted);"
                            data-i18n="Cancel">@Localizer["Cancel"]</button>
                    </div>
                </div>

                <div class="notes-list" id="notesList">
                    <div class="loading-state" data-i18n="DecryptingLogs">@Localizer["InitialisingSatelliteLink"]</div>
                </div>
            </section>




        </div>
    </div>
</div>



<link rel="stylesheet" href="~/css/dashboard.css" />

@section Scripts {
    <script>
        async function getWeatherDesc(code) {
            const map = {
                0: 'Clear skies', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Depositing rime fog', 51: 'Light drizzle', 53: 'Moderate drizzle',
                55: 'Dense drizzle', 61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
                71: 'Slight snow', 73: 'Moderate snow', 75: 'Heavy snow', 77: 'Snow grains',
                80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
                95: 'Thunderstorm', 96: 'Thunderstorm with slight hail', 99: 'Thunderstorm with heavy hail'
            };
            const text = map[code] || 'Clear skies';
            return await window.translator.translateText(text);
        }

        const weatherIcons = {
            0: 'fa-sun', 1: 'fa-cloud-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud',
            45: 'fa-smog', 48: 'fa-smog', 51: 'fa-cloud-rain', 53: 'fa-cloud-rain',
            55: 'fa-cloud-showers-heavy', 61: 'fa-cloud-rain', 63: 'fa-cloud-rain',
            65: 'fa-cloud-showers-heavy', 71: 'fa-snowflake', 73: 'fa-snowflake',
            75: 'fa-snowflake', 80: 'fa-cloud-bolt', 81: 'fa-cloud-bolt',
            82: 'fa-cloud-bolt', 95: 'fa-bolt-lightning'
        };

        function getIcon(code) { return weatherIcons[code] || 'fa-cloud'; }

        // --- GLOBAL NETWORK NODES ---
        let allNodes = [];
        const initialNodes = [
            { name: "Ahmedabad", lat: 23.0225, lon: 72.5714, cc: "GJ, IN" },
            { name: "Surat", lat: 21.1702, lon: 72.8311, cc: "GJ, IN" },
            { name: "Vadodara", lat: 22.3072, lon: 73.1812, cc: "GJ, IN" },
            { name: "Rajkot", lat: 22.3039, lon: 70.8022, cc: "GJ, IN" },
            { name: "London", lat: 51.5074, lon: -0.1278, cc: "GB" },
            { name: "New York", lat: 40.7128, lon: -74.0060, cc: "US" },
            { name: "Tokyo", lat: 35.6895, lon: 139.6917, cc: "JP" },
            { name: "Mumbai", lat: 19.0760, lon: 72.8777, cc: "IN" },
            { name: "Delhi", lat: 28.6139, lon: 77.2090, cc: "IN" }
        ];

        async function initNodeDirectory() {
            const container = document.getElementById('worldWeatherList');
            if (container) {
                const syncText = await window.translator.translateText('Syncing Global Nodes...');
                container.innerHTML = `<div class="loading-state">${syncText}</div>`;
            }

            allNodes = [];
            for (const n of initialNodes) {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${n.lat}&longitude=${n.lon}&current=temperature_2m,weather_code`);
                    const data = await res.json();
                    allNodes.push({ ...n, weather: data.current });
                } catch (e) { }
            }
            await renderNodes(allNodes);
        }

        async function renderNodes(nodes) {
            const container = document.getElementById('worldWeatherList');
            const nodeCount = document.getElementById('nodeCount');
            if (!container) return;
            container.innerHTML = '';

            if (nodeCount) {
                const activeText = await window.translator.translateText('Nodes Active');
                nodeCount.innerText = `${nodes.length} ${activeText}`;
            }

            for (const item of nodes) {
                const el = document.createElement('div');
                el.className = 'node-item slide-in';
                const translatedName = await window.translator.translateText(item.name);

                el.onclick = () => {
                    fetchWeatherDeep(item.lat, item.lon, `${translatedName}, ${item.cc}`);
                };

                const iconClass = getIcon(item.weather.weather_code);
                const temp = Math.round(item.weather.temperature_2m);
                el.innerHTML = `<div><h4>${translatedName}</h4><span>Region: ${item.cc}</span></div>
                                    <div class="node-data"><i class="fas ${iconClass}"></i>
                                    <b>${temp}°C</b></div>`;
                container.appendChild(el);
            }
        }

        async function getCurrentLocation() {
            const display = document.getElementById('weatherResult');
            const loadText = await window.translator.translateText('Triangulating Satellite Uplink...');
            display.innerHTML = `<div class="loading-state">${loadText}</div>`;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => fetchWeatherDeep(p.coords.latitude, p.coords.longitude, "Local Terminal"),
                    async () => {
                        const errText = await window.translator.translateText('Uplink Interrupted');
                        display.innerHTML = `<div class="text-danger">${errText}</div>`;
                    }
                );
            }
        }

        async function getWeather(cityOverride) {
            const query = cityOverride || document.getElementById('cityInput').value || 'London';
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=1&language=en&format=json`);
                const data = await res.json();
                if (!data.results) {
                    const errMsg = await window.translator.translateText('City not found');
                    document.getElementById('weatherResult').innerHTML = `<div class="text-danger">${errMsg}</div>`;
                    return;
                }
                const { latitude, longitude, name, country } = data.results[0];
                const displayName = await window.translator.translateText(`${name}, ${country}`);
                fetchWeatherDeep(latitude, longitude, displayName);
            } catch (e) {
                const errMsg = await window.translator.translateText('City not found');
                document.getElementById('weatherResult').innerHTML = `<div class="text-danger">${errMsg}</div>`;
            }
        }

        async function fetchWeatherDeep(lat, lon, label) {
            const display = document.getElementById('weatherResult');
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`);
                const data = await res.json();
                const cur = data.current;
                const timezone = data.timezone;

                const weatherDesc = await getWeatherDesc(cur.weather_code);
                const humidityLabel = await window.translator.translateText('Humidity');
                const windLabel = await window.translator.translateText('Wind Velocity');

                // Calculate Local Time
                let localTimeStr = "--:--";
                try {
                    const now = new Date();
                    const lang = window.i18n.locale;
                    const locale = lang === 'en' ? 'en-US' : (lang === 'hi' ? 'hi-IN' : 'gu-IN');
                    localTimeStr = now.toLocaleString(locale, { timeZone: timezone, weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                } catch (e) { console.error("Time calc error", e); }

                display.innerHTML = `
                                                                        <div class="loc-label slide-in">${label}</div>
                                                                        <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;" class="slide-in">${localTimeStr}</div>
                                                                        <div class="temp-hero slide-in">${Math.round(cur.temperature_2m)}°</div>
                                                                        <div class="weather-desc slide-in">${weatherDesc}</div>
                                                                        <div class="stats-deep slide-in">
                                                                            <div class="stat-box"><i class="fas fa-droplet"></i> <label>${humidityLabel}</label> <b>${cur.relative_humidity_2m}%</b></div>
                                                                            <div class="stat-box"><i class="fas fa-wind"></i> <label>${windLabel}</label> <b>${Math.round(cur.wind_speed_10m)} km/h</b></div>
                                                                        </div>`;
            } catch (e) {
                const failText = await window.translator.translateText('Satellite Link Failure');
                display.innerHTML = `<div class="text-danger">${failText}</div>`;
            }
        }


        // --- FISCAL & TIMEZONE DATA ---
        let currencyContext = null; // Stores { city: string, country: string, currency: string }

        /* --- SHARED DATASET --- */
        let globalLocationData = []; // The master list for both Currency and Timezone

        async function initFiscal(preserveState = false) {
            const f = document.getElementById('fromCurrency');
            const t = document.getElementById('toCurrency');

            // Capture current selection if preserving state
            let currentVals = {};
            if (preserveState) {
                currentVals = { f: f.value, t: t.value };
            }

            // Major Non-Capital Cities (IANA Timezones) to ensure comprehensive global coverage
            const extraCities = [
                { country: "United States", city: "New York", currency: "USD", timezone: "America/New_York" },
                { country: "United States", city: "Los Angeles", currency: "USD", timezone: "America/Los_Angeles" },
                { country: "United States", city: "Chicago", currency: "USD", timezone: "America/Chicago" },
                { country: "India", city: "Mumbai", currency: "INR", timezone: "Asia/Kolkata" },
                { country: "India", city: "Bengaluru", currency: "INR", timezone: "Asia/Kolkata" },
                { country: "India", city: "Delhi", currency: "INR", timezone: "Asia/Kolkata" },
                { country: "United Kingdom", city: "London", currency: "GBP", timezone: "Europe/London" },
                { country: "Japan", city: "Tokyo", currency: "JPY", timezone: "Asia/Tokyo" },
                { country: "China", city: "Shanghai", currency: "CNY", timezone: "Asia/Shanghai" },
                { country: "Germany", city: "Berlin", currency: "EUR", timezone: "Europe/Berlin" },
                { country: "France", city: "Paris", currency: "EUR", timezone: "Europe/Paris" },
                { country: "Australia", city: "Sydney", currency: "AUD", timezone: "Australia/Sydney" },
                { country: "Canada", city: "Toronto", currency: "CAD", timezone: "America/Toronto" },
                { country: "United Arab Emirates", city: "Dubai", currency: "AED", timezone: "Asia/Dubai" },
                { country: "Singapore", city: "Singapore", currency: "SGD", timezone: "Asia/Singapore" }
            ];

            // IMMEDIATE RENDER of reliable static data (Popular)
            globalLocationData = [...extraCities];

            // Define Helper Functions LOCALLY to ensure they exist
            const createOpt = (c) => {
                const val = `${c.currency}|${c.country}`;
                const opt = new Option(`${c.city}, ${c.country}`, val);
                opt.setAttribute('data-city', c.city);
                opt.setAttribute('data-country', c.country);
                opt.setAttribute('data-currency', c.currency);
                opt.setAttribute('data-timezone', c.timezone);
                return opt;
            };

            const appendGroup = async (parent, label, items) => {
                if (items.length === 0) return;
                const group = document.createElement('optgroup');

                let translatedLabel = label;
                try {
                    // Check if translator exists and works
                    if (window.translator && typeof window.translator.translateText === 'function') {
                        // Short timeout for safety
                        const p = window.translator.translateText(label);
                        const t = new Promise(r => setTimeout(r, 500)); // 500ms timeout
                        const res = await Promise.race([p, t]);
                        if (res) translatedLabel = res;
                    }
                } catch (e) {/* ignore */ }

                group.label = translatedLabel;
                items.forEach(c => group.appendChild(createOpt(c)));
                parent.appendChild(group);
            };

            // Helper to populate
            const populateDropdowns = async (data) => {
                f.innerHTML = ''; t.innerHTML = '';
                const uniqueLocs = [];
                const seen = new Set();
                data.forEach(loc => {
                    const key = `${loc.city}|${loc.country}`;
                    if (!seen.has(key)) { seen.add(key); uniqueLocs.push(loc); }
                });
                const sorted = uniqueLocs.sort((a, b) => a.city.localeCompare(b.city));

                const popNames = ['United States', 'India', 'United Kingdom', 'Japan', 'China', 'Germany', 'France', 'Australia', 'Canada', 'Switzerland', 'United Arab Emirates', 'Singapore'];
                const topLocs = sorted.filter(c => popNames.includes(c.country));
                const otherLocs = sorted.filter(c => !popNames.includes(c.country));

                try { await appendGroup(f, 'Popular', topLocs); } catch (e) { }
                try { await appendGroup(f, 'Global Locations', otherLocs); } catch (e) { }

                try { await appendGroup(t, 'Popular', topLocs); } catch (e) { }
                try { await appendGroup(t, 'Global Locations', otherLocs); } catch (e) { }

                // Restore or Default
                if (preserveState && currentVals.f && currentVals.t) {
                    f.value = currentVals.f; t.value = currentVals.t;
                } else {
                    const setDefault = (el, country) => {
                        for (let i = 0; i < el.options.length; i++) {
                            if (el.options[i].getAttribute('data-country') === country) {
                                el.selectedIndex = i; break;
                            }
                        }
                    };
                    setDefault(f, 'United States');
                    setDefault(t, 'India');
                }
            };

            // 1. Render Defaults Immediately
            await populateDropdowns(globalLocationData);
            initTimezones(); // Needed for clock

            try {
                // 2. Fetch Country/Currency Data (Background Enhancement)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 4000);

                const res = await fetch('https://restcountries.com/v3.1/all?fields=name,currencies,flags,cca2,capital,timezones', { signal: controller.signal });
                clearTimeout(timeoutId);

                const data = await res.json();

                // 2. Build Base List from Countries (Capitals)
                let apiLocations = data
                    .filter(c => c.currencies && Object.keys(c.currencies).length > 0)
                    .map(c => {
                        const code = Object.keys(c.currencies)[0];
                        const city = (c.capital && c.capital.length > 0) ? c.capital[0] : c.name.common;
                        return {
                            country: c.name.common,
                            city: city,
                            flag: c.flags.svg || '',
                            currency: code,
                            symbol: c.currencies[code].symbol,
                            timezone: (c.timezones && c.timezones.length > 0 && (c.timezones[0] === 'UTC' || c.timezones[0].includes('/')))
                                ? c.timezones[0]
                                : null
                        };
                    });

                // 3. Merge and Sort
                const finalApiList = [...extraCities, ...apiLocations];
                // Update Global List
                globalLocationData = finalApiList;

                // Re-Render with Full Data
                await populateDropdowns(globalLocationData);

            } catch (e) {
                console.warn('Fiscal API failed or timed out, keeping default list.', e);
            }
            // End Init
        }

        function initTimezones() {
            const select = document.getElementById('timezoneSelect');
            if (!select) return;

            // Check existing so we don't dupe
            const existing = new Set(Array.from(select.options).map(o => o.value));

            if (globalLocationData && globalLocationData.length > 0) {
                globalLocationData.forEach(loc => {
                    if (loc.timezone && !existing.has(loc.timezone)) {
                        // Create readable label
                        const label = `${loc.city}, ${loc.country}`;
                        const opt = new Option(label, loc.timezone);
                        select.add(opt);
                        existing.add(loc.timezone);
                    }
                });
            }
        }



        async function fetchLatestRates(shouldConvert = true) {
            const rawVal = document.getElementById('fromCurrency').value;
            // Ensure we have a value. If list empty (load error), return.
            if (!rawVal) return;

            const f = rawVal.split('|')[0];
            try {
                // Using a fallback or free API
                const res = await fetch(`https://open.er-api.com/v6/latest/${f}`);
                const data = await res.json();
                baseCurrencyRates = data.rates;

                const updateEl = document.getElementById('lastExchangeUpdate');
                const lang = window.i18n.locale;
                const locale = lang === 'en' ? 'en-US' : (lang === 'hi' ? 'hi-IN' : 'gu-IN');

                if (updateEl) {
                    const txt = await window.translator.translateText('Last Synced');
                    updateEl.innerText = `${txt}: ${new Date().toLocaleTimeString(locale)} (${f})`;
                }

                // Only convert if requested (user action)
                if (shouldConvert) convertCurrency();

            } catch (e) { console.error('Rate Fetch Error:', e); }
        }

        async function convertCurrency() {
            const amount = parseFloat(document.getElementById('amountInput').value) || 0;
            const fEl = document.getElementById('fromCurrency');
            const tEl = document.getElementById('toCurrency');

            const rawF = fEl.value;
            const rawT = tEl.value;
            if (!rawF || !rawT) return;

            const f = rawF.split('|')[0];
            const t = rawT.split('|')[0];

            // Logic to update stored context based on user interaction
            const getMeta = (el) => {
                const opt = el.options[el.selectedIndex];
                if (!opt) return null;
                return {
                    city: opt.getAttribute('data-city'),
                    country: opt.getAttribute('data-country'),
                    currency: opt.getAttribute('data-currency'),
                    timezone: opt.getAttribute('data-timezone')
                };
            };

            let targetMeta = getMeta(tEl);
            let baseMeta = getMeta(fEl);

            if (!currencyContext || (currencyContext.country !== baseMeta.country && currencyContext.country !== targetMeta.country)) {
                currencyContext = targetMeta;
            }

            const display = document.getElementById('currencyResult');

            if (!baseCurrencyRates || !baseCurrencyRates[t]) {
                const syncText = await window.translator.translateText('Syncing New Base Rates...');
                display.innerHTML = `<div class="loading-state">${syncText}</div>`;
                await fetchLatestRates();
                if (!baseCurrencyRates[t]) return;
            }

            const rate = baseCurrencyRates[t];
            const calc = amount * rate;
            const lang = window.i18n.locale;
            const locale = lang === 'en' ? 'en-US' : (lang === 'hi' ? 'hi-IN' : 'gu-IN');

            // Check Context for Location Display
            let locationDisplay = '';

            if (currencyContext) {
                let contextMatch = null;
                if (currencyContext.country === baseMeta.country) contextMatch = 'Base';
                else if (currencyContext.country === targetMeta.country) contextMatch = 'Target';

                if (contextMatch) {
                    // Calculate Time
                    let timeStr = '';
                    if (currencyContext.timezone) {
                        try {
                            const now = new Date();
                            const time = now.toLocaleTimeString(locale, { timeZone: currencyContext.timezone, hour: '2-digit', minute: '2-digit' });
                            const date = now.toLocaleDateString(locale, { timeZone: currencyContext.timezone, day: 'numeric', month: 'short' });
                            timeStr = `<div style="font-size: 0.75rem; opacity: 0.8; margin-top: 2px;">
                                                                                                                                                     <i class="fas fa-clock" style="font-size:0.7em"></i> ${date} • ${time}
                                                                                                                                                   </div>`;
                        } catch (e) { }
                    }

                    const label = contextMatch === 'Base' ? 'Base Location' : 'Target Location';
                    const translatedLabel = await window.translator.translateText(label);
                    const city = await window.translator.translateText(currencyContext.city);
                    const country = await window.translator.translateText(currencyContext.country);

                    const colorVar = contextMatch === 'Base' ? 'var(--accent-primary)' : 'var(--accent-emerald)';
                    const bgVar = contextMatch === 'Base' ? 'rgba(88, 166, 255, 0.1)' : 'rgba(52, 211, 153, 0.1)';
                    const borderVar = contextMatch === 'Base' ? 'rgba(88, 166, 255, 0.2)' : 'rgba(52, 211, 153, 0.2)';

                    locationDisplay = `<div style="text-align:center; margin-bottom: 12px; color: ${colorVar}; background: ${bgVar}; padding: 8px; border-radius: 8px; border: 1px solid ${borderVar};">
                                                                                                                                                     <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 4px;">${translatedLabel}</div>
                                                                                                                                                     <div style="font-weight: 700; font-size: 0.95rem;">
                                                                                                                                                        <i class="fas fa-location-dot"></i> ${city}, ${country}
                                                                                                                                                     </div>
                                                                                                                                                     ${timeStr}
                                                                                                                                                   </div>`;
                }
            }

            const realCurrencyLabel = await window.translator.translateText('Real Currency');
            display.innerHTML = `
                                                                                                                            ${locationDisplay}
                                                                                                                                <div class="val-grid">
                                                                                                                                    <div class="val-box slide-in highlight-border">
                                                                                                                                        <div class="val-label">${f}</div>
                                                                                                                                        <div class="val-number">${amount.toLocaleString(locale, { minimumFractionDigits: 2 })}</div>
                                                                                                                                        <div class="val-loc-meta">${realCurrencyLabel}</div>
                                                                                                                                    </div>
                                                                                                                                    <div class="val-box slide-in">
                                                                                                                                        <div class="val-label">${t}</div>
                                                                                                                                        <div class="val-number highlight">${calc.toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                                                                                                                         <div class="val-loc-meta">Rate: ${rate.toFixed(4)}</div>
                                                                                                                                    </div>
                                                                                                                                </div>`;
        }

        /* --- TIMEZONE LOGIC --- */
        function initTimezones() {
            const select = document.getElementById('timezoneSelect');
            if (!select) return;

            // Preserve current selection if possible
            const currentVal = select.value;
            select.innerHTML = '';

            // USE globalLocationData (Shared Dataset)
            // Filter out entries that have garbage timezones (like "UTC+05:00") if we want strict IANA,
            // BUT for the "System" to work, we accept what we have.
            // Ideally we prioritized the `extraCities` for good IANA zones.

            globalLocationData.forEach(loc => {
                let tzValue = loc.timezone;
                // Only add if we have a valid timezone string
                if (!tzValue) return;

                const opt = document.createElement('option');
                opt.value = tzValue;
                opt.text = `${loc.city}, ${loc.country}`;
                opt.setAttribute('data-full', tzValue);
                if (tzValue === currentVal) opt.selected = true;
                select.appendChild(opt);
            });

            // Default if nothing selected
            if (select.selectedIndex === -1) {
                // Try to select Mumbai or New York
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value.includes('Kolkata') || select.options[i].value.includes('New_York')) {
                        select.selectedIndex = i;
                        break;
                    }
                }
            }

            updateConvertedTime();
        }

        function runChronos() {
            try {
                const now = new Date();
                // Safe Locale Detection
                let locale = 'en-US';
                try {
                    const lang = (window.i18n && window.i18n.locale) ? window.i18n.locale : 'en';
                    if (lang === 'hi') locale = 'hi-IN';
                    else if (lang === 'gu') locale = 'gu-IN';
                } catch (e) { }

                const dateEl = document.getElementById('headerDate');
                if (dateEl) dateEl.innerText = now.toLocaleDateString(locale, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                const timeEl = document.getElementById('headerTime');
                if (timeEl) timeEl.innerText = now.toLocaleTimeString(locale);

                const localLargeEl = document.getElementById('localTimeLarge');
                if (localLargeEl) localLargeEl.innerText = now.toLocaleTimeString(locale);

                // Also update the accent box if it exists
                if (typeof updateConvertedTime === 'function') updateConvertedTime();
            } catch (e) {
                console.error("Chronos Error:", e);
                // Hard Fallback
                try {
                    const fb = new Date().toLocaleTimeString();
                    if (document.getElementById('headerTime')) document.getElementById('headerTime').innerText = fb;
                } catch (z) { }
            }
        }

        function updateConvertedTime() {
            const zone = document.getElementById('timezoneSelect').value;
            const now = new Date();
            const lang = window.i18n.locale;
            const locale = lang === 'en' ? 'en-US' : (lang === 'hi' ? 'hi-IN' : 'gu-IN');

            try {
                const timeString = now.toLocaleTimeString(locale, { timeZone: zone });
                const dateString = now.toLocaleDateString(locale, { timeZone: zone, weekday: 'short', month: 'short', day: 'numeric' });

                // Get offset safely
                const typePart = Intl.DateTimeFormat(locale, { timeZone: zone, timeZoneName: 'longOffset' }).formatToParts(now).find(p => p.type === 'timeZoneName');
                const type = typePart ? typePart.value : zone;

                document.getElementById('convertedTime').innerHTML = `${timeString} <span style="font-size:0.5em; opacity:0.7; display:block;">${dateString} • ${type}</span>`;
            } catch (e) {
                console.error("Time calc error", e);
            }
        }

        // --- NEWS FEED ---
        // Redirects to dedicated Details page

        function triggerNewsSearch() {
            const val = document.getElementById('newsInput').value;
            if (!val) {
                // Default to Global Technology if empty? Or do nothing?
                // Requirement: "When the user searches..." implication is explicit action.
                // But let's provide a default if they click empty search.
                window.location.href = '/News/Details?query=Global%20Technology';
                return;
            }

            // Treat comma as strict location signal
            let query = val;
            let fallback = '';

            if (val.includes(',')) {
                // If "City, Country", pass both.
                // details page logic uses fallbackQuery if query fails.
                // But wait, the Details page expects "query" to be the main search.
                // If I pass "Paris, France", logic there handles it.
                // We can separate for fallback purposes.
                fallback = val.split(',').pop().trim();
            }

            window.location.href = `/News/Details?query=${encodeURIComponent(query)}&fallbackQuery=${encodeURIComponent(fallback)}`;
        }

        // Removed fetchGlobalNews and related rendering logic as results are now shown on separate page.


        // --- NOTES SYSTEM ---
        let currentNotes = [];

        async function initNotes() {
            fetchNotes();
        }

        async function fetchNotes() {
            const container = document.getElementById('notesList');
            try {
                const res = await fetch('/Notes/GetAll');
                if (res.ok) {
                    const notes = await res.json();
                    await renderNotes(notes);
                } else {
                    if (container) {
                        const errText = await window.translator.translateText('Error loading notes');
                        container.innerHTML = `<div class="text-danger">${errText}</div>`;
                    }
                }
            } catch (e) {
                if (container) {
                    const connErr = await window.translator.translateText('Connection Error');
                    container.innerHTML = `<div class="text-danger">${connErr}</div>`;
                }
            }
        }

        async function renderNotes(notes) {
            currentNotes = notes;
            const container = document.getElementById('notesList');
            if (!container) return;
            container.innerHTML = '';

            if (notes.length === 0) {
                const noNotesText = await window.translator.translateText('No Notes Found');
                container.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;">${noNotesText}</div>`;
                return;
            }

            notes.forEach(note => {
                const date = new Date(note.createdDate).toLocaleDateString();
                const div = document.createElement('div');
                div.className = 'note-item slide-in';
                div.onclick = (e) => {
                    if (e.target.closest('.btn-note-action')) return;
                    editNote(note.id);
                };
                div.innerHTML = `
                                                                                                                                                                    <div class="note-header">
                                                                                                                                                                        <div class="note-title">${escapeHtml(note.title)}</div>
                                                                                                                                                                        <div class="note-date">${date}</div>
                                                                                                                                                                    </div>
                                                                                                                                                                    <div class="note-desc">${escapeHtml(note.description)}</div>
                                                                                                                                                                    <div class="note-actions">
                                                                                                                                                                        <button class="btn-note-action" onclick="editNote(${note.id})"><i class="fas fa-edit"></i></button>
                                                                                                                                                                        <button class="btn-note-action delete" onclick="deleteNote(${note.id})"><i class="fas fa-trash"></i></button>
                                                                                                                                                                    </div>
                                                                                                                                                                `;
                container.appendChild(div);
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        }

        async function searchGlobalIntel() {
            const query = document.getElementById('globalSearchInput').value;
            if (!query) return;
            window.location.href = `/Home/CountryDetails?name=${encodeURIComponent(query)}`;
        }

        async function renderGlobalResult(loc, country) {
            const display = document.getElementById('globalSearchResult');

            // Safe currency access
            let currency = { name: 'N/A', symbol: '' };
            if (country && country.currencies) {
                const keys = Object.keys(country.currencies);
                if (keys.length > 0) currency = country.currencies[keys[0]];
            }

            // Await all translations independently
            const cityName = await window.translator.translateText(loc.name);
            const countryName = country ? await window.translator.translateText(country.name.common) : '';
            const region = country ? await window.translator.translateText(country.region) : '';
            const capital = (country && country.capital && country.capital.length > 0) ? await window.translator.translateText(country.capital[0]) : 'N/A';
            const currName = currency.name !== 'N/A' ? await window.translator.translateText(currency.name) : 'N/A';

            // Labels
            const l_coords = await window.translator.translateText('Coordinates');
            const l_timezone = await window.translator.translateText('Time Zone');
            const l_curr = await window.translator.translateText('Currency');
            const l_pop = await window.translator.translateText('Population');
            const l_cap = await window.translator.translateText('Capital');
            const l_reg = await window.translator.translateText('Region');

            // --- BUILD HTML SAFELY ---

            let html = '<div class="result-card slide-in" style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 20px; border: 1px solid var(--border-dim);">';

            // Header
            html += '<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 16px;">';
            html += '<div>';
            html += '<div style="font-size: 1.5rem; font-weight: 800; color: var(--text-bright);">' + cityName + '</div>';

            let subText = (loc.admin1 || '') + (country ? ', ' + countryName : '');
            html += '<div style="color: var(--text-muted); font-size: 0.9rem;">' + subText + '</div>';
            html += '</div>';

            if (country && country.flag) {
                html += '<div style="font-size: 2.5rem; line-height: 1;">' + country.flag + '</div>';
            }
            html += '</div>'; // End Header

            // Stats
            html += '<div class="stats-deep" style="grid-template-columns: 1fr 1fr; margin-top: 0;">';

            // Coords
            html += '<div class="stat-box" style="padding: 12px;">';
            html += '<label>' + l_coords + '</label>';
            html += '<b>' + loc.latitude.toFixed(2) + ', ' + loc.longitude.toFixed(2) + '</b>';
            html += '</div>';

            // Timezone
            html += '<div class="stat-box" style="padding: 12px;">';
            html += '<label>' + l_timezone + '</label>';
            html += '<b style="font-size: 1rem;">' + loc.timezone + '</b>';
            html += '</div>';

            html += '</div>'; // End Top Stats

            // Bottom Stats (Country only)
            if (country) {
                const popM = (country.population / 1000000).toFixed(1) + 'M';

                html += '<div class="stats-deep" style="grid-template-columns: 1fr 1fr; margin-top: 12px;">';

                // Currency
                html += '<div class="stat-box" style="padding: 12px;">';
                html += '<label>' + l_curr + '</label>';
                html += '<b>' + currency.symbol + ' ' + currName + '</b>';
                html += '</div>';

                // Pop
                html += '<div class="stat-box" style="padding: 12px;">';
                html += '<label>' + l_pop + '</label>';
                html += '<b>' + popM + '</b>';
                html += '</div>';

                // Cap
                html += '<div class="stat-box" style="padding: 12px;">';
                html += '<label>' + l_cap + '</label>';
                html += '<b>' + capital + '</b>';
                html += '</div>';

                // Reg
                html += '<div class="stat-box" style="padding: 12px;">';
                html += '<label>' + l_reg + '</label>';
                html += '<b>' + region + '</b>';
                html += '</div>';

                html += '</div>';
            }

            // Sync Badge
            html += '<div style="margin-top:16px; text-align:center;">';
            html += '<span style="color:var(--accent-success); font-size:0.8rem; display:block; margin-bottom:8px;">';
            html += '<i class="fas fa-check-circle"></i> Dashboard Synced';
            html += '</span></div></div>';

            display.innerHTML = html;

            // Auto-Sync Dashboard
            syncDashboardToLocation(loc, country);
        }

        async function syncDashboardToLocation(loc, country) {
            // 1. Sync Weather
            if (loc.latitude && loc.longitude) {
                fetchWeatherDeep(loc.latitude, loc.longitude, `${loc.name}, ${loc.country_code}`);
            }

            // 2. Sync Timezone
            if (loc.timezone) {
                const tzSelect = document.getElementById('timezoneSelect');
                let exists = false;
                for (let i = 0; i < tzSelect.options.length; i++) {
                    if (tzSelect.options[i].value === loc.timezone) {
                        tzSelect.selectedIndex = i;
                        exists = true;
                        break;
                    }
                }

                // If not in list (rare given we load all), attempt to add it or find formatted match
                if (!exists) {
                    // Try to find by raw value
                    const opt = document.createElement('option');
                    opt.value = loc.timezone;
                    opt.text = `${loc.name} (${loc.timezone.split('/')[0]})`;
                    opt.selected = true;
                    tzSelect.add(opt);
                }
                updateConvertedTime();

                // Highlight effect
                const chronoCard = document.querySelector('.chrono-hub');
                if (chronoCard) {
                    chronoCard.style.borderColor = 'var(--accent-indigo)';
                    setTimeout(() => chronoCard.style.borderColor = '', 1500);
                }
            }

            // 3. Sync Currency
            if (country && country.currencies) {
                const currencyCode = Object.keys(country.currencies)[0];
                const tSelect = document.getElementById('toCurrency');

                // Update Context
                currencyContext = {
                    city: loc.name,
                    country: country.name.common,
                    currency: currencyCode,
                    timezone: loc.timezone
                };

                // Find matching option for country/currency
                // We prioritize country match
                let found = false;
                for (let i = 0; i < tSelect.options.length; i++) {
                    const opt = tSelect.options[i];
                    if (opt.getAttribute('data-country') === country.name.common || opt.value.split('|')[0] === currencyCode) {
                        tSelect.selectedIndex = i;
                        found = true;
                        break;
                    }
                }

                if (found) {
                    convertCurrency();

                    // Highlight effect
                    const currencyCard = document.querySelector('.currency-hub');
                    if (currencyCard) {
                        currencyCard.style.borderColor = 'var(--accent-emerald)';
                        setTimeout(() => currencyCard.style.borderColor = '', 1500);
                    }
                }
            }

            // 4. News Sync - DISABLED AUTO FETCH
            // User must manually trigger news search to save bandwidth/quota
            // const cityQuery = `"${loc.name}" "${country.name.common}"`;
            // const countryQuery = `"${country.name.common}"`;
            // fetchGlobalNews(cityQuery, countryQuery);
        }

        let isFormVisible = false;

        async function toggleNoteForm(forceState) {
            const form = document.getElementById('noteFormArea');
            const btn = document.getElementById('btnNewNote');

            if (typeof forceState !== 'undefined') {
                isFormVisible = forceState;
            } else {
                isFormVisible = !isFormVisible;
            }

            if (isFormVisible) {
                form.style.display = 'block';
                btn.style.display = 'none';

                if (!document.getElementById('noteId').value) {
                    document.getElementById('noteTitle').value = '';
                    document.getElementById('noteDesc').value = '';
                    const newNoteTitle = await window.translator.translateText('New Note');
                    document.getElementById('formTitle').innerText = newNoteTitle;
                    document.getElementById('formTitle').setAttribute('data-i18n', 'NewNote');
                }
            } else {
                form.style.display = 'none';
                btn.style.display = 'block';
                document.getElementById('noteId').value = '';
            }
        }

        async function editNote(id) {
            const note = currentNotes.find(n => n.id === id);
            if (!note) return;

            document.getElementById('noteId').value = id;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteDesc').value = note.description;
            const editTitle = await window.translator.translateText('Edit Note');
            document.getElementById('formTitle').innerText = editTitle;
            document.getElementById('formTitle').setAttribute('data-i18n', 'EditNote');

            toggleNoteForm(true);
        }

        async function saveNote() {
            const title = document.getElementById('noteTitle').value;
            const desc = document.getElementById('noteDesc').value;
            const id = document.getElementById('noteId').value;

            if (!title || !desc) {
                alert(await window.translator.translateText('Please fill all fields'));
                return;
            }

            const url = id ? '/Notes/Update' : '/Notes/Create';
            const body = { title: title, description: desc };
            if (id) body.id = parseInt(id);

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    toggleNoteForm(false);
                    fetchNotes();
                } else {
                    const errSave = await window.translator.translateText('Error saving note');
                    alert(errSave);
                }
            } catch (e) {
                const errSave = await window.translator.translateText('Error saving note');
                alert(errSave);
            }
        }

        async function deleteNote(id) {
            const confirmText = await window.translator.translateText('Are you sure you want to delete this note?');
            if (!confirm(confirmText)) return;
            try {
                const res = await fetch('/Notes/Delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(id)
                });
                if (res.ok) fetchNotes();
            } catch (e) { console.error(e); }
        }

        $(document).ready(function () {
            // 1. Critical Base Systems (Clock, basic UI)
            if (typeof runChronos === 'function') {
                runChronos();
                setInterval(runChronos, 1000);
            } else {
                console.error("runChronos not defined!");
            }

            // 2. Data Initialization (Fail-safe wrapper)
            try { initNodeDirectory(); } catch (e) { console.error('NodeDir failed:', e); }
            try { initFiscal(); } catch (e) { console.error('Fiscal failed:', e); }
            try { initNotes(); } catch (e) { console.error('Notes failed:', e); }

            // Re-bind events to ensure interactivity persists
            const fC = document.getElementById('fromCurrency');
            const tC = document.getElementById('toCurrency');
            const aI = document.getElementById('amountInput');
            if (fC) fC.onchange = fetchLatestRates;
            if (tC) tC.onchange = convertCurrency;
            if (aI) aI.oninput = convertCurrency;
        });
        $(document).on('languageChanged', function (e, lang) {
            console.log('Dashboard detected language change:', lang);
            runChronos();
            renderNodes(allNodes);
            initFiscal(true); // Re-render dropdowns with new language labels, PRESERVING SELECTION
            // renderNews(); // Removed as it is not defined
            fetchNotes(); // Re-fetch notes (if we had server-side loc, but actually notes are user content)
        });

        // Refresh dynamic form elements on language change
        $(document).on('languageChanged', function (e, lang) {
            const isEdit = document.getElementById('noteId').value !== '';
            const titleKey = isEdit ? 'EditNote' : 'NewNote';
            if (isFormVisible) {
                document.getElementById('formTitle').innerText = window.i18n.t(titleKey);
            }
        });
    </script>
}
