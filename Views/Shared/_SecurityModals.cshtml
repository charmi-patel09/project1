@using Microsoft.AspNetCore.Http
<!-- Security PIN Modals -->
<div id="pinModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; align-items:center; justify-content:center;">
    <div class="pin-card" style="background:var(--bg-card); border:1px solid var(--border-primary); border-radius:24px; padding:40px; width:100%; max-width:400px; box-shadow:var(--shadow-2xl); text-align:center;">
        <div id="verifyPinMode" style="display:none;">
            <i class="fas fa-lock" style="font-size:3rem; color:var(--accent-warning); margin-bottom:20px;"></i>
            <h2 style="color:var(--text-bright); margin-bottom:10px;">Verification Required</h2>
            <p style="color:var(--text-muted); margin-bottom:30px;">Enter your PIN to access this module.</p>
            <div class="form-row" style="margin-bottom:25px;">
                <input type="password" id="verifyPinInput" class="modern-input" placeholder="••••••" maxlength="6" style="text-align:center; font-size:2rem; letter-spacing:10px;">
            </div>
            <button onclick="submitVerifyPin()" class="btn-primary" style="width:100%; padding:15px; border-radius:12px;">Unlock Module</button>
            <button onclick="closePinModal()" class="btn-icon" style="margin-top:20px; color:var(--text-muted); background:transparent;">Cancel Access</button>
        </div>
        <div id="pinErrorMessage" style="color:var(--accent-danger); margin-top:15px; font-size:0.9rem;"></div>
    </div>
</div>

<script>
    let pendingWidgetAction = null;
    let isPinVerified = sessionStorage.getItem('isPinVerified') === 'true';

    async function syncSecurityState() {
        try {
            const res = await fetch('/Security/CheckPinStatus');
            const data = await res.json();
            if (data.isVerified) {
                isPinVerified = true;
                sessionStorage.setItem('isPinVerified', 'true');
            } else if (isPinVerified && !data.isVerified) {
                isPinVerified = false;
                sessionStorage.removeItem('isPinVerified');
            }
            return data;
        } catch (e) { return { hasPin: false, isVerified: false }; }
    }

    function closePinModal() {
        document.getElementById('pinModal').style.display = 'none';
        pendingWidgetAction = null;
    }

    async function submitVerifyPin() {
        const pin = document.getElementById('verifyPinInput').value;
        const err = document.getElementById('pinErrorMessage');
        
        if (!pin) {
            err.innerText = "PIN is required";
            return;
        }

        const res = await fetch('/Security/VerifyPin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `pin=${pin}`
        });
        const data = await res.json();
        if (data.success) {
            isPinVerified = true;
            sessionStorage.setItem('isPinVerified', 'true');
            closePinModal();
            if (pendingWidgetAction) {
                if (typeof pendingWidgetAction === 'function') {
                    pendingWidgetAction();
                } else if (typeof window[pendingWidgetAction] === 'function') {
                    window[pendingWidgetAction]();
                }
            }
            if (window.location.pathname.includes('Dashboard')) {
                location.reload(); 
            }
        } else {
            err.innerText = data.message;
            document.getElementById('verifyPinInput').value = '';
        }
    }

    async function secureAccess(action) {
        const status = await syncSecurityState();
        if (isPinVerified) {
            if (typeof action === 'function') action();
            else if (typeof window[action] === 'function') window[action]();
            return;
        }
        document.getElementById('pinModal').style.display = 'flex';
        document.getElementById('pinErrorMessage').innerText = '';
        pendingWidgetAction = action;
        
        document.getElementById('verifyPinMode').style.display = 'block';
        document.getElementById('verifyPinInput').focus();
    }
</script>

<style>
    .pin-card input:focus {
        border-color: var(--accent-primary) !important;
        box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.2) !important;
    }
</style>
