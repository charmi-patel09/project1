@using Microsoft.AspNetCore.Http
@using JsonCrudApp.Models
@{
    ViewData["Title"] = "Dashboard";
    var userEmail = Context.Session.GetString("AdminUser");
    var totalStudents = ViewBag.TotalStudents ?? 0;
    var averageAge = ViewBag.AverageAge ?? 0;
    var recentStudents = (List<Student>)ViewBag.RecentStudents ?? new List<Student>();
}

<div class="dashboard-container p-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="welcome-banner p-4 rounded-4 shadow-sm text-white mb-4"
                style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
                <div class="d-flex align-items-center">
                    <div class="welcome-icon me-3 bg-white bg-opacity-25 rounded-circle p-3">
                        <i class="bi bi-speedometer2 fs-2"></i>
                    </div>
                    <div>
                        <h2 class="fw-bold mb-0">System Dashboard</h2>
                        <p class="mb-0 opacity-75">Welcome back, @(userEmail ?? "Administrator"). Here's what's
                            happening today.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="stat-card p-4 rounded-4 bg-white shadow-sm border-0 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="stat-icon bg-primary bg-opacity-10 text-primary rounded-3 p-2">
                        <i class="bi bi-people-fill fs-4"></i>
                    </div>
                    <span class="text-success small fw-bold"><i class="bi bi-arrow-up"></i> Active</span>
                </div>
                <h6 class="text-muted mb-1">Total Students</h6>
                <h2 class="fw-bold mb-0">@totalStudents</h2>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="stat-card p-4 rounded-4 bg-white shadow-sm border-0 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="stat-icon bg-info bg-opacity-10 text-info rounded-3 p-2">
                        <i class="bi bi-calendar-event fs-4"></i>
                    </div>
                </div>
                <h6 class="text-muted mb-1">Average Age</h6>
                <h2 class="fw-bold mb-0">@String.Format("{0:F1}", averageAge)</h2>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="stat-card p-4 rounded-4 bg-white shadow-sm border-0 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="stat-icon bg-warning bg-opacity-10 text-warning rounded-3 p-2">
                        <i class="bi bi-mortarboard-fill fs-4"></i>
                    </div>
                </div>
                <h6 class="text-muted mb-1">Active Courses</h6>
                <h2 class="fw-bold mb-0">@(((IEnumerable<dynamic>)ViewBag.CourseStats).Count())</h2>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="stat-card p-4 rounded-4 bg-white shadow-sm border-0 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="stat-icon bg-success bg-opacity-10 text-success rounded-3 p-2">
                        <i class="bi bi-shield-check fs-4"></i>
                    </div>
                </div>
                <h6 class="text-muted mb-1">System Status</h6>
                <h6 class="fw-bold text-success mb-0">Healthy</h6>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Recent Students Table -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 h-100 bg-white">
                <div class="card-header bg-transparent border-0 p-4 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Recently Added Students</h5>
                    <a asp-controller="Students" asp-action="Index" class="btn btn-sm btn-light rounded-pill px-3">View
                        All</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4 py-3 text-muted small fw-bold border-0">STUDENT</th>
                                    <th class="py-3 text-muted small fw-bold border-0">COURSE</th>
                                    <th class="py-3 text-muted small fw-bold border-0">AGE</th>
                                    <th class="py-3 text-muted small fw-bold border-0 pe-4">STATUS</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var student in recentStudents)
                                {
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar bg-primary bg-opacity-10 text-primary rounded-circle me-3 d-flex align-items-center justify-content-center"
                                                    style="width: 32px; height: 32px; font-size: 0.8rem;">
                                                    @(student.Name?.Substring(0, 1).ToUpper() ?? "S")
                                                </div>
                                                <div>
                                                    <div class="fw-bold">@student.Name</div>
                                                    <div class="text-muted extra-small">@student.Email</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td><span
                                                class="badge bg-light text-dark fw-normal rounded-pill px-3">@student.Course</span>
                                        </td>
                                        <td>@student.Age</td>
                                        <td class="pe-4"><span class="text-success small"><i class="bi bi-circle-fill me-1"
                                                    style="font-size: 0.5rem;"></i> Active</span></td>
                                    </tr>
                                }
                                @if (!recentStudents.Any())
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-5 text-muted small">No students found in the
                                            database.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Course Distribution -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 h-100 bg-white">
                <div class="card-header bg-transparent border-0 p-4">
                    <h5 class="fw-bold mb-0">Course Distribution</h5>
                </div>
                <div class="card-body p-4 pt-0">
                    <div class="course-list">
                        @foreach (var stat in ViewBag.CourseStats)
                        {
                            var percentage = totalStudents > 0 ? (stat.Count * 100 / totalStudents) : 0;
                            <div class="course-item mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold small">@stat.Course</span>
                                    <span class="text-muted extra-small">@stat.Count students</span>
                                </div>
                                <div class="progress rounded-pill" style="height: 6px;">
                                    <div class="progress-bar rounded-pill" role="progressbar"
                                        style="width: @percentage%; background: linear-gradient(90deg, #4e54c8, #8f94fb);">
                                    </div>
                                </div>
                            </div>
                        }
                        @if (!((IEnumerable<dynamic>)ViewBag.CourseStats).Any())
                        {
                            <div class="text-center py-5 text-muted small">No courses available.</div>
                        }
                    </div>

                    <div class="mt-4 p-4 rounded-4 bg-light border-0 d-flex align-items-center">
                        <div class="me-3 fs-3 text-primary"><i class="bi bi-lightning-charge-fill"></i></div>
                        <div>
                            <h6 class="fw-bold mb-1 small">Quick Actions</h6>
                            <a asp-controller="Students" asp-action="Create"
                                class="text-primary text-decoration-none small fw-bold">+ Add New Student</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        font-family: 'Inter', sans-serif;
    }

    .stat-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05) !important;
    }

    .extra-small {
        font-size: 0.75rem;
    }

    .progress-bar {
        transition: width 1s ease-in-out;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .avatar {
        font-weight: 700;
    }

    .welcome-banner {
        position: relative;
        overflow: hidden;
    }

    .welcome-banner::after {
        content: "";
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
    }
</style>
