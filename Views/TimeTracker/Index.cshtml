@model JsonCrudApp.ViewModels.TimeTrackerViewModel

@{
    ViewData["Title"] = "Time Tracker";
    var filter = Model.Filter.ToLower();
}

<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="page-header-container">
            <a href="javascript:history.back()" class="btn-back" title="Back" data-bs-toggle="tooltip"
                data-bs-placement="bottom">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h2 class="fw-bold mb-1 text-primary">Time Tracker</h2>
                <p class="text-secondary mb-0">Manage your productivity and time logs.</p>
            </div>
        </div>
        <button class="btn btn-primary" onclick="openAddModal()"
            style="background: var(--accent-primary); border: none;">
            <i class="fas fa-plus me-2"></i> Add Manual Entry
        </button>
    </div>

    <!-- Active Task Monitor -->
    <div id="pageActiveTaskContainer" class="card border-0 shadow-sm mb-4 bg-card"
        style="display:none; border-left: 5px solid var(--accent-warning) !important;">
        <div class="card-body p-4 d-flex justify-content-between align-items-center">
            <div>
                <h6 class="text-uppercase fw-bold mb-1" style="color: var(--accent-warning);">Current Session</h6>
                <h2 id="pageTaskName" class="fw-bold mb-0 text-primary">Task Name</h2>
            </div>
            <div class="text-end">
                <div id="pageTimerDisplay" class="display-4 fw-bold font-monospace text-primary">00:00:00</div>
                <div class="small text-secondary">Running...</div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <!-- Total Time Today -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100" style="background: var(--accent-primary); color: #ffffff;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 text-uppercase fw-bold mb-2">Today's Total</h6>
                            <h2 class="display-5 fw-bold mb-0">@Model.TotalTimeTracked.ToString(@"hh\:mm\:ss")</h2>
                        </div>
                        <div class="bg-white bg-opacity-25 rounded-circle p-3">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Breakdown -->
        <div class="col-md-8">
            <div class="card border-0 shadow-sm h-100 bg-card">
                <div class="card-header bg-card border-0 py-3">
                    <h6 class="mb-0 fw-bold text-primary"><i class="fas fa-chart-pie me-2 text-primary"
                            style="color: var(--accent-primary) !important;"></i>Today's Breakdown</h6>
                </div>
                <div class="card-body">
                    @if (Model.TaskBreakdown.Any())
                    {
                        <div class="d-flex flex-wrap gap-3">
                            @foreach (var task in Model.TaskBreakdown)
                            {
                                <div class="border rounded px-3 py-2 d-flex align-items-center"
                                    style="background: var(--bg-tertiary); border-color: var(--border-secondary) !important;">
                                    <span class="fw-bold me-2 text-primary">@task.Key</span>
                                    <span class="badge rounded-pill"
                                        style="background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-secondary);">@task.Value.ToString(@"hh\:mm\:ss")</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No tasks tracked today.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & List -->
    <div class="card border-0 shadow-sm bg-card">
        <div class="card-header bg-card border-bottom py-3" style="border-color: var(--border-secondary) !important;">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                <div class="btn-group" role="group">
                    <a href="@Url.Action("Index", new { filter = "today" })"
                        class="btn btn-sm btn-outline-secondary @(filter == "today" ? "active" : "")">Today</a>
                    <a href="@Url.Action("Index", new { filter = "yesterday" })"
                        class="btn btn-sm btn-outline-secondary @(filter == "yesterday" ? "active" : "")">Yesterday</a>
                    <a href="@Url.Action("Index", new { filter = "week" })"
                        class="btn btn-sm btn-outline-secondary @(filter == "week" ? "active" : "")">Last 7 Days</a>
                    <a href="@Url.Action("Index", new { filter = "all" })"
                        class="btn btn-sm btn-outline-secondary @(filter == "all" ? "active" : "")">All Time</a>
                </div>

                @if (filter == "custom")
                {
                    <span class="badge bg-info text-dark">Custom Range Active</span>
                }
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" style="color: var(--text-primary);">
                    <thead style="background: var(--bg-tertiary); color: var(--text-secondary);">
                        <tr>
                            <th class="ps-4">Task Name</th>
                            <th>Date</th>
                            <th>Time Range</th>
                            <th>Duration</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Entries.Any())
                        {
                            foreach (var item in Model.Entries)
                            {
                                <tr style="border-color: var(--border-secondary);">
                                    <td class="ps-4 fw-bold" style="color: var(--accent-primary);">@item.TaskName</td>
                                    <td>@item.StartTime.ToString("MMM dd, yyyy")</td>
                                    <td class="text-secondary small">
                                        @item.StartTime.ToString("hh:mm tt") -
                                        @(item.EndTime.HasValue ? item.EndTime.Value.ToString("hh:mm tt") : "Running...")
                                    </td>
                                    <td>
                                        @{
                                            var ts = TimeSpan.FromSeconds(item.DurationSeconds);
                                            <span class="badge"
                                                style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);">
                                                @ts.ToString(item.DurationSeconds >= 3600 ? @"hh\:mm\:ss" : @"mm\:ss")
                                            </span>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-link p-0 me-2" style="color: var(--accent-primary);"
                                            onclick="openEditModal(@item.Id, '@item.TaskName', '@item.StartTime.ToString("yyyy-MM-ddTHH:mm")', '@(item.EndTime.HasValue ? item.EndTime.Value.ToString("yyyy-MM-ddTHH:mm") : "")')">
                                            <i class="far fa-edit"></i>
                                        </button>
                                        <form asp-action="DeleteEntry" method="post"
                                            onsubmit="return confirm('Are you sure you want to delete this entry?');"
                                            style="display:inline;">
                                            <input type="hidden" name="id" value="@item.Id" />
                                            <button type="submit" class="btn btn-link text-danger p-0" title="Delete"
                                                style="color: var(--accent-danger) !important;">
                                                <i class="far fa-trash-alt"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center py-5">
                                    <div class="py-4">
                                        <div class="mb-3 text-muted opacity-25">
                                            <i class="fas fa-hourglass-start fa-4x"></i>
                                        </div>
                                        <h5 class="fw-bold text-muted">No time entries found</h5>
                                        <p class="text-secondary small">Start tracking time from the navbar or add a manual
                                            entry.</p>
                                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="openAddModal()">
                                            Add Manual Entry
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Entry Modal (Shared for Add/Edit) -->
<div class="modal fade" id="entryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="background: var(--bg-card); color: var(--text-primary);">
            <div class="modal-header text-white"
                style="background: var(--accent-primary); border-bottom: 1px solid var(--border-primary);">
                <h5 class="modal-title fw-bold" id="modalTitle"><i class="fas fa-clock me-2"></i>Add Manual Entry</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form id="entryForm" asp-action="AddManualEntry" method="post">
                <input type="hidden" name="Id" id="entryId" value="0">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Task Name</label>
                        <input type="text" name="TaskName" id="taskName" class="form-control" required
                            placeholder="e.g. Design Review"
                            style="background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-primary);">
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold">Start Time</label>
                            <input type="datetime-local" name="StartTime" id="startTime" class="form-control" required
                                style="background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-primary);">
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold">End Time</label>
                            <input type="datetime-local" name="EndTime" id="endTime" class="form-control"
                                style="background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-primary);">
                        </div>
                    </div>
                </div>
                <div class="modal-footer"
                    style="background: var(--bg-tertiary); border-top: 1px solid var(--border-primary);">
                    <button type="button" class="btn btn-link text-muted text-decoration-none"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4"
                        style="background: var(--accent-primary); border: none;">Save Entry</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openAddModal() {
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-clock me-2"></i>Add Manual Entry';
        document.getElementById('entryForm').action = '@Url.Action("AddManualEntry")';
        document.getElementById('entryId').value = 0;
        document.getElementById('taskName').value = '';

        // Default Start: Now, End: Now + 30m
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('startTime').value = now.toISOString().slice(0, 16);

        const end = new Date(now.getTime() + 30 * 60000);
        document.getElementById('endTime').value = end.toISOString().slice(0, 16);

        new bootstrap.Modal(document.getElementById('entryModal')).show();
    }

    function openEditModal(id, task, start, end) {
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Entry';
        document.getElementById('entryForm').action = '@Url.Action("UpdateEntry")';
        document.getElementById('entryId').value = id;
        document.getElementById('taskName').value = task;
        document.getElementById('startTime').value = start;
        document.getElementById('endTime').value = end;

        new bootstrap.Modal(document.getElementById('entryModal')).show();
    }
</script>
